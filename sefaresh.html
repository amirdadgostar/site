<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #3182ce;
            --primary-hover: #2c5282;
            --success: #38a169;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø±Ø§Ù¾ Ø´Ø¯Ù† Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            box-sizing: border-box;
            overflow-x: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ Ø§Ø¶Ø§ÙÙ‡ */
        }

        .container {
            background: var(--card-bg);
            width: 100%;
            max-width: 600px;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            margin-top: 20px;
            margin-bottom: 40px;
        }

        h1 {
            text-align: center;
            color: var(--text-main);
            font-size: 1.6rem;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.95rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box; /* Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
            background: #fff;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.15);
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ù„Ú©Øª ØªØ§Ø±ÛŒØ® */
        select option {
            padding: 10px;
        }

        .info-box {
            background: #ebf8ff;
            border-right: 4px solid #4299e1;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #2c5282;
            line-height: 1.6;
        }

        .price-box {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #9ae6b4;
            text-align: center;
            font-size: 1.3rem;
            color: #22543d;
            font-weight: 800;
            margin: 25px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            font-family: inherit;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(56, 161, 105, 0.2);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.8;
        }

        .btn:hover:not(:disabled) {
            background: #2f855a;
            transform: translateY(-2px);
        }

        .hidden { display: none !important; }

        .rules-box {
            background: #fffaf0;
            border: 1px solid #fbd38d;
            padding: 15px;
            font-size: 0.85rem;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #744210;
            max-height: 180px;
            overflow-y: auto;
            text-align: justify;
            line-height: 1.8;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú†Ú© Ø¨Ø§Ú©Ø³ */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        /* Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ† - Ù…Ø®ÙÛŒ Ø§Ø² Ø¯ÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ */
        #contract-preview {
            position: fixed; /* ØªØºÛŒÛŒØ± Ø¨Ù‡ fixed Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ */
            top: -10000px;
            left: -10000px;
            width: 800px; /* A4 width approx */
            height: 1130px; /* A4 height approx */
            background: white;
            padding: 50px;
            border: 1px solid #000;
            direction: rtl;
            font-family: 'Vazirmatn', sans-serif;
            color: #000;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ */
        .c-header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        .c-meta { display: flex; justify-content: space-between; font-size: 1rem; color: #333; margin-top: 15px; font-weight: bold; }
        .c-body { flex-grow: 1; position: relative; }
        .c-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1.1rem; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .highlight { font-weight: bold; }
        .c-footer { border-top: 3px solid #333; padding-top: 15px; font-size: 0.9rem; text-align: justify; line-height: 1.8; }
        .c-signature { margin-top: 40px; display: flex; justify-content: space-between; text-align: center; }
        .c-box { border: 2px solid #333; width: 40%; height: 100px; display: flex; flex-direction: column; justify-content: center; border-radius: 8px; }

        /* Ù„ÙˆØ¯Ø± */
        #loader { 
            text-align: center; 
            margin-top: 15px; 
            color: var(--primary); 
            font-weight: bold; 
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ */
        #generated-contract-img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
    </style>
</head>
<body>

<div class="container" id="step-form">
    <h1>Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª</h1>
    
    <div class="form-group">
        <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
        <input type="text" id="fullName" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    </div>

    <div class="form-group">
        <label>Ú©Ø¯ Ù…Ù„ÛŒ</label>
        <input type="number" id="nationalCode" placeholder="Û±Û° Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† Ø®Ø· ØªÛŒØ±Ù‡">
        <small id="nid-msg" style="color: #e53e3e; font-weight:bold; display:block; margin-top:5px;"></small>
    </div>

    <div class="form-group">
        <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù„Ù† Ø·Ø±Ø§Ø­ÛŒ</label>
        <select id="planType" onchange="calcTotal()">
            <option value="type1" data-price="1000000">Ø³Ø§ÛŒØª Ù…Ø¹Ø±ÙÛŒ Ø³Ø§Ø¯Ù‡ (Û±,Û°Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†)</option>
            <option value="type2" data-price="2000000">Ø³Ø§ÛŒØª Ù…ØªØµÙ„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ (Û²,Û°Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†)</option>
        </select>
        <div class="info-box">
            <span id="plan-desc">Ø³Ø§ÛŒØª Ù…Ø¹Ø±ÙÛŒ: Ù…ØªÙ†ØŒ ØªØµÙˆÛŒØ±ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ (Ø¨Ø¯ÙˆÙ† ÙØ±Ù… Ù¾ÛŒØ´Ø±ÙØªÙ‡)</span>
        </div>
    </div>

    <div class="form-group">
        <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨</label>
        <select id="templateName">
            <option value="Template-A">Ù‚Ø§Ù„Ø¨ Ø´Ø±Ú©ØªÛŒ Ù…Ø¯Ø±Ù†</option>
            <option value="Template-B">Ù‚Ø§Ù„Ø¨ Ø´Ø®ØµÛŒ/Ø±Ø²ÙˆÙ…Ù‡</option>
            <option value="Template-C">Ù‚Ø§Ù„Ø¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ (ÙˆÛŒØªØ±ÛŒÙ†)</option>
            <option value="Template-D">Ù‚Ø§Ù„Ø¨ Ø¢Ù…ÙˆØ²Ø´ÛŒ</option>
        </select>
    </div>

    <div class="form-group">
        <label>Ø¯Ø§Ù…Ù†Ù‡ Ø§Ø®ØªØµØ§ØµÛŒ (.ir)</label>
        <select id="domainRequest" onchange="calcTotal()">
            <option value="no" data-price="0">Ø®ÛŒØ± (Ø³Ø§Ø¨â€ŒØ¯Ø§Ù…ÛŒÙ† Ø±Ø§ÛŒÚ¯Ø§Ù† GitHub)</option>
            <option value="yes" data-price="100000">Ø¨Ù„Ù‡ (Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª: Û±Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†)</option>
        </select>
    </div>

    <div class="form-group">
        <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø·Ø±Ø§Ø­ÛŒ</label>
        <select id="startDate">
            <option value="" disabled selected>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§...</option>
        </select>
        <small style="color: #718096; font-size:0.8rem;">Ø¸Ø±ÙÛŒØª Ù‡Ø± Ø±ÙˆØ² Ù…Ø­Ø¯ÙˆØ¯ Ø§Ø³Øª.</small>
    </div>

    <div class="price-box">
        Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: <span id="displayTotal">Û±,Û°Û°Û°,Û°Û°Û°</span> ØªÙˆÙ…Ø§Ù†
    </div>

    <div class="rules-box">
        <strong>Ø´Ø±Ø§ÛŒØ· Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ†:</strong><br>
        Û±. Ø§ÛŒÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø· Ø§ÙˆÙ„ Ù…Ø¹ØªØ¨Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br>
        Û². Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø²Ø±Ùˆ ØªØ§Ø±ÛŒØ® ØªÙ†Ù‡Ø§ Û³ Ø±ÙˆØ² Ø§Ø³Øª.<br>
        Û³. Ø³Ø§ÛŒØª Ø·Ø¨Ù‚ Ù‚Ø§Ù„Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br>
        Û´. ØªØºÛŒÛŒØ±Ø§Øª Ú©Ù„ÛŒ Ø¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ù‚Ø§Ù„Ø¨ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª.
    </div>

    <div class="form-group checkbox-wrapper">
        <input type="checkbox" id="termsCheck">
        <label for="termsCheck" style="margin:0; font-weight:normal;">Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù….</label>
    </div>

    <button class="btn" id="submitBtn" onclick="submitOrder()" disabled>ØªØ£ÛŒÛŒØ¯ Ùˆ ØµØ¯ÙˆØ± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
    <div id="loader" class="hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¸Ø±ÙÛŒØª Ùˆ ØµØ¯ÙˆØ± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯...</div>
</div>

<div class="container hidden" id="step-success">
    <h2 style="color: #2f855a; text-align:center;">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØµØ§Ø¯Ø± Ø´Ø¯</h2>
    <p style="text-align:center;">Ù…Ù‡Ù„Øª Ø§Ø¹ØªØ¨Ø§Ø± ØªØ§: <strong id="showExpire" style="color: #c53030;"></strong></p>
    
    <div style="text-align: center;">
        <p>ØªØµÙˆÛŒØ± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø´Ù…Ø§:</p>
        <div id="contract-img-container"></div>
        <button class="btn" style="background: #3182ce; margin-top: 15px;" onclick="downloadContract()">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±</button>
    </div>

    <div style="background: #f0fff4; padding: 20px; border-radius: 12px; border: 1px dashed #48bb78; margin-top: 25px;">
        <p>Ù…Ø¨Ù„Øº Ú©Ù„: <strong id="finalAmount"></strong> ØªÙˆÙ…Ø§Ù†</p>
        <p style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª:<br>
            <strong style="font-size: 1.4rem; letter-spacing: 2px;">6063 7311 3256 0120</strong><br>
            Ø¨Ù‡ Ù†Ø§Ù… Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ø¯Ø§Ø¯Ú¯Ø³ØªØ±
        </p>
    </div>
</div>

<!-- Ù‚Ø§Ù„Ø¨ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³ -->
<div id="contract-preview">
    <div class="c-header">
        <h2>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø§Øª Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª</h2>
        <div class="c-meta">
            <span>Ø´Ù…Ø§Ø±Ù‡: <span id="c-orderId">---</span></span>
            <span>ØªØ§Ø±ÛŒØ®: <span id="c-date">---</span></span>
        </div>
    </div>
    
    <div class="c-body">
        <div style="margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:5px;"><strong>Ø·Ø±ÙÛŒÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯:</strong></div>
        <div class="c-row"><span>Ú©Ø§Ø±ÙØ±Ù…Ø§:</span> <span id="c-name" class="highlight"></span></div>
        <div class="c-row"><span>Ú©Ø¯ Ù…Ù„ÛŒ:</span> <span id="c-nid" class="highlight"></span></div>
        <div class="c-row"><span>Ù…Ø¬Ø±ÛŒ:</span> <span class="highlight">Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ø¯Ø§Ø¯Ú¯Ø³ØªØ±</span></div>

        <div style="margin:25px 0 10px; border-bottom:2px solid #eee; padding-bottom:5px;"><strong>Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:</strong></div>
        <div class="c-row"><span>Ù†ÙˆØ¹ Ù¾Ù„Ù†:</span> <span id="c-plan" class="highlight"></span></div>
        <div class="c-row"><span>Ù‚Ø§Ù„Ø¨:</span> <span id="c-template"></span></div>
        <div class="c-row"><span>Ø¯Ø§Ù…Ù†Ù‡:</span> <span id="c-domain"></span></div>
        <div class="c-row"><span>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</span> <span id="c-start"></span></div>

        <div style="margin:25px 0 10px; border-bottom:2px solid #eee; padding-bottom:5px;"><strong>Ù…Ø§Ù„ÛŒ:</strong></div>
        <div class="c-row">
            <span>Ù…Ø¨Ù„Øº Ú©Ù„:</span> 
            <span id="c-total" style="font-weight:bold; font-size: 1.2rem;"></span>
        </div>
        
        <div class="c-footer">
            <p>Ø§ÛŒÙ† Ø³Ù†Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø³ÛŒØ³ØªÙ…ÛŒ Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ø§Ø±Ø¨Ø± ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø¨Ù„Øº Ø¨Ù‡ Ù…Ù†Ø²Ù„Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø´Ø±ÙˆØ¹ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ØŒ Ø§ÛŒÙ† Ø³Ù†Ø¯ ÙØ§Ù‚Ø¯ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ø³Øª.</p>
        </div>

        <div class="c-signature">
            <div class="c-box">
                <span>Ø§Ù…Ø¶Ø§ÛŒ Ù…Ø¬Ø±ÛŒ</span>
                <span style="color: green; margin-top: 15px;">ØªØ§ÛŒÛŒØ¯ Ø³ÛŒØ³ØªÙ…ÛŒ</span>
            </div>
            <div class="c-box">
                <span>Ø§Ù…Ø¶Ø§ÛŒ Ú©Ø§Ø±ÙØ±Ù…Ø§</span>
                <span style="font-size: 0.8rem; margin-top: 15px;">ØªØ§ÛŒÛŒØ¯ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ IP</span>
            </div>
        </div>
    </div>
</div>

<script>
    // ************************************************************
    // Ø¢Ø¯Ø±Ø³ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyqZyluO1tdjBTYu3xexJDlJanFpUJBSQYiipKYrRRQt92a6L68gN8JlyM8DNrGLc0p/exec"; 
    // ************************************************************

    let contractImageDataUrl = "";
    let isNidValid = false;

    // ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
    function toPersianNum(num) {
        if(num === null || num === undefined) return "";
        return num.toString().replace(/\d/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);
    }

    // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ù‡ Ø±Ù‚Ù… Ø³Ù‡ Ø±Ù‚Ù… ÙØ§Ø±Ø³ÛŒ
    function formatMoney(amount) {
        return toPersianNum(amount.toLocaleString());
    }

    window.addEventListener('load', function() {
        fetchDates();
        calcTotal();
    });

    function updatePlanDesc() {
        const type = document.getElementById('planType').value;
        const txt = type === 'type1' ? "Ø³Ø§ÛŒØª Ù…Ø¹Ø±ÙÛŒ: Ù…ØªÙ†ØŒ ØªØµÙˆÛŒØ±ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ (Ø¨Ø¯ÙˆÙ† ÙØ±Ù…)" : "Ø³Ø§ÛŒØª Ù…ØªØµÙ„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„: ÙØ±Ù… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ØŒ Ø§ÛŒÙ…ÛŒÙ„ØŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª";
        document.getElementById('plan-desc').innerText = txt;
    }

    document.getElementById('planType').addEventListener('change', function() {
        updatePlanDesc();
        calcTotal();
    });

    function fetchDates() {
        const dateSelect = document.getElementById('startDate');
        
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "get_dates" })
        })
        .then(res => res.json())
        .then(data => {
            dateSelect.innerHTML = ''; 
            const defaultOpt = document.createElement('option');
            defaultOpt.text = "Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®...";
            defaultOpt.value = "";
            dateSelect.appendChild(defaultOpt);

            if (data.dates && data.dates.length > 0) {
                data.dates.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.date;
                    
                    // Ù…Ù†Ø·Ù‚ Ù†Ù…Ø§ÛŒØ´ Ø¸Ø±ÙÛŒØª (Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² undefined)
                    if (item.full) {
                        opt.text = `${toPersianNum(item.date)} (ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯)`;
                        opt.disabled = true;
                        opt.style.color = "#aaa";
                    } else {
                        // Ø§ÛŒÙ†Ø¬Ø§ Ø§Ú¯Ø± remaining ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ 0 Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒÚ¯ÛŒØ±Ø¯
                        let rem = item.remaining !== undefined ? item.remaining : 0;
                        opt.text = `${toPersianNum(item.date)} (Ø¸Ø±ÙÛŒØª: ${toPersianNum(rem)} Ù†ÙØ±)`;
                    }
                    dateSelect.appendChild(opt);
                });
            } else {
                dateSelect.innerHTML = '<option>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªÙ‚ÙˆÛŒÙ…</option>';
            }
        })
        .catch(err => {
            console.error(err);
            dateSelect.innerHTML = '<option>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</option>';
        });
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù…
    function validateForm() {
        const terms = document.getElementById('termsCheck').checked;
        const dateVal = document.getElementById('startDate').value;
        const nameVal = document.getElementById('fullName').value;
        
        const btn = document.getElementById('submitBtn');
        
        if (terms && isNidValid && dateVal && nameVal.trim().length > 0) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }

    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ
    ['termsCheck', 'startDate', 'fullName'].forEach(id => {
        document.getElementById(id).addEventListener('change', validateForm);
        document.getElementById(id).addEventListener('input', validateForm);
    });

    // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯ Ù…Ù„ÛŒ
    document.getElementById('nationalCode').addEventListener('input', function() {
        const val = this.value;
        const msg = document.getElementById('nid-msg');
        
        if (!/^\d{10}$/.test(val)) {
            msg.innerText = "Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Û±Û° Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯";
            isNidValid = false;
        } else {
            const check = parseInt(val[9]);
            const sum = val.split('').slice(0, 9).reduce((acc, x, i) => acc + parseInt(x) * (10 - i), 0) % 11;
            
            if ((sum < 2 && check === sum) || (sum >= 2 && check + sum === 11)) {
                msg.innerText = "";
                isNidValid = true;
            } else {
                msg.innerText = "Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª";
                isNidValid = false;
            }
        }
        validateForm();
    });

    function calcTotal() {
        const planSelect = document.getElementById('planType');
        const domainSelect = document.getElementById('domainRequest');
        
        const pPrice = parseInt(planSelect.options[planSelect.selectedIndex].dataset.price);
        const dPrice = parseInt(domainSelect.options[domainSelect.selectedIndex].dataset.price);
        
        const total = pPrice + dPrice;
        document.getElementById('displayTotal').innerText = formatMoney(total);
        return { total: total, pName: planSelect.options[planSelect.selectedIndex].text, dName: domainSelect.options[domainSelect.selectedIndex].text };
    }

    function submitOrder() {
        if(!isNidValid) return;

        const btn = document.getElementById('submitBtn');
        const loader = document.getElementById('loader');
        
        btn.classList.add('hidden');
        loader.classList.remove('hidden');

        const formData = {
            action: "submit_order",
            full_name: document.getElementById('fullName').value,
            national_code: document.getElementById('nationalCode').value,
            plan_type_key: document.getElementById('planType').value,
            template_name: document.getElementById('templateName').value,
            domain_request_key: document.getElementById('domainRequest').value,
            start_date: document.getElementById('startDate').value
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(formData)
        })
        .then(res => res.json())
        .then(resp => {
            if (resp.success) {
                // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯
                fillContract(resp, formData);
                
                // ØªÙˆÙ„ÛŒØ¯ Ø¹Ú©Ø³
                generateContractImage();

                document.getElementById('step-form').classList.add('hidden');
                document.getElementById('step-success').classList.remove('hidden');
                document.getElementById('showExpire').innerText = toPersianNum(resp.expireDate);
                document.getElementById('finalAmount').innerText = formatMoney(resp.totalPrice);
            } else {
                alert(resp.message); // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± (Ù…Ø«Ù„Ø§Ù‹ ØªÚ©Ù…ÛŒÙ„ Ø¸Ø±ÙÛŒØª)
                btn.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        })
        .catch(err => {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±");
            btn.classList.remove('hidden');
            loader.classList.add('hidden');
        });
    }

    function fillContract(serverData, formData) {
        document.getElementById('c-orderId').innerText = toPersianNum(serverData.orderId);
        
        const today = new Date().toLocaleDateString('fa-IR');
        document.getElementById('c-date').innerText = toPersianNum(today);
        
        document.getElementById('c-name').innerText = formData.full_name;
        document.getElementById('c-nid').innerText = toPersianNum(formData.national_code);
        
        // Ù†Ø§Ù… Ù¾Ù„Ù† Ùˆ Ø¯Ø§Ù…Ù†Ù‡ Ø±Ø§ Ø§Ø² ÙØ±Ø§Ù†Øª Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ø§Ù…Ø§ Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¢Ù…Ø¯Ù‡
        const prices = calcTotal();
        document.getElementById('c-plan').innerText = prices.pName;
        document.getElementById('c-template').innerText = formData.template_name;
        document.getElementById('c-domain').innerText = prices.dName;
        document.getElementById('c-start').innerText = toPersianNum(formData.start_date);
        
        document.getElementById('c-total').innerText = formatMoney(serverData.totalPrice) + " ØªÙˆÙ…Ø§Ù†";
    }

    function generateContractImage() {
        const element = document.getElementById('contract-preview');
        html2canvas(element, { scale: 2 }).then(canvas => {
            contractImageDataUrl = canvas.toDataURL("image/png");
            const img = document.createElement('img');
            img.src = contractImageDataUrl;
            img.id = "generated-contract-img";
            document.getElementById('contract-img-container').innerHTML = '';
            document.getElementById('contract-img-container').appendChild(img);
        });
    }

    function downloadContract() {
        if (!contractImageDataUrl) return;
        const link = document.createElement('a');
        link.download = 'Contract.png';
        link.href = contractImageDataUrl;
        link.click();
    }
</script>

</body>
</html>
