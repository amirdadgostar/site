<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª | ØªÙˆÙˆÙØ¨</title>
    <!-- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ ÙÙˆÙ†Øª -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background: #f3f4f6; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .contract-paper {
            background: #fff;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 40px;
            border: 1px solid #d1d5db;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .watermark {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4rem; font-weight: 900;
            color: rgba(220, 38, 38, 0.1);
            border: 5px solid rgba(220, 38, 38, 0.1);
            padding: 20px;
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Ù‡Ø¯Ø± -->
        <div class="bg-slate-800 text-white p-6 text-center">
            <h1 class="text-2xl font-bold">Ø³Ø§Ù…Ø§Ù†Ù‡ Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª</h1>
            <p class="text-slate-300 text-sm mt-2">Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ - Ù¾Ø°ÛŒØ±Ø´ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ</p>
        </div>

        <!-- Ø¨Ø¯Ù†Ù‡ ÙØ±Ù… -->
        <div class="p-6 md:p-8">
            
            <!-- Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
            <div id="loader" class="hidden flex flex-col items-center justify-center py-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</p>
            </div>

            <!-- Ù…Ø±Ø­Ù„Ù‡ 1: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± -->
            <div id="step-1" class="step-content active">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">1. Ù…Ø´Ø®ØµØ§Øª Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³</h3>
                <form id="form-step-1" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                            <input type="text" id="full_name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ú©Ø¯ Ù…Ù„ÛŒ</label>
                            <input type="number" id="national_code" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="10 Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† Ø®Ø· ØªÛŒØ±Ù‡" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù„Ù†</label>
                        <select id="plan_type" class="w-full p-3 border rounded-lg outline-none bg-white">
                            <option value="type1" data-price="1000000">Ø³Ø§ÛŒØª Ù…Ø¹Ø±ÙÛŒ Ø³Ø§Ø¯Ù‡ (Û±,Û°Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†)</option>
                            <option value="type2" data-price="2000000">Ø³Ø§ÛŒØª Ù…ØªØµÙ„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ (Û²,Û°Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù‚Ø§Ù„Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</label>
                        <select id="template_name" class="w-full p-3 border rounded-lg outline-none bg-white">
                            <option value="Techno">Ù‚Ø§Ù„Ø¨ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ (Techno)</option>
                            <option value="Minimal">Ù‚Ø§Ù„Ø¨ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„ (Minimal)</option>
                            <option value="Business">Ù‚Ø§Ù„Ø¨ Ø´Ø±Ú©ØªÛŒ (Business)</option>
                            <option value="Portfolio">Ù‚Ø§Ù„Ø¨ Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø± (Portfolio)</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border">
                        <input type="checkbox" id="domain_request" class="w-5 h-5 text-blue-600">
                        <label for="domain_request" class="text-sm text-gray-700 select-none">
                            Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø§Ù…Ù†Ù‡ Ø§Ø®ØªØµØ§ØµÛŒ Ø¯Ø§Ø±Ù… (+Û±Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†)
                        </label>
                    </div>

                    <button type="button" onclick="goToStep2()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯: Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ù…Ø§Ù†</button>
                </form>
            </div>

            <!-- Ù…Ø±Ø­Ù„Ù‡ 2: Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® -->
            <div id="step-2" class="step-content">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">2. Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ù¾Ø±ÙˆÚ˜Ù‡</h3>
                <p class="text-sm text-gray-500 mb-4">Ø¸Ø±ÙÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡ Ù…Ø­Ø¯ÙˆØ¯ Ø§Ø³Øª (Ø­Ø¯Ø§Ú©Ø«Ø± 3 Ø³ÙØ§Ø±Ø´). Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¸Ø±ÙÛŒØª Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯.</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ (YYYY/MM/DD)</label>
                        <!-- Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø² ØªÚ©Ø³Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ú©Ø§Ø±Ø¨Ø± ÙØ±Ù…Øª Ø¯Ù‚ÛŒÙ‚ Ø¨Ø²Ù†Ø¯ ÛŒØ§ Ø¯ÛŒØª Ù¾ÛŒÚ©Ø± Ø´Ù…Ø³ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ -->
                        <input type="text" id="start_date_input" class="w-full p-3 border rounded-lg ltr text-center" placeholder="Ù…Ø«Ø§Ù„: 1403/02/20">
                    </div>
                    
                    <button type="button" onclick="checkDateCapacity()" class="w-full bg-slate-600 hover:bg-slate-700 text-white py-2 rounded-lg">Ø¨Ø±Ø±Ø³ÛŒ Ø¸Ø±ÙÛŒØª</button>

                    <div id="capacity-msg" class="hidden p-3 rounded-lg text-sm text-center font-bold"></div>

                    <div id="step2-actions" class="hidden flex gap-3 mt-4">
                        <button type="button" onclick="goToStep(1)" class="w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                        <button type="button" onclick="goToStep3()" class="w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ Ùˆ ØªØ£ÛŒÛŒØ¯</button>
                    </div>
                </div>
            </div>

            <!-- Ù…Ø±Ø­Ù„Ù‡ 3: Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ø§Ù…Ø¶Ø§ -->
            <div id="step-3" class="step-content">
                <div id="contract-preview" class="contract-paper mb-6 text-right">
                    <div class="watermark">ÙØ§Ù‚Ø¯ Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† Ù¾Ø±Ø¯Ø§Ø®Øª</div>
                    
                    <div class="text-center mb-6 border-b-2 border-black pb-4">
                        <h2 class="text-xl font-black">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª</h2>
                        <span class="text-xs text-gray-500">Ø´Ù†Ø§Ø³Ù‡ Ø³ÙØ§Ø±Ø´: <span id="preview-order-id">---</span></span>
                    </div>

                    <div class="space-y-2 text-sm leading-7">
                        <p><strong>Ø·Ø±Ù Ø§ÙˆÙ„:</strong> <span id="preview-name"></span> (Ú©Ø¯ Ù…Ù„ÛŒ: <span id="preview-nid"></span>)</p>
                        <p><strong>Ø·Ø±Ù Ø¯ÙˆÙ…:</strong> Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ø¯Ø§Ø¯Ú¯Ø³ØªØ± (Ø·Ø±Ø§Ø­)</p>
                        <p><strong>Ù…ÙˆØ¶ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯:</strong> Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª Ù¾Ù„Ù† <span id="preview-plan"></span> Ø¨Ø§ Ù‚Ø§Ù„Ø¨ <span id="preview-template"></span></p>
                        <p><strong>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</strong> <span id="preview-date"></span></p>
                        <p><strong>Ù…Ø¨Ù„Øº Ú©Ù„:</strong> <span id="preview-price" class="font-bold text-lg"></span> ØªÙˆÙ…Ø§Ù†</p>
                        
                        <div class="bg-gray-100 p-2 rounded mt-2 text-xs">
                            <p>âš ï¸ Ø´Ø±Ø§ÛŒØ·:</p>
                            <ul class="list-disc pr-4">
                                <li>Ø§ÛŒÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙÙ‚Ø· 3 Ø±ÙˆØ² Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø§Ø±Ø¯.</li>
                                <li>Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ø¨Ù‡ Ù…Ù†Ø²Ù„Ù‡ Ø§Ù…Ø¶Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø§Ø³Øª.</li>
                                <li>ÙˆØ§Ø±ÛŒØ² ÙˆØ¬Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª 6063-7311-3256-0120 Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between items-end">
                        <div class="text-center">
                            <p class="font-bold text-sm">Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ Ø·Ø±Ø§Ø­</p>
                            <div class="text-gray-400 text-xs mt-1">Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ø³ÛŒØ³ØªÙ…</div>
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-sm">ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´ Ø¯Ù‡Ù†Ø¯Ù‡</p>
                            <div class="text-green-600 font-bold text-xs mt-1 border border-green-600 p-1 rounded">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ø³ÛŒØ³ØªÙ…ÛŒ</div>
                            <div id="preview-confirm-time" class="text-[10px] text-gray-500"></div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="terms-check" class="w-5 h-5 text-blue-600 rounded">
                        <span class="text-sm font-bold text-gray-800">ØªÙ…Ø§Ù… Ù…ÙØ§Ø¯ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù….</span>
                    </label>

                    <div class="flex gap-3">
                        <button type="button" onclick="goToStep(2)" class="w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                        <button type="button" onclick="submitFinalOrder()" class="w-2/3 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg shadow-green-200">ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø«Ø¨Øª</button>
                    </div>
                </div>
            </div>

            <!-- Ù…Ø±Ø­Ù„Ù‡ 4: Ø¯Ø§Ù†Ù„ÙˆØ¯ -->
            <div id="step-4" class="step-content text-center">
                <div class="bg-green-50 text-green-800 p-6 rounded-xl border border-green-200 mb-6">
                    <div class="text-4xl mb-2">ğŸ‰</div>
                    <h3 class="text-xl font-bold">Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯</h3>
                    <p class="mt-2 text-sm">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø´Ù…Ø§ ØªØ§ ØªØ§Ø±ÛŒØ® <span id="final-expire-date" class="font-bold"></span> Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.</p>
                </div>

                <p class="text-gray-600 mb-4 text-sm">Ù„Ø·ÙØ§Ù‹ ØªØµÙˆÛŒØ± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¯Ø± Ø§ÛŒØªØ§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</p>

                <div id="download-area" class="border p-2 rounded bg-gray-50 mb-4 overflow-hidden relative">
                    <!-- Ù…Ø­Ù„ Ù‚Ø±Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¹Ú©Ø³ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ -->
                </div>

                <button onclick="downloadContractImage()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg mb-2">
                    <i class="fas fa-download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯
                </button>
                
                <a href="eitaa://user?id=YOUR_EITAA_ID" class="block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg">
                    Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§ÛŒØªØ§
                </a>
            </div>

        </div>
    </div>

    <script>
        // ******* Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ *******
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVkozAAKm-QZqLt14u3irfG-ojLUvcRjt5CTv0n4HVy1tIXb-R86F-xJu8W_V7WV2W/exec';
        
        let orderData = {};

        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ù…Ù„ÛŒ
        function isValidIranianNationalCode(input) {
            if (!/^\d{10}$/.test(input)) return false;
            const check = +input[9];
            const sum = input.split('').slice(0, 9).reduce((acc, x, i) => acc + +x * (10 - i), 0) % 11;
            return sum < 2 ? check === sum : check === 11 - sum;
        }

        // Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¨ÛŒÙ† Ù…Ø±Ø§Ø­Ù„
        function goToStep(stepNumber) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${stepNumber}`).classList.add('active');
        }

        function goToStep2() {
            const name = document.getElementById('full_name').value;
            const nid = document.getElementById('national_code').value;
            
            if (!name) return Swal.fire('Ø®Ø·Ø§', 'Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');
            if (!isValidIranianNationalCode(nid)) return Swal.fire('Ø®Ø·Ø§', 'Ú©Ø¯ Ù…Ù„ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');

            const planSelect = document.getElementById('plan_type');
            const planPrice = parseInt(planSelect.options[planSelect.selectedIndex].dataset.price);
            const domainPrice = document.getElementById('domain_request').checked ? 100000 : 0;

            orderData = {
                full_name: name,
                national_code: nid,
                plan_type: planSelect.options[planSelect.selectedIndex].text,
                plan_price: planPrice,
                template_name: document.getElementById('template_name').value,
                domain_request: document.getElementById('domain_request').checked,
                domain_price: domainPrice,
                total_price: planPrice + domainPrice
            };

            goToStep(2);
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ø¸Ø±ÙÛŒØª (Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª)
        async function checkDateCapacity() {
            const date = document.getElementById('start_date_input').value;
            if (!date) return Swal.fire('ØªÙˆØ¬Ù‡', 'Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'warning');

            // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯Ø±
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('step-2').classList.add('opacity-50');
            
            try {
                // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø±ÙˆØ´ text/plain Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² CORS
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'check_capacity', date: date })
                });
                
                const result = await response.json();
                
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('step-2').classList.remove('opacity-50');

                const msgBox = document.getElementById('capacity-msg');
                msgBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

                if (result.is_full) {
                    msgBox.textContent = 'Ø¸Ø±ÙÛŒØª Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.';
                    msgBox.classList.add('bg-red-100', 'text-red-700');
                    document.getElementById('step2-actions').classList.add('hidden');
                } else {
                    msgBox.textContent = `Ø¸Ø±ÙÛŒØª Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª (${result.remaining} Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ).`;
                    msgBox.classList.add('bg-green-100', 'text-green-700');
                    document.getElementById('step2-actions').classList.remove('hidden');
                    orderData.start_date = date;
                }

            } catch (error) {
                console.error(error);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('step-2').classList.remove('opacity-50');
                Swal.fire('Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„', 'Ù„Ø·ÙØ§ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø±Ø§ Ø®Ø§Ù…ÙˆØ´/Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯.', 'error');
            }
        }

        function goToStep3() {
            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            document.getElementById('preview-name').textContent = orderData.full_name;
            document.getElementById('preview-nid').textContent = orderData.national_code;
            document.getElementById('preview-plan').textContent = orderData.plan_type;
            document.getElementById('preview-template').textContent = orderData.template_name;
            document.getElementById('preview-date').textContent = orderData.start_date;
            document.getElementById('preview-price').textContent = orderData.total_price.toLocaleString();
            
            // ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆÙ‚Øª Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ (Ø´Ù†Ø§Ø³Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒØ´Ù‡)
            const tempId = orderData.national_code + new Date().getHours() + new Date().getMinutes();
            document.getElementById('preview-order-id').textContent = "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯...";
            
            goToStep(3);
        }

        async function submitFinalOrder() {
            if (!document.getElementById('terms-check').checked) {
                return Swal.fire('Ø®Ø·Ø§', 'Ù„Ø·ÙØ§ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ùˆ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.', 'warning');
            }

            document.getElementById('preview-confirm-time').textContent = new Date().toLocaleString('fa-IR');
            
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('step-3').classList.add('opacity-50');

            try {
                const payload = {
                    action: 'submit_order',
                    ...orderData
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ Ø±ÙˆÛŒ UI Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ†
                    document.getElementById('preview-order-id').textContent = result.order_id;
                    document.getElementById('final-expire-date').textContent = result.expire_date;
                    
                    // ØªÙˆÙ„ÛŒØ¯ Ø¹Ú©Ø³ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯
                    await generateContractImage();

                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('step-3').classList.remove('opacity-50');
                    goToStep(4);
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('step-3').classList.remove('opacity-50');
                Swal.fire('Ø®Ø·Ø§', error.message || 'Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´ Ø¢Ù…Ø¯', 'error');
            }
        }

        async function generateContractImage() {
            const element = document.getElementById('contract-preview');
            // ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Ú©ÛŒÙÛŒØª Ø¨Ù‡ØªØ±
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            
            const imgTag = document.createElement('img');
            imgTag.src = imgData;
            imgTag.className = "w-full h-auto shadow-md";
            imgTag.id = "generated-contract-img";
            
            const container = document.getElementById('download-area');
            container.innerHTML = '';
            container.appendChild(imgTag);
        }

        function downloadContractImage() {
            const img = document.getElementById('generated-contract-img');
            if(img) {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `Contract-${orderData.national_code}.png`;
                link.click();
            }
        }
    </script>
</body>
</html>
