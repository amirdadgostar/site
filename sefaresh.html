 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุณุงูุงูู ูุฑุงุฑุฏุงุฏ ุทุฑุงุญ ุณุงุช | ุงูุฑุญุณู ุฏุงุฏฺฏุณุชุฑ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f3f4f6; }
        .contract-paper { 
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png'); 
            background-color: #fff;
        }
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4rem; color: rgba(255, 0, 0, 0.1); font-weight: bold; border: 5px solid rgba(255, 0, 0, 0.1);
            padding: 20px; z-index: 0; pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen pb-10">

    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-lg">
        <div class="container mx-auto text-center">
            <h1 class="text-xl font-bold">ุณุงูุงูู ุซุจุช ูุฑุงุฑุฏุงุฏ ุทุฑุงุญ ุณุงุช</h1>
            <p class="text-sm opacity-80">ุชูุณุนู ุฏููุฏู: ุงูุฑุญุณู ุฏุงุฏฺฏุณุชุฑ</p>
        </div>
    </header>

    <!-- Main Container -->
    <main class="container mx-auto p-4 max-w-2xl mt-6" id="app">
        
        <!-- STEP 1: FORM -->
        <div id="step-form" class="bg-white p-6 rounded-xl shadow-md space-y-4">
            <h2 class="text-lg font-bold border-b pb-2 text-blue-800">1. ูุดุฎุตุงุช ู ุงูุชุฎุงุจ ุณุฑูุณ</h2>
            
            <div>
                <label class="block text-sm text-gray-700">ูุงู ู ูุงู ุฎุงููุงุฏฺฏ</label>
                <input type="text" id="fullName" class="w-full border p-2 rounded mt-1 focus:ring-2 focus:ring-blue-500" placeholder="ูุซุงู: ุนู ูุญูุฏ">
            </div>

            <div>
                <label class="block text-sm text-gray-700">ฺฉุฏ ูู</label>
                <input type="number" id="nationalCode" class="w-full border p-2 rounded mt-1" placeholder="ฺฉุฏ ูู 10 ุฑูู">
                <p id="nc-error" class="text-red-500 text-xs mt-1 hidden">ฺฉุฏ ูู ูุงูุนุชุจุฑ ุงุณุช</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-700">ุงูุชุฎุงุจ ูพูู</label>
                    <select id="planType" class="w-full border p-2 rounded mt-1" onchange="calculatePrice()">
                        <option value="basic" data-price="1000000">ุณุงุช ูุนุฑู ุณุงุฏู (1 ูููู ุชููุงู)</option>
                        <option value="google" data-price="2000000">ูุชุตู ุจู ฺฏูฺฏู ุดุช (2 ูููู ุชููุงู)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-700">ูุงู ูุงูุจ ุงูุชุฎุงุจ</label>
                    <select id="templateName" class="w-full border p-2 rounded mt-1">
                        <option value="ToWeb-Minimal">ูุงูุจ ูููุงู (ToWeb-Minimal)</option>
                        <option value="ToWeb-Corporate">ูุงูุจ ุดุฑฺฉุช (ToWeb-Corporate)</option>
                        <option value="ToWeb-Personal">ูุงูุจ ุดุฎุต (ToWeb-Personal)</option>
                    </select>
                </div>
            </div>

            <div class="bg-blue-50 p-3 rounded border border-blue-100">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="domainRequest" class="w-5 h-5" onchange="calculatePrice()">
                    <span class="text-sm">ุฏุฑุฎูุงุณุช ุฎุฑุฏ ุฏุงููู IR ู ุงุชุตุงู (100,000 ุชููุงู)</span>
                </label>
            </div>

            <div>
                <label class="block text-sm text-gray-700">ุชุงุฑุฎ ุดุฑูุน ุทุฑุงุญ</label>
                <input type="date" id="startDate" class="w-full border p-2 rounded mt-1">
                <p class="text-xs text-gray-500 mt-1">ุธุฑูุช ุฑูุฒุงูู ูุญุฏูุฏ ุงุณุช (3 ุณูุงุฑุด).</p>
            </div>

            <div class="text-center bg-gray-100 p-3 rounded-lg">
                <p class="text-sm text-gray-600">ูุจูุบ ูุงุจู ูพุฑุฏุงุฎุช:</p>
                <p class="text-2xl font-bold text-blue-800" id="displayPrice">1,000,000 ุชููุงู</p>
            </div>

            <button onclick="goToContract()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                ูุฑุญูู ุจุนุฏ: ูุดุงูุฏู ูุฑุงุฑุฏุงุฏ
            </button>
        </div>

        <!-- STEP 2: CONTRACT PREVIEW -->
        <div id="step-contract" class="hidden">
            <div id="contract-capture" class="contract-paper p-8 shadow-2xl relative text-sm leading-7 text-justify text-gray-900 border border-gray-300">
                
                <div class="watermark">ูุงูุฏ ุงุนุชุจุงุฑ ุจุฏูู ูพุฑุฏุงุฎุช</div>

                <!-- Contract Header -->
                <div class="text-center border-b-2 border-black pb-4 mb-4">
                    <h2 class="text-2xl font-bold">ูุฑุงุฑุฏุงุฏ ุทุฑุงุญ ูุจโุณุงุช</h2>
                    <p class="text-sm mt-1">ุดูุงุฑู ุณูุงุฑุด: <span id="c-orderId">---</span> | ุชุงุฑุฎ: <span id="c-date">---</span></p>
                </div>

                <!-- Contract Body -->
                <p>ุงู ูุฑุงุฑุฏุงุฏ ูโูุงุจู <strong>ุงูุฑุญุณู ุฏุงุฏฺฏุณุชุฑ</strong> (ุทุฑุงุญ) ู <strong><span id="c-name">---</span></strong> ุจู ฺฉุฏ ูู <strong><span id="c-nc">---</span></strong> (ุณูุงุฑุดโุฏููุฏู) ููุนูุฏ ูโฺฏุฑุฏุฏ.</p>

                <h3 class="font-bold mt-4">ููุถูุน ูุฑุงุฑุฏุงุฏ:</h3>
                <p>ุทุฑุงุญ ูุจโุณุงุช ุจุง ูุดุฎุตุงุช ุฒุฑ:</p>
                <ul class="list-disc list-inside bg-gray-50 p-2 rounded border">
                    <li>ููุน ูพูู: <span id="c-plan">---</span></li>
                    <li>ูุงูุจ ุงูุชุฎุงุจ: <span id="c-template">---</span></li>
                    <li>ูุถุนุช ุฏุงููู: <span id="c-domain">---</span></li>
                    <li>ุชุงุฑุฎ ุดุฑูุน ูพุฑูฺู: <span id="c-startDate">---</span></li>
                    <li>ุฒูุงู ุชุญูู: ุญุฏุงฺฉุซุฑ 20 ุฑูุฒ ฺฉุงุฑ ูพุณ ุงุฒ ุดุฑูุน</li>
                </ul>

                <h3 class="font-bold mt-4">ูุจูุบ ู ูุญูู ูพุฑุฏุงุฎุช:</h3>
                <p>ูุจูุบ ฺฉู ูุฑุงุฑุฏุงุฏ: <strong><span id="c-total">---</span> ุชููุงู</strong> ูโุจุงุดุฏ.</p>
                <p>ูพุฑุฏุงุฎุช ุจู ุตูุฑุช ฺฉุงูู ุง ุฏู ูุณุท (50% ุดุฑูุนุ 50% ุชุญูู) ุจู ุดูุงุฑู ฺฉุงุฑุช <strong>6063-7311-3256-0120</strong> ุงูุฌุงู ูโุดูุฏ.</p>

                <h3 class="font-bold mt-4">ุดุฑุงุท ู ููุงูู:</h3>
                <ol class="list-decimal list-inside text-xs space-y-1">
                    <li>ฺฉูฺฉ ุฑู ุฏฺฉูู ุชุฃุฏ ุชูุณุท ุณูุงุฑุดโุฏููุฏูุ ุฌุงฺฏุฒู ุงูุถุง ุฏุณุช ู ุจูโููุฒูู ูุจูู ููุงุฏ ูุฑุงุฑุฏุงุฏ ุงุณุช.</li>
                    <li>ุงู ูุฑุงุฑุฏุงุฏ ูพุณ ุงุฒ ุชุฃุฏ ฺฉุงุฑุจุฑุ 3 ุฑูุฒ ุงุนุชุจุงุฑ ุฏุงุฑุฏ ู ุฏุฑ ุตูุฑุช ุนุฏู ูุงุฑุฒ ุญุฏุงูู ูุณุท ุงููุ ุจุงุทู ูโุดูุฏ.</li>
                    <li>ุงุฑุณุงู ูุด ู ุชุตูุฑ ูุฑุงุฑุฏุงุฏ ุตุฑูุงู ุงุนูุงู ูพุฑุฏุงุฎุช ุงุณุช ู ูุจูู ููุง ุจุง ุชุฃุฏ ุทุฑุงุญ ุงุณุช.</li>
                    <li>ุชุบุฑุงุช ุฎุงุฑุฌ ุงุฒ ูุงูุจ ู ุฏุงููู ุงูุชุฎุงุจ ุดุงูู ูุฒูู ุฌุฏุงฺฏุงูู ุงุณุช.</li>
                    <li>ุณุงุช ุฑู GitHub Pages ูุฒุจุงู ูโุดูุฏ. ูุณุฆููุช ุชูุฏุฏ ุฏุงููู ุดุฎุต ุจุง ุฎุฑุฏุงุฑ ุงุณุช.</li>
                </ol>

                <div class="flex justify-between mt-8 pt-4 border-t border-black">
                    <div class="text-center">
                        <p class="font-bold">ุงูุถุง ุทุฑุงุญ</p>
                        <p class="text-gray-500 text-xs">ุชุฃุฏ ุณุณุชู</p>
                        <p>ุงูุฑุญุณู ุฏุงุฏฺฏุณุชุฑ</p>
                    </div>
                    <div class="text-center">
                        <p class="font-bold">ุชุฃุฏ ุณูุงุฑุดโุฏููุฏู</p>
                        <p class="text-green-600 font-bold text-lg">โ ุชุฃุฏ ู ูพุฐุฑุด ุดุฏ</p>
                        <p id="c-confirmTime" class="text-xs text-gray-500"></p>
                    </div>
                </div>
                
                <p class="text-center text-xs text-red-600 mt-4 border border-red-200 bg-red-50 p-1">
                    ุงุนุชุจุงุฑ ุงู ูพุดโูุงฺฉุชูุฑ ุชุง ุชุงุฑุฎ <span id="c-expire">---</span> ูโุจุงุดุฏ.
                </p>
            </div>

            <!-- Controls -->
            <div class="bg-white p-4 mt-4 rounded shadow space-y-3">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="termsCheck" class="w-5 h-5 accent-blue-600">
                    <span class="text-sm font-bold">ูุชู ูุฑุงุฑุฏุงุฏ ุฑุง ูุทุงูุนู ฺฉุฑุฏู ู ุชูุงู ููุงุฏ ุขู ุฑุง ูโูพุฐุฑู.</span>
                </label>
                
                <button id="btn-submit" onclick="submitOrder()" disabled class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    ุชุฃุฏ ููุง ู ุงุฌุงุฏ ูุฑุงุฑุฏุงุฏ
                </button>
                
                <button onclick="document.getElementById('step-contract').classList.add('hidden'); document.getElementById('step-form').classList.remove('hidden');" class="w-full bg-gray-300 text-gray-700 py-2 rounded text-sm">
                    ุจุงุฒฺฏุดุช ู ุงุตูุงุญ
                </button>
            </div>
        </div>

        <!-- STEP 3: FINAL -->
        <div id="step-final" class="hidden text-center bg-white p-8 rounded-xl shadow-lg">
            <div class="bg-green-100 text-green-800 p-4 rounded-full w-20 h-20 mx-auto flex items-center justify-center text-4xl mb-4">โ</div>
            <h2 class="text-xl font-bold text-gray-800">ุณูุงุฑุด ุจุง ููููุช ุซุจุช ุดุฏ</h2>
            <p class="text-gray-600 mt-2 text-sm">ูุฑุงุฑุฏุงุฏ ุดูุง ุงุฌุงุฏ ุดุฏ. ูุทูุงู ุชุตูุฑ ุฒุฑ ุฑุง ุฏุงูููุฏ ฺฉูุฏ.</p>

            <div class="my-6 border-2 border-dashed border-blue-200 p-4 rounded bg-blue-50">
                <p class="text-sm font-bold text-blue-900 mb-2">ุดูุงุฑู ฺฉุงุฑุช ุฌูุช ูุงุฑุฒ:</p>
                <p class="text-xl font-mono dir-ltr select-all">6063 7311 3256 0120</p>
                <p class="text-xs text-gray-500 mt-1">ุจู ูุงู ุงูุฑุญุณู ุฏุงุฏฺฏุณุชุฑ</p>
            </div>

            <button id="dl-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mb-4 shadow-lg animate-pulse">
                ๐ฅ ุฏุงูููุฏ ุชุตูุฑ ูุฑุงุฑุฏุงุฏ
            </button>

            <p class="text-xs text-gray-500 text-justify bg-yellow-50 p-2 rounded border border-yellow-200">
                <strong>ุชูุฌู:</strong> ุชุตูุฑ ูุฑุงุฑุฏุงุฏ ุฏุงูููุฏ ุดุฏู ุฑุง ุจู ููุฑุงู ูุด ูุงุฑุฒ (ุญุฏุงูู 50% ูุจูุบ) ุฏุฑ ูพุงูโุฑุณุงู ุงุชุง ุงุฑุณุงู ฺฉูุฏ ุชุง ุณูุงุฑุด ุดูุง ููุง ุดูุฏ.
            </p>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white p-5 rounded-lg flex items-center gap-3">
                <div class="w-6 h-6 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                <span>ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด...</span>
            </div>
        </div>

    </main>

    <script>
        // ๐ด๐ด ุขุฏุฑุณ ุงุณฺฉุฑูพุช ฺฏูฺฏู ุฎูุฏ ุฑุง ุงูุฌุง ุจฺฏุฐุงุฑุฏ ๐ด๐ด
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyo8vFxQ1egbs-FTf17PQEhJygLXjyGFyvftoa8scuYAbgUtPKk5uSuIU1Wx41ObGGAiA/exec"; 

        // Utility: Validation Code Melli
        function isValidIranianNationalCode(input) {
            if (!/^\d{10}$/.test(input)) return false;
            const check = +input[9];
            const sum = input.split('').slice(0, 9).reduce((acc, x, i) => acc + +x * (10 - i), 0) % 11;
            return sum < 2 ? check === sum : check + sum === 11;
        }

        function calculatePrice() {
            const planPrice = parseInt(document.querySelector('#planType option:checked').dataset.price);
            const domainPrice = document.getElementById('domainRequest').checked ? 100000 : 0;
            const total = planPrice + domainPrice;
            document.getElementById('displayPrice').innerText = total.toLocaleString() + " ุชููุงู";
            return total;
        }

        // Logic
        async function goToContract() {
            const name = document.getElementById('fullName').value;
            const nc = document.getElementById('nationalCode').value;
            const date = document.getElementById('startDate').value;

            // Validations
            if(name.length < 3) return alert("ูุงู ฺฉุงูู ุฑุง ูุงุฑุฏ ฺฉูุฏ");
            if(!isValidIranianNationalCode(nc)) {
                document.getElementById('nc-error').classList.remove('hidden');
                return alert("ฺฉุฏ ูู ูุงูุนุชุจุฑ ุงุณุช");
            } else {
                document.getElementById('nc-error').classList.add('hidden');
            }
            if(!date) return alert("ุชุงุฑุฎ ุดุฑูุน ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ");

            // Fill Preview
            document.getElementById('c-name').innerText = name;
            document.getElementById('c-nc').innerText = nc;
            document.getElementById('c-plan').innerText = document.querySelector('#planType option:checked').text;
            document.getElementById('c-template').innerText = document.getElementById('templateName').value;
            document.getElementById('c-domain').innerText = document.getElementById('domainRequest').checked ? "ููุฑุงู ุจุง ุฎุฑุฏ ุฏุงููู IR" : "ุงุณุชูุงุฏู ุงุฒ ุฏุงููู ุฑุงฺฏุงู";
            document.getElementById('c-startDate').innerText = date;
            document.getElementById('c-total').innerText = calculatePrice().toLocaleString();
            
            // Set Temp Dates
            const now = new Date();
            document.getElementById('c-date').innerText = now.toLocaleDateString('fa-IR');
            document.getElementById('c-confirmTime').innerText = now.toLocaleString('fa-IR');
            
            // Generate Temp Order ID for preview
            document.getElementById('c-orderId').innerText = nc + now.getHours() + now.getMinutes(); // ูููุช ุจุฑุง ููุงุด

            // Switch View
            document.getElementById('step-form').classList.add('hidden');
            document.getElementById('step-contract').classList.remove('hidden');
        }

        // Handle Checkbox
        document.getElementById('termsCheck').addEventListener('change', function(e) {
            document.getElementById('btn-submit').disabled = !e.target.checked;
        });

        // Submit to Google Sheets
        function submitOrder() {
            document.getElementById('loading').classList.remove('hidden');
            
            const payload = {
                action: "createOrder",
                full_name: document.getElementById('fullName').value,
                national_code: document.getElementById('nationalCode').value,
                plan_type: document.querySelector('#planType option:checked').text,
                plan_price: parseInt(document.querySelector('#planType option:checked').dataset.price),
                template_name: document.getElementById('templateName').value,
                domain_request: document.getElementById('domainRequest').checked ? "ุจูู" : "ุฎุฑ",
                domain_price: document.getElementById('domainRequest').checked ? 100000 : 0,
                total_price: calculatePrice(),
                start_date: document.getElementById('startDate').value
            };

            fetch(WEB_APP_URL, {
                redirect: "follow", // ุงุถุงูู ุดุฏู ุจุฑุง ุฑูุน ูุดฺฉู
                method: "POST",
                body: JSON.stringify(payload),
                headers: {
                    "Content-Type": "text/plain;charset=utf-8", // ุงุถุงูู ุดุฏู ุจุฑุง ุฑูุน ูุดฺฉู CORS
                },
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                if(data.status === "success") {
                    // Update Final Details
                    document.getElementById('c-orderId').innerText = data.order_id; // ุดูุงุณู ูุงูุน ุงุฒ ุณุฑูุฑ
                    document.getElementById('c-expire').innerText = data.expire_at;
                    
                    // Show Final Step
                    document.getElementById('step-contract').classList.add('hidden');
                    document.getElementById('step-final').classList.remove('hidden');

                    // Setup Download
                    setupDownload(data.order_id);
                } else {
                    alert("ุฎุทุง: " + data.message);
                }
            })
            .catch(err => {
                document.getElementById('loading').classList.add('hidden');
                alert("ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ");
                console.error(err);
            });
        }

        function setupDownload(fileName) {
            const element = document.getElementById("contract-capture");
            // ุจุงุฏ ุนูุตุฑ ุฑุง ูููุชุง ููุงุด ุฏูู ุชุง ุนฺฉุณ ฺฏุฑูุชู ุดูุฏ (ุงูุง ฺฉุงุฑุจุฑ ูุจุงุฏ ุจุจูุฏ)
            // ุฏุฑ ุงูุฌุง ฺูู ุงุฒ flow ุฎุงุฑุฌ ุดุฏูุ ุขู ุฑุง ุจู step-final ููุชูู ูฺฉูู ุงูุง ูุฎู
            document.getElementById('step-final').appendChild(element);
            element.style.position = "absolute";
            element.style.left = "-9999px";
            element.style.width = "800px"; // ุนุฑุถ ุซุงุจุช ุจุฑุง ฺฉูุช ุจูุชุฑ

            document.getElementById('dl-btn').onclick = function() {
                element.style.left = "0"; // ูููุชุง ูุงุจู ุฏุฏู ุจุฑุง ุงุณฺฉุฑูพุช
                html2canvas(element, {scale: 2}).then(canvas => {
                    element.style.left = "-9999px"; // ูุฎู ฺฉุฑุฏู ูุฌุฏุฏ
                    const link = document.createElement('a');
                    link.download = `Contract-${fileName}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };
        }
    </script>
</body>
</html>
