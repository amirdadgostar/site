<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุณุงูุงูู ูุฑุงุฑุฏุงุฏ ุทุฑุงุญ ุณุงุช</title>
    <!-- ุงุณุชุงูโูุง ู ฺฉุชุงุจุฎุงููโูุง -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet"/>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f3f4f6; }
        .hidden-step { display: none !important; }
        /* ุงุณุชุงู ูุฑุงุฑุฏุงุฏ ุจุฑุง ุนฺฉุณ ฺฏุฑูุชู */
        .contract-paper {
            background: white; width: 800px; padding: 40px; border: 1px solid #ccc;
            position: relative; margin: 0 auto; color: #000;
        }
        .watermark {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px; color: rgba(255, 0, 0, 0.1); font-weight: bold; border: 5px solid rgba(255,0,0,0.1); padding: 20px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- *** ุชูุธูุงุช *** -->
    <script>
        // ููฺฉ ูุจโุงูพ ุฎูุฏ ุฑุง ุงูุฌุง ูุฑุงุฑ ุฏูุฏ
        const APP_SCRIPT_URL = "ููฺฉ_ฺฏูฺฏู_ุงุณฺฉุฑูพุช_ุฑุง_ุงูุฌุง_ุจฺฏุฐุงุฑุฏ"; 
    </script>

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden min-h-[500px]">
        
        <!-- ูุฏุฑ -->
        <div class="bg-blue-800 p-6 text-white text-center">
            <h1 class="text-2xl font-bold">ุณุงูุงูู ุซุจุช ูุฑุงุฑุฏุงุฏ ุทุฑุงุญ ุณุงุช</h1>
            <p class="text-sm opacity-80 mt-1">ูุณุฎู ููุง</p>
        </div>

        <!-- ููุฏูฺฏ ุงููู -->
        <div id="loading" class="p-10 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-800 mx-auto mb-4"></div>
            <p>ุฏุฑ ุญุงู ุงุชุตุงู ุจู ุณุงูุงูู...</p>
        </div>

        <!-- ุตูุญู ฑ: ูุฑู ูุฑูุฏ -->
        <div id="step-form" class="p-6 hidden-step">
            <form onsubmit="handlePreview(event)">
                <div class="grid gap-6 mb-6">
                    <div>
                        <label class="block mb-2 text-sm font-bold">ูุงู ู ูุงู ุฎุงููุงุฏฺฏ</label>
                        <input type="text" id="fullName" required class="w-full p-3 border rounded-lg bg-gray-50">
                    </div>
                    
                    <div>
                        <label class="block mb-2 text-sm font-bold">ฺฉุฏ ูู</label>
                        <input type="number" id="nationalCode" required class="w-full p-3 border rounded-lg bg-gray-50" placeholder="10 ุฑูู">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 text-sm font-bold">ุงูุชุฎุงุจ ูพูู</label>
                            <select id="planType" onchange="calcPrice()" class="w-full p-3 border rounded-lg bg-gray-50">
                                <option value="type1" data-price="1000000" data-name="ุณุงุช ูุนุฑู ุณุงุฏู">ูุนุฑู ุณุงุฏู (ฑ ุช)</option>
                                <option value="type2" data-price="2000000" data-name="ุณุงุช ูุชุตู ุจู ฺฏูฺฏู">ูุชุตู ุจู ฺฏูฺฏู (ฒ ุช)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-bold">ูุงูุจ ุณุงุช</label>
                            <select id="templateName" class="w-full p-3 border rounded-lg bg-gray-50">
                                <option>ูููุงู ุขุจ</option>
                                <option>ูุฏุฑู ุชุฑู</option>
                                <option>ุดุฑฺฉุช ุทูุง</option>
                            </select>
                        </div>
                    </div>

                    <div class="border p-4 rounded-lg bg-blue-50">
                        <div class="flex items-center">
                            <input id="domainRequest" type="checkbox" onchange="toggleDomain()" class="w-5 h-5 text-blue-600">
                            <label for="domainRequest" class="mr-2 font-bold">ุฏุฑุฎูุงุณุช ุฎุฑุฏ ุฏุงููู IR ุฏุงุฑู (+ฑฐฐ,ฐฐฐ ุชููุงู)</label>
                        </div>
                        <input type="text" id="domainName" class="hidden mt-3 w-full p-2 border rounded" placeholder="ูุงู ุฏุงููู (ูุซูุง mysite.ir)">
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-bold">ุชุงุฑุฎ ุดุฑูุน ูพุฑูฺู</label>
                        <select id="startDate" required class="w-full p-3 border rounded-lg bg-gray-50">
                            <option value="">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ุธุฑูุชโูุง...</option>
                        </select>
                    </div>
                </div>

                <div class="bg-gray-100 p-4 rounded-lg mb-6 text-center border border-gray-300">
                    <span class="text-gray-600">ูุจูุบ ูุงุจู ูพุฑุฏุงุฎุช:</span>
                    <div class="text-3xl font-bold text-blue-800 mt-1"><span id="totalPriceDisplay">0</span> ุชููุงู</div>
                </div>

                <button type="submit" class="w-full bg-blue-800 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-900 transition">
                    ูุดุงูุฏู ูพุดโููุณ ูุฑุงุฑุฏุงุฏ
                </button>
            </form>
        </div>

        <!-- ุตูุญู ฒ: ูพุดโููุงุด ูุฑุงุฑุฏุงุฏ -->
        <div id="step-preview" class="hidden-step bg-gray-50">
            <div class="p-4 text-center bg-yellow-100 text-yellow-800 text-sm">
                ุงู ูพุดโููุงุด ุงุณุช. ุจุฑุง ููุงโุณุงุฒุ ุฏฺฉูู ุชุฃุฏ ูพุงู ุตูุญู ุฑุง ุจุฒูุฏ.
            </div>
            
            <!-- ูุงุญู ูุฑุงุฑุฏุงุฏ (ุจุฑุง ุนฺฉุณ) -->
            <div style="overflow-x: auto; padding: 20px;">
                <div id="contract-capture" class="contract-paper text-justify text-sm leading-7" dir="rtl">
                    <div class="watermark">ูุงูุฏ ุงุนุชุจุงุฑ ุจุฏูู ูพุฑุฏุงุฎุช</div>
                    
                    <div class="text-center border-b-2 border-black pb-4 mb-4">
                        <h2 class="text-xl font-bold">ูุฑุงุฑุฏุงุฏ ุทุฑุงุญ ุณุงุช (ูุณุฎู ุงูฺฉุชุฑููฺฉ)</h2>
                        <div class="text-xs text-gray-500 mt-1">ุดูุงุณู ุณูุงุฑุด: <span id="c_orderId">---</span> | ุชุงุฑุฎ: <span id="c_date">---</span></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4 bg-gray-50 p-3 border rounded text-xs">
                        <div><strong>ฺฉุงุฑูุฑูุง:</strong> <span id="c_name"></span></div>
                        <div><strong>ฺฉุฏ ูู:</strong> <span id="c_national"></span></div>
                        <div><strong>ููุน ูพูู:</strong> <span id="c_plan"></span></div>
                        <div><strong>ุฏุงููู:</strong> <span id="c_domain"></span></div>
                        <div><strong>ูุจูุบ ฺฉู:</strong> <span id="c_price"></span> ุชููุงู</div>
                        <div><strong>ุชุงุฑุฎ ุดุฑูุน:</strong> <span id="c_start"></span></div>
                    </div>

                    <div class="mb-4 text-xs">
                        <h4 class="font-bold mb-1">ุชุนูุฏุงุช ู ุดุฑุงุท:</h4>
                        <ol class="list-decimal pr-4 space-y-1">
                            <li>ุงู ูุฑุงุฑุฏุงุฏ ูพุณ ุงุฒ ุชุฃุฏุ <strong>ณ ุฑูุฒ ุงุนุชุจุงุฑ</strong> ุฏุงุฑุฏ ู ุฏุฑ ุตูุฑุช ุนุฏู ูพุฑุฏุงุฎุช ุจุงุทู ูโุดูุฏ.</li>
                            <li>ุดุฑูุน ูพุฑูฺู ูููุท ุจู ุชุฃุฏ ูพุฑุฏุงุฎุช ุชูุณุท ุทุฑุงุญ (ุงูุฑุญุณู ุฏุงุฏฺฏุณุชุฑ) ุงุณุช.</li>
                            <li>ูุณุฆููุช ุซุจุชโูุงู ุฏุฑ ุงุฑูฺฉ (ุฏุฑ ุตูุฑุช ุฎุฑุฏ ุฏุงููู) ุจุฑ ุนูุฏู ฺฉุงุฑูุฑูุงุณุช.</li>
                            <li>ุณุงุช ุจุฑ ุจุณุชุฑ GitHub Pages ูพุงุฏูโุณุงุฒ ุดุฏู ู ุงูฺฉุงูุงุช ูุฑูุดฺฏุงู ูุฏุงุฑุฏ.</li>
                        </ol>
                    </div>

                    <div class="flex justify-between items-end mt-10 pt-4 border-t-2 border-black">
                        <div class="text-center w-1/3">
                            <div class="font-bold">ุทุฑุงุญ</div>
                            <div class="mt-2 text-xs">ุงูุฑุญุณู ุฏุงุฏฺฏุณุชุฑ</div>
                            <div class="text-[10px] text-gray-400">(ุงูุถุง ุณุณุชู)</div>
                        </div>
                        <div class="text-center w-1/3">
                            <div class="font-bold">ฺฉุงุฑูุฑูุง</div>
                            <div class="mt-2 text-xs" id="c_name_sign"></div>
                            <div class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded inline-block">ุชุฃุฏ ุงูฺฉุชุฑููฺฉ ุดุฏ</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-white shadow-inner">
                <div class="flex items-center mb-4">
                    <input id="agreeCheck" type="checkbox" class="w-5 h-5 ml-2">
                    <label for="agreeCheck" class="text-sm font-bold">ูุฑุงุฑุฏุงุฏ ุฑุง ูุทุงูุนู ฺฉุฑุฏู ู ูโูพุฐุฑู.</label>
                </div>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('step-preview').classList.add('hidden-step'); document.getElementById('step-form').classList.remove('hidden-step');" class="w-1/3 bg-gray-200 py-3 rounded-lg text-gray-700 font-bold">ุจุงุฒฺฏุดุช</button>
                    <button id="btnFinalSubmit" onclick="submitOrder()" disabled class="w-2/3 bg-green-600 text-white py-3 rounded-lg font-bold disabled:bg-gray-400">ุชุฃุฏ ู ุตุฏูุฑ ููุง</button>
                </div>
            </div>
        </div>

        <!-- ุตูุญู ณ: ููููุช -->
        <div id="step-success" class="hidden-step p-8 text-center">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">โ</div>
            <h2 class="text-2xl font-bold mb-2">ุณูุงุฑุด ุซุจุช ุดุฏ!</h2>
            <p class="text-gray-600 mb-6">ุชุตูุฑ ูุฑุงุฑุฏุงุฏ ุฑุง ุฏุงูููุฏ ฺฉูุฏ ู ููุฑุงู ูุด ูุงุฑุฒ ุฏุฑ ุงุชุง ุงุฑุณุงู ฺฉูุฏ.</p>
            
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6 text-sm">
                <p class="mb-1">๐ณ <strong>ุดูุงุฑู ฺฉุงุฑุช:</strong> 6063-7311-3256-0120</p>
                <p>โ <strong>ูููุช ูพุฑุฏุงุฎุช:</strong> <span id="expireDateDisplay" class="font-bold"></span></p>
            </div>

            <a id="downloadLink" class="block w-full bg-blue-800 text-white py-4 rounded-lg font-bold mb-3 shadow-lg cursor-pointer flex justify-center items-center gap-2">
                ๐ฅ ุฏุงูููุฏ ุชุตูุฑ ูุฑุงุฑุฏุงุฏ
            </a>
            
            <a href="https://eitaa.com/YOUR_ID" class="block w-full bg-blue-100 text-blue-800 py-3 rounded-lg font-bold">
                ุงุฑุณุงู ูุด ุฏุฑ ุงุชุง
            </a>
        </div>

    </div>

    <!-- *** ุงุณฺฉุฑูพุช ุงุตู *** -->
    <script>
        // ----------------------------------------------------
        // ุชุงุจุน ุงุตู ุงุชุตุงู (ุฏููุงู ูุดุงุจู ฺฉุฏ ููููู ุดูุง)
        // ----------------------------------------------------
        async function callApi(action, params = {}) {
            try {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // ุทุจู ููููู ุดูุง
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8' // ูฺฉุชู ฺฉูุฏ ุงุชุตุงู
                    },
                    body: JSON.stringify({ action, params })
                });
                
                if (!response.ok) throw new Error("Network response was not ok");
                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                alert("ุฎุทุง ุฏุฑ ุงุชุตุงู ุจู ุณุฑูุฑ. ูุทูุง ุงูุชุฑูุช ุฑุง ุจุฑุฑุณ ฺฉูุฏ ุง ููฺฉ ุงุณฺฉุฑูพุช ุฑุง ฺฺฉ ฺฉูุฏ.");
                return { status: 'error' };
            }
        }

        // --- ูุชุบุฑูุง ---
        let formData = {};

        // 1. ุดุฑูุน ุจุฑูุงูู ู ุฏุฑุงูุช ุธุฑูุชโูุง
        window.onload = async function() {
            if(APP_SCRIPT_URL.includes("https://script.google.com/macros/s/AKfycbxVkozAAKm-QZqLt14u3irfG-ojLUvcRjt5CTv0n4HVy1tIXb-R86F-xJu8W_V7WV2W/exec")) {
                alert("ูุทูุงู ูุงู HTML ุฑุง ุจุงุฒ ฺฉูุฏ ู ููฺฉ ุงุณฺฉุฑูพุช ุฑุง ูุงุฑุฏ ฺฉูุฏ!");
                return;
            }

            const res = await callApi('getCapacity');
            
            const select = document.getElementById('startDate');
            select.innerHTML = '<option value="">ุงูุชุฎุงุจ ฺฉูุฏ...</option>';
            
            if(res.status === 'success' && res.dates) {
                res.dates.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d.value;
                    opt.text = d.label;
                    select.add(opt);
                });
                document.getElementById('loading').classList.add('hidden-step');
                document.getElementById('step-form').classList.remove('hidden-step');
            }
            calcPrice(); // ูุญุงุณุจู ุงููู ููุช
        };

        // 2. ูุญุงุณุจุงุช ููุช
        function toggleDomain() {
            const chk = document.getElementById('domainRequest');
            document.getElementById('domainName').classList.toggle('hidden', !chk.checked);
            calcPrice();
        }

        function calcPrice() {
            const planSelect = document.getElementById('planType');
            const selectedOpt = planSelect.options[planSelect.selectedIndex];
            
            const planPrice = parseInt(selectedOpt.dataset.price);
            const domainPrice = document.getElementById('domainRequest').checked ? 100000 : 0;
            const total = planPrice + domainPrice;

            document.getElementById('totalPriceDisplay').innerText = total.toLocaleString();
            
            // ุฐุฎุฑู ุจุฑุง ุงุณุชูุงุฏู ุจุนุฏ
            formData.planPrice = planPrice;
            formData.domainPrice = domainPrice;
            formData.totalPrice = total;
            formData.planName = selectedOpt.dataset.name;
        }

        // 3. ุฑูุชู ุจู ูพุดโููุงุด
        function handlePreview(e) {
            e.preventDefault();
            
            // ุฌูุนโุขูุฑ ุงุทูุงุนุงุช
            formData.fullName = document.getElementById('fullName').value;
            formData.nationalCode = document.getElementById('nationalCode').value;
            formData.templateName = document.getElementById('templateName').value;
            formData.domainRequest = document.getElementById('domainRequest').checked;
            formData.domainName = document.getElementById('domainName').value;
            formData.startDate = document.getElementById('startDate').value;
            formData.planType = document.getElementById('planType').value;

            const dateLabel = document.getElementById('startDate').options[document.getElementById('startDate').selectedIndex].text;

            // ูพุฑ ฺฉุฑุฏู ูุฑุงุฑุฏุงุฏ
            document.getElementById('c_name').innerText = formData.fullName;
            document.getElementById('c_national').innerText = formData.nationalCode;
            document.getElementById('c_plan').innerText = formData.planName;
            document.getElementById('c_domain').innerText = formData.domainRequest ? (formData.domainName || "ุจูู") : "ุฎุฑ";
            document.getElementById('c_price').innerText = formData.totalPrice.toLocaleString();
            document.getElementById('c_start').innerText = dateLabel.split('(')[0];
            document.getElementById('c_name_sign').innerText = formData.fullName;
            document.getElementById('c_date').innerText = new Date().toLocaleDateString('fa-IR');

            // ููุงุด
            document.getElementById('step-form').classList.add('hidden-step');
            document.getElementById('step-preview').classList.remove('hidden-step');
        }

        // 4. ฺฺฉโุจุงฺฉุณ ููุงูู
        document.getElementById('agreeCheck').addEventListener('change', function() {
            document.getElementById('btnFinalSubmit').disabled = !this.checked;
        });

        // 5. ุซุจุช ููุง
        async function submitOrder() {
            const btn = document.getElementById('btnFinalSubmit');
            btn.innerHTML = "ุฏุฑ ุญุงู ุซุจุช...";
            btn.disabled = true;

            const res = await callApi('submitOrder', formData);

            if(res.status === 'success') {
                // ุจุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ูุฑุงุฑุฏุงุฏ ุจุฑุง ุนฺฉุณ ฺฏุฑูุชู
                document.getElementById('c_orderId').innerText = res.orderId;
                document.getElementById('expireDateDisplay').innerText = res.expireDate;
                
                // ุชููุฏ ุชุตูุฑ
                const element = document.getElementById('contract-capture');
                html2canvas(element, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    const link = document.getElementById('downloadLink');
                    link.href = imgData;
                    link.download = `Contract-${res.orderId}.png`;
                    
                    document.getElementById('step-preview').classList.add('hidden-step');
                    document.getElementById('step-success').classList.remove('hidden-step');
                });

            } else {
                alert("ุฎุทุง: " + res.message);
                btn.innerHTML = "ุชุฃุฏ ู ุตุฏูุฑ ููุง";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
