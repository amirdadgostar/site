    <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; direction: rtl; text-align: right; }
        .box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; cursor: pointer; font-weight: bold; border: none; }
        button:hover { background: #0056b3; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f9f9f9; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #eee; }
        .tab.active { background: #007bff; color: white; }
        
        /* استایل روز جمعه */
        .is-friday { color: red; font-weight: bold; }
        .date-cell { font-size: 0.9em; }
        .day-name { font-size: 0.8em; display: block; color: #666; }
        .is-friday .day-name { color: red; }
        
        /* استایل لینک تماس */
        .phone-link { color: #007bff; text-decoration: none; font-weight: bold; direction: ltr; display: inline-block; }
        .phone-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<script>
    // *** لینک اسکریپت خود را اینجا بگذارید ***
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 
    
    // --- توابع تبدیل تاریخ و شمسی ---
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m, jy, jm, jd, gy2, days;
        g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        gy2 = (gm > 2) ? (gy + 1) : gy;
        days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
        jy = -1595 + (33 * ~~(days / 12053));
        days %= 12053;
        jy += 4 * ~~(days / 1461);
        days %= 1461;
        if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        if (days < 186) { jm = 1 + ~~(days / 31); jd = 1 + (days % 31); } 
        else { jm = 7 + ~~((days - 186) / 30); jd = 1 + ((days - 186) % 30); }
        return { y: jy, m: jm, d: jd };
    }

    function getPersianDetails(dateStr) {
        if (!dateStr) return { text: "", isFriday: false };
        let parts = dateStr.split('-');
        let gy = parseInt(parts[0]);
        let gm = parseInt(parts[1]);
        let gd = parseInt(parts[2]);
        
        let jDate = gregorianToJalali(gy, gm, gd);
        
        let dateObj = new Date(dateStr);
        let dayOfWeek = dateObj.getDay(); // 0 = Sunday, 5 = Friday, 6 = Saturday (Note: JS getDay depends on locale but usually 5 is Friday)
        // تطبیق دقیق روز هفته:
        // یکشنبه=0, دوشنبه=1, ..., جمعه=5, شنبه=6
        
        const days = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        let dayName = days[dayOfWeek];
        let isFriday = (dayOfWeek === 5);
        
        const monthNames = ["", "فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        
        let text = `${dayName} ${jDate.d} ${monthNames[jDate.m]}`;
        
        return { text: text, isFriday: isFriday, fullJalali: `${jDate.y}/${jDate.m}/${jDate.d}` };
    }
</script>

<!-- صفحه لاگین -->
<div id="loginPage" class="box" style="max-width: 350px; margin-top: 50px;">
    <h3 style="text-align: center;">ورود مدیر</h3>
    <input type="text" id="u" placeholder="نام کاربری">
    <input type="password" id="p" placeholder="رمز عبور">
    <button onclick="login()">ورود</button>
    <p id="msg" style="color:red; text-align:center;"></p>
</div>

<!-- پنل اصلی -->
<div id="mainPage" class="box hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>پنل مدیریت</h3>
        <button onclick="logout()" style="width: auto; background: #dc3545;">خروج</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('settings')">تنظیمات ۳۰ روزه</div>
        <div class="tab" onclick="showTab('list')">لیست نوبت‌ها</div>
        <div class="tab" onclick="showTab('pass')">تغییر رمز</div>
    </div>

    <!-- تنظیمات -->
    <div id="settings" class="content">
        <button onclick="saveSettings()">ذخیره همه تغییرات</button>
        <table>
            <thead><tr><th>تاریخ</th><th>ظرفیت</th><th>رزرو شده</th><th>شروع</th><th>پایان</th></tr></thead>
            <tbody id="tblSettings"></tbody>
        </table>
    </div>

    <!-- لیست نوبت ها -->
    <div id="list" class="content hidden">
        <input type="text" id="search" placeholder="جستجوی نام..." style="width: 70%; display:inline-block;">
        <button onclick="loadList(1)" style="width: 28%; display:inline-block;">جستجو</button>
        <table>
            <thead><tr><th>تاریخ</th><th>نام</th><th>موبایل</th><th>نوبت</th><th>ساعت</th></tr></thead>
            <tbody id="tblList"></tbody>
        </table>
        <div style="text-align:center; margin-top:10px;">
            <button onclick="prevPage()" style="width:auto;">قبلی</button>
            <span id="pageNum">1</span>
            <button onclick="nextPage()" style="width:auto;">بعدی</button>
        </div>
    </div>

    <!-- تغییر رمز -->
    <div id="pass" class="content hidden">
        <input type="password" id="oldP" placeholder="رمز فعلی">
        <input type="password" id="newP" placeholder="رمز جدید">
        <button onclick="changePass()">تغییر رمز</button>
    </div>
</div>

<script>
    let token = localStorage.getItem("admToken");
    let page = 1;

    if(token) {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("mainPage").classList.remove("hidden");
        loadSettings();
    }

    // تابع اصلی ارسال درخواست که مشکل اتصال را حل می‌کند
    async function api(payload) {
        payload.token = token;
        try {
            let req = await fetch(API_URL, {
                method: "POST",
                // نکته کلیدی: استفاده از text/plain برای جلوگیری از گیر دادن مرورگر
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            });
            return await req.json();
        } catch(e) {
            alert("خطا در اتصال به سرور. اینترنت را چک کنید یا لینک اسکریپت اشتباه است.");
            console.log(e);
            return {success: false};
        }
    }

    function login() {
        let u = document.getElementById("u").value;
        let p = document.getElementById("p").value;
        document.getElementById("msg").innerText = "در حال اتصال...";
        
        api({action: "login", username: u, password: p}).then(res => {
            if(res.success) {
                token = res.token;
                localStorage.setItem("admToken", token);
                location.reload();
            } else {
                document.getElementById("msg").innerText = res.message;
            }
        });
    }

    function logout() {
        localStorage.removeItem("admToken");
        location.reload();
    }

    function showTab(id) {
        document.querySelectorAll(".content").forEach(d => d.classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        event.target.classList.add("active");
        if(id === 'list') loadList(1);
    }

    function loadSettings() {
        api({action: "getSettings"}).then(res => {
            let h = "";
            res.data.forEach(d => {
                let pInfo = getPersianDetails(d.date);
                let dateClass = pInfo.isFriday ? "date-cell is-friday" : "date-cell";
                
                h += `<tr>
                    <td class="${dateClass}" data-date="${d.date}">
                        ${pInfo.text}
                        <span class="day-name">${d.date}</span>
                    </td>
                    <td><input value="${d.capacity}" class="cap"></td>
                    <td>${d.reserved}</td>
                    <td><input type="time" value="${d.start}" class="start"></td>
                    <td><input type="time" value="${d.end}" class="end"></td>
                </tr>`;
            });
            document.getElementById("tblSettings").innerHTML = h;
        });
    }

    function saveSettings() {
        let rows = document.querySelectorAll("#tblSettings tr");
        let data = [];
        rows.forEach(r => {
            // خواندن تاریخ میلادی از خاصیت data-date برای ارسال به سرور
            let dateCell = r.querySelector("td[data-date]");
            let realDate = dateCell ? dateCell.getAttribute("data-date") : "";
            
            data.push({
                date: realDate,
                capacity: r.querySelector(".cap").value,
                start: r.querySelector(".start").value,
                end: r.querySelector(".end").value
            });
        });
        api({action: "saveSettings", data: data}).then(res => alert(res.message));
    }

    function loadList(p) {
        page = p;
        let s = document.getElementById("search").value;
        api({action: "getAppointments", page: p, search: s}).then(res => {
            let h = "";
            if(res.list.length === 0) h = "<tr><td colspan='5'>خالی</td></tr>";
            res.list.forEach(r => {
                let pInfo = getPersianDetails(r[0]); // r[0] تاریخ است
                let dateClass = pInfo.isFriday ? "is-friday" : "";
                
                h += `<tr>
                    <td class="${dateClass}">${pInfo.text}<br><small>${r[0]}</small></td>
                    <td>${r[1]}</td>
                    <td><a href="tel:${r[2]}" class="phone-link">${r[2]}</a></td>
                    <td>${r[3]}</td>
                    <td>${r[4]}</td>
                </tr>`;
            });
            document.getElementById("tblList").innerHTML = h;
            document.getElementById("pageNum").innerText = p;
        });
    }
    
    function nextPage() { loadList(page + 1); }
    function prevPage() { if(page > 1) loadList(page - 1); }

    function changePass() {
        let o = document.getElementById("oldP").value;
        let n = document.getElementById("newP").value;
        api({action: "changePassword", oldPass: o, newPass: n}).then(res => {
            alert(res.message);
            if(res.success) {
                document.getElementById("oldP").value = "";
                document.getElementById("newP").value = "";
            }
        });
    }
</script>

</body>
</html>
