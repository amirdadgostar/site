<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پنل مدیریت مدرن</title>
    
    <!-- اضافه کردن فونت مدرن و رسمی وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.0.0/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- اضافه کردن آیکون های حرفه ای Ionicons (الکترونی) -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <style>
        :root {
            /* رنگ بندی بسیار رسمی، مدرن و سازمانی */
            --primary: #1e3a8a; /* آبی نفتی تیره و رسمی */
            --primary-dark: #172554;
            --primary-light: #eff6ff;
            --secondary: #475569;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --danger: #e11d48;
            --danger-light: #ffe4e6;
            --success: #059669;
            --border-color: #e2e8f0;
            --border-radius: 16px;
            --border-radius-sm: 10px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.03), 0 1px 3px rgba(0, 0, 0, 0.02);
            --shadow-hover: 0 10px 25px rgba(30, 58, 138, 0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Vazirmatn', 'Tahoma', sans-serif; /* تغییر به فونت بسیار حرفه ای */
            background-color: var(--bg-body); 
            margin: 0; 
            padding: 0; 
            color: var(--text-main); 
            line-height: 1.7; 
            font-size: 15px;
        }

        /* --- Layout & Typography --- */
        .container { max-width: 1050px; margin: 30px auto; padding: 0 20px; }
        h3 { font-weight: 800; margin-bottom: 20px; color: var(--text-main); font-size: 1.35rem; letter-spacing: -0.5px; }

        /* --- Components --- */
        .box { 
            background: var(--bg-card); 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            padding: 30px; 
            transition: var(--transition); 
            overflow: hidden; 
            border: 1px solid rgba(0,0,0,0.02);
        }
        .hidden { display: none !important; }

        /* Inputs & Buttons */
        input, button { 
            width: 100%; 
            padding: 15px 18px; 
            border-radius: var(--border-radius-sm); 
            border: 1.5px solid var(--border-color); 
            font-family: inherit; 
            font-size: 1rem; 
            transition: var(--transition); 
            background: #f8fafc;
            color: var(--text-main);
        }
        input:focus { 
            border-color: var(--primary); 
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1); 
        }
        
        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            display: inline-flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
            font-size: 1.05rem;
            letter-spacing: 0.2px;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.2);
        }
        button:hover { 
            background: var(--primary-dark); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(30, 58, 138, 0.3);
        }
        button:active { transform: translateY(0); }
        
        button.danger { background: var(--danger); box-shadow: 0 4px 12px rgba(225, 29, 72, 0.2); }
        button.danger:hover { background: #be123c; box-shadow: 0 6px 15px rgba(225, 29, 72, 0.3); }
        
        /* Icon Buttons */
        .icon-btn { 
            background: var(--bg-body); 
            color: var(--secondary); 
            width: 48px; 
            height: 48px; 
            padding: 0; 
            border-radius: 50%; 
            font-size: 1.4rem; 
            border: 1px solid var(--border-color);
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: var(--primary-light); color: var(--primary); border-color: var(--primary); transform: translateY(-2px); }
        .icon-btn ion-icon { font-size: 22px; }

        /* --- Login Page --- */
        #loginPage { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); 
            padding: 20px;
        }
        .login-card { width: 100%; max-width: 420px; padding: 45px 35px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .login-header { text-align: center; margin-bottom: 35px; }
        .login-header h3 { font-size: 1.6rem; margin: 0; color: var(--text-main); }
        .login-header p { margin-top: 8px; }

        /* --- Main Panel --- */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-bar h3 { margin: 0; }

        /* --- Tabs --- */
        .tabs { 
            display: flex; 
            background: #f8fafc; 
            padding: 6px; 
            border-radius: var(--border-radius); 
            margin-bottom: 30px; 
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }
        .tab { 
            flex: 1; 
            text-align: center; 
            padding: 14px 20px; 
            cursor: pointer; 
            border-radius: var(--border-radius-sm); 
            color: var(--secondary); 
            font-weight: 700; 
            font-size: 0.95rem; 
            white-space: nowrap; 
            transition: var(--transition); 
        }
        .tab.active { 
            background: var(--bg-card); 
            color: var(--primary); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
        }

        /* --- Settings Table (Responsive) --- */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--border-radius); border: 1px solid var(--border-color); background: #fff; }
        table { width: 100%; border-collapse: collapse; min-width: 650px; }
        th, td { padding: 18px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; }
        th { background: #f8fafc; color: var(--text-main); font-weight: 800; font-size: 0.9rem; letter-spacing: 0.5px; }
        tr:hover td { background-color: #fcfcfc; }
        tr:last-child td { border-bottom: none; }
        
        .is-friday { color: var(--danger); font-weight: bold; background-color: var(--danger-light); }
        .is-friday:hover td { background-color: #fde8e8; }
        .day-name { display: block; font-size: 0.85em; color: var(--text-muted); margin-top: 6px; font-weight: 500; }
        
        .table-input { 
            border: 1px solid #cbd5e1; 
            padding: 10px; 
            border-radius: 8px; 
            text-align: center; 
            width: 100%; 
            max-width: 110px; 
            background: #fff;
            margin: 0 auto;
            display: block;
        }

        /* --- Accordion (Appointments) --- */
        .accordion-item { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 12px; overflow: hidden; background: #fff; transition: var(--transition); }
        .accordion-header { padding: 18px 24px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; user-select: none; transition: var(--transition); }
        .accordion-header:hover { background: var(--primary-light); }
        .accordion-header.active { background: var(--primary); border-bottom: 1px solid var(--primary); }
        .accordion-header.active .acc-date, .accordion-header.active .acc-date span { color: #fff !important; }
        
        .acc-date { font-weight: 800; font-size: 1.05rem; color: var(--text-main); transition: var(--transition); }
        .acc-badge { 
            background: var(--bg-card); 
            color: var(--primary); 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 800; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: white; }
        
        .appt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 18px; padding: 24px; }
        .appt-card { 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius-sm); 
            padding: 18px; 
            position: relative; 
            transition: var(--transition); 
            background: #fff;
        }
        .appt-card:hover { border-color: var(--primary); box-shadow: var(--shadow-hover); transform: translateY(-3px); }
        .appt-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.95rem; }
        .appt-label { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; }
        .appt-value { font-weight: 700; color: var(--text-main); }
        .tel-link { color: var(--primary); text-decoration: none; font-weight: 800; direction: ltr; display: inline-block; padding: 4px 8px; background: var(--primary-light); border-radius: 6px; transition: var(--transition); }
        .tel-link:hover { background: var(--primary); color: #fff; }

        /* --- Search Bar Styling --- */
        .search-container { display: flex; gap: 10px; align-items: center; background: #fff; border: 1.5px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 6px; flex-grow: 1; transition: var(--transition); }
        .search-container:focus-within { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1); }
        .search-input { border: none !important; background: transparent; padding: 10px 15px; flex-grow: 1; outline: none; box-shadow: none !important; margin: 0; }
        
        .search-btn-icon { 
            width: 44px; 
            height: 44px; 
            border-radius: 8px; 
            padding: 0; 
            background: var(--primary); 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer;
            box-shadow: none;
        }
        .search-btn-icon ion-icon { font-size: 20px; }
        .search-btn-icon:hover { background: var(--primary-dark); transform: none; box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3); }
        
        .delete-btn-icon { 
            width: 58px; 
            height: 58px; 
            border-radius: var(--border-radius-sm); 
            background: var(--danger-light); 
            color: var(--danger); 
            border: 1px solid #fecaca; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            transition: var(--transition); 
            box-shadow: none;
        }
        .delete-btn-icon ion-icon { font-size: 24px; }
        .delete-btn-icon:hover { background: var(--danger); color: white; border-color: var(--danger); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(225, 29, 72, 0.2); }

        /* --- Skeleton Loader (کاملا مدرن و حرفه ای) --- */
        .skeleton-wrapper { padding: 30px; background: #fff; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .skeleton { 
            background: #e2e8f0; 
            height: 24px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            position: relative; 
            overflow: hidden; 
        }
        .skeleton::after { 
            content: ''; 
            position: absolute; 
            top: 0; right: 0; bottom: 0; left: 0; 
            transform: translateX(-100%); 
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.5) 20%, rgba(255, 255, 255, 0.5) 60%, rgba(255, 255, 255, 0)); 
            animation: shimmer 1.5s infinite; 
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* --- Pagination --- */
        .pagination { display: flex; justify-content: center; gap: 20px; align-items: center; margin-top: 30px; }
        .pagination button { width: auto; padding: 10px 24px; font-size: 0.95rem; border-radius: 30px; }
        .page-info { font-weight: 800; color: var(--primary); font-size: 1.05rem; background: var(--primary-light); padding: 8px 16px; border-radius: 20px; }

        /* --- Modern Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-box { background: white; width: 90%; max-width: 420px; padding: 35px 30px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.95) translateY(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); text-align: center; }
        .modal-overlay.show { opacity: 1; }
        .modal-overlay.show .modal-box { transform: scale(1) translateY(0); }
        .modal-title { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 15px; }
        .modal-text { color: var(--secondary); margin-bottom: 30px; font-size: 1.05rem; line-height: 1.6; }
        .modal-actions { display: flex; justify-content: center; gap: 12px; }
        .modal-btn { padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; flex: 1; font-size: 1rem; box-shadow: none; transition: var(--transition); }
        .modal-btn.primary { background: var(--primary); color: white; }
        .modal-btn.primary:hover { background: var(--primary-dark); }
        .modal-btn.secondary { background: #f1f5f9; color: var(--text-main); }
        .modal-btn.secondary:hover { background: #e2e8f0; }
        .modal-btn.danger { background: var(--danger); color: white; }
        .modal-btn.danger:hover { background: #be123c; }
        
        /* Security Layer 1: Stealth Honeypot */
        .form-ref-check { position: absolute; left: -9999px; opacity: 0; z-index: -1; }

        @media (max-width: 600px) {
            .container { padding: 0 12px; margin-top: 15px; }
            .box { padding: 20px; border-radius: 20px; }
            .tabs { margin-bottom: 20px; padding: 4px; }
            .tab { padding: 12px 8px; font-size: 0.85rem; }
            .header-bar { flex-direction: column; gap: 15px; align-items: flex-start; }
            .header-left { width: 100%; justify-content: space-between; }
            .appt-grid { grid-template-columns: 1fr; padding: 15px; }
            .delete-btn-icon { width: 50px; height: 50px; }
            .search-container { padding: 4px; }
            .login-card { padding: 30px 20px; }
        }
    </style>
</head>
<body>

<script>
    // *** لینک اسکریپت خود را اینجا بگذارید ***
    const API_URL = "https://script.google.com/macros/s/AKfycbyTvD222XKt9Oh9CuQH7C8metSOd5vF3odi1iBCdKDSfmUKMd-d1JQK1NLMzpNST3T0Dg/exec"; 
</script>

<!-- Custom Modal Structure -->
<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <div id="modalTitle" class="modal-title">عنوان</div>
        <div id="modalText" class="modal-text">متن پیام</div>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<!-- صفحه لاگین -->
<div id="loginPage">
    <div class="box login-card">
        <div class="login-header">
            <h3>ورود مدیر سیستم</h3>
            <p style="color:var(--text-muted); font-size:0.95rem;">لطفا اطلاعات ورود را وارد کنید</p>
        </div>
        <!-- Defense Layer 1: Honeypot -->
        <input type="text" id="form_ref_id" name="form_ref_id" class="form-ref-check" tabindex="-1" autocomplete="off">
        
        <div style="margin-bottom:18px;">
            <input type="text" id="u" placeholder="نام کاربری">
        </div>
        <div style="margin-bottom:25px;">
            <input type="password" id="p" placeholder="رمز عبور">
        </div>
        <button onclick="login()">ورود به پنل</button>
        <p id="msg" style="color:var(--danger); text-align:center; margin-top:20px; font-size:0.95rem; font-weight:600; min-height:20px;"></p>
    </div>
</div>

<!-- پنل اصلی -->
<div id="mainPage" class="container hidden">
    <div class="box">
        <div class="header-bar">
            <h3>پنل مدیریت نوبت‌دهی</h3>
            <div class="header-left">
                <!-- استفاده از آیکون مدرن الکترونی (Ionicons) -->
                <button class="icon-btn" onclick="showTab('pass')" title="تغییر رمز عبور">
                    <ion-icon name="key-outline"></ion-icon>
                </button>
                <button class="danger" onclick="confirmLogout()" style="width:auto; padding:10px 20px; font-size:0.95rem; border-radius:10px;">
                    <ion-icon name="log-out-outline" style="font-size:18px;"></ion-icon> خروج
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('settings')">تنظیمات ۳۰ روزه</div>
            <div class="tab" onclick="showTab('list')">لیست نوبت‌ها</div>
            <div class="tab" onclick="showTab('users')">لیست مراجعین</div>
        </div>

        <!-- تب تنظیمات -->
        <div id="settings" class="content">
            <div id="settings-loader" class="hidden skeleton-wrapper">
                <div class="skeleton" style="height:50px; width:100%;"></div>
                <div class="skeleton" style="height:50px; width:100%;"></div>
                <div class="skeleton" style="height:50px; width:100%;"></div>
                <div class="skeleton" style="height:50px; width:100%;"></div>
            </div>
            
            <div id="settings-content">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>تاریخ</th>
                                <th>رزرو شده</th>
                                <th>ظرفیت</th>
                                <th>شروع</th>
                                <th>پایان</th>
                            </tr>
                        </thead>
                        <tbody id="tblSettings"></tbody>
                    </table>
                </div>
                <div style="margin-top:25px;">
                    <button onclick="saveSettings()">ذخیره تمام تغییرات</button>
                </div>
            </div>
        </div>

        <!-- تب لیست نوبت ها -->
        <div id="list" class="content hidden">
            <div style="display:flex; justify-content:space-between; align-items: center; gap:15px; margin-bottom:25px;">
                <!-- جستجوی مدرن با آیکون الکترونی -->
                <div class="search-container">
                    <input type="text" id="search" class="search-input" placeholder="جستجوی نام بیمار...">
                    <button onclick="loadList(1)" class="search-btn-icon">
                        <ion-icon name="search-outline"></ion-icon>
                    </button>
                </div>
                
                <!-- دکمه حذف سوابق قدیمی (آیکون سطل زباله الکترونی) -->
                <button class="delete-btn-icon" onclick="deletePastApps()" title="حذف نوبت‌های گذشته">
                    <ion-icon name="trash-outline"></ion-icon>
                </button>
            </div>

            <div id="list-loader" class="hidden skeleton-wrapper">
                <div class="skeleton" style="height:70px; border-radius:16px;"></div>
                <div class="skeleton" style="height:70px; border-radius:16px;"></div>
                <div class="skeleton" style="height:70px; border-radius:16px;"></div>
            </div>

            <div id="accordionContainer"></div>
            
            <div class="pagination">
                <button onclick="prevPage()">قبلی</button>
                <span id="pageNum" class="page-info">صفحه 1</span>
                <button onclick="nextPage()">بعدی</button>
            </div>
        </div>

        <!-- تب لیست مراجعین -->
        <div id="users" class="content hidden">
            <div class="search-container" style="margin-bottom:25px;">
                <input type="text" id="searchUser" class="search-input" placeholder="جستجوی نام یا موبایل...">
                <button onclick="loadUsers(1)" class="search-btn-icon">
                    <ion-icon name="search-outline"></ion-icon>
                </button>
            </div>

            <div id="users-loader" class="hidden skeleton-wrapper">
                <div class="skeleton" style="height:50px; width:100%;"></div>
                <div class="skeleton" style="height:50px; width:100%;"></div>
                <div class="skeleton" style="height:50px; width:100%;"></div>
            </div>

            <div class="table-wrapper">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>نام و نام خانوادگی</th>
                            <th>شماره تماس</th>
                            <th>تاریخ آخرین مراجعه</th>
                        </tr>
                    </thead>
                    <tbody id="tblUsers"></tbody>
                </table>
            </div>

            <div class="pagination">
                <button onclick="prevUserPage()">قبلی</button>
                <span id="userPageNum" class="page-info">صفحه 1</span>
                <button onclick="nextUserPage()">بعدی</button>
            </div>
        </div>

        <!-- تب تغییر رمز -->
        <div id="pass" class="content hidden">
            <div style="max-width:420px; margin:0 auto; padding:30px 0;">
                <h4 style="text-align:center; margin-bottom:25px; font-size:1.2rem; font-weight:800;">تغییر رمز عبور مدیر</h4>
                <input type="password" id="oldP" placeholder="رمز فعلی" style="margin-bottom:18px;">
                <input type="password" id="newP" placeholder="رمز جدید" style="margin-bottom:25px;">
                <button onclick="changePass()">تغییر رمز</button>
            </div>
        </div>
    </div>
</div>

<script>
    let token = localStorage.getItem("admToken");
    let page = 1;
    let userPage = 1;
    const DAY_NAMES =;

    // --- Modal Functions ---
    const modal = document.getElementById('customModal');
    
    function showModal(title, text) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalText').innerText = text;
        const actions = document.getElementById('modalActions');
        actions.innerHTML = `<button class="modal-btn primary" onclick="closeModal()">تائید</button>`;
        
        modal.style.display = 'flex';
        // Small delay for animation
        setTimeout(() => modal.classList.add('show'), 10);
    }

    function showConfirm(title, text, callback) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalText').innerText = text;
        const actions = document.getElementById('modalActions');
        
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'modal-btn danger';
        confirmBtn.innerText = 'بله، انجام شود';
        confirmBtn.onclick = function() {
            closeModal();
            callback();
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modal-btn secondary';
        cancelBtn.innerText = 'لغو';
        cancelBtn.onclick = closeModal;

        actions.innerHTML = '';
        actions.appendChild(cancelBtn);
        actions.appendChild(confirmBtn);

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeModal() {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }
    // -----------------------

    // --- توابع کمکی تاریخ ---
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m, jy, jm, jd, gy2, days;
        g_d_m =;
        gy2 = (gm > 2) ? (gy + 1) : gy;
        days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m;
        jy = -1595 + (33 * ~~(days / 12053));
        days %= 12053;
        jy += 4 * ~~(days / 1461);
        days %= 1461;
        if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        if (days < 186) { jm = 1 + ~~(days / 31); jd = 1 + (days % 31); } else { jm = 7 + ~~((days - 186) / 30); jd = 1 + ((days - 186) % 30); }
        return jy + '/' + jm + '/' + jd;
    }

    function getDayName(dateStr) {
        const d = new Date(dateStr);
        return { index: d.getDay(), name: DAY_NAMES };
    }

    function toJalaliStr(dateStr) {
        if(!dateStr) return "";
        let dStr = String(dateStr);
        if(dStr.includes('T')) dStr = dStr.split('T');
        else if(dStr.includes(' ')) dStr = dStr.split(' ');
        
        let parts = dStr.split('-');
        if(parts.length < 3) return dStr;
        return gregorianToJalali(parseInt(parts), parseInt(parts), parseInt(parts));
    }
    // -------------------------

    // --- SECURITY PROTOCOLS CLIENT-SIDE ---
    
    // Defense Layer 2: Proof of Work (PoW) Generator
    function _sys_gen_meta_data() {
        var ts = Math.floor(Date.now() / 1000).toString();
        var salt = "X9_SECURE_SALT_LAYER_V1";
        var str = ts + salt;
        
        // Native JS Hash implementation (Must match Server)
        var h = 5381;
        for (var i = 0; i < str.length; i++) {
            h = (Math.imul(33, h) + str.charCodeAt(i)) | 0;
        }
        var hash = (h >>> 0).toString(16);
        
        return { t: ts, h: hash };
    }

    if(token) {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("mainPage").classList.remove("hidden");
        loadSettings();
    }

    async function api(payload) {
        // SECURITY INJECTION
        // 1. Inject Session Token
        payload.token = token;
        
        // 2. Inject Honeypot Value (Must be empty)
        var hp = document.getElementById("form_ref_id");
        payload.form_ref_id = hp ? hp.value : "";
        
        // 3. Inject PoW
        var meta = _sys_gen_meta_data();
        payload.sys_meta_t = meta.t;
        payload.sys_meta_h = meta.h;

        try {
            let req = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            });
            return await req.json();
        } catch(e) {
            showModal("خطا", "خطا در اتصال به سرور.");
            console.log(e);
            return {success: false};
        }
    }

    function login() {
        let u = document.getElementById("u").value;
        let p = document.getElementById("p").value;
        let btn = document.querySelector("#loginPage button");
        let msg = document.getElementById("msg");
        
        btn.innerHTML = "<ion-icon name='sync-outline' style='animation: spin 1s linear infinite;'></ion-icon> در حال بررسی...";
        btn.disabled = true;
        msg.textContent = "";

        api({action: "login", username: u, password: p}).then(res => {
            btn.textContent = "ورود به پنل";
            btn.disabled = false;
            
            if(res.success) {
                token = res.token;
                localStorage.setItem("admToken", token);
                document.getElementById("loginPage").classList.add("hidden");
                document.getElementById("mainPage").classList.remove("hidden");
                loadSettings();
            } else {
                msg.textContent = res.message;
            }
        });
    }

    function confirmLogout() {
        showConfirm("خروج", "آیا مطمئن هستید که می‌خواهید خارج شوید؟", function() {
            localStorage.removeItem("admToken");
            location.reload();
        });
    }

    function showTab(id) {
        document.querySelectorAll(".content").forEach(d => d.classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        
        if(id !== 'pass') {
             let tabBtns = document.querySelectorAll(".tab");
             if(id === 'settings') tabBtns.classList.add("active");
             if(id === 'list') tabBtns.classList.add("active");
             if(id === 'users') tabBtns.classList.add("active");
        }

        if(id === 'list') loadList(1);
        if(id === 'users') loadUsers(1);
    }

    function loadSettings() {
        document.getElementById("settings-loader").classList.remove("hidden");
        document.getElementById("settings-content").classList.add("hidden");

        api({action: "getSettings"}).then(res => {
            let h = "";
            res.data.forEach(d => {
                let jalaliDate = toJalaliStr(d.date);
                let dayInfo = getDayName(d.date); 
                let rowClass = (dayInfo.index === 5) ? "is-friday" : ""; 

                h += `<tr class="${rowClass}">
                    <td data-gdate="${d.date}">
                        ${jalaliDate}
                        <span class="day-name">${dayInfo.name}</span>
                    </td>
                    <td style="font-weight:800; color:var(--primary); font-size:1.1rem;">${d.booked}</td>
                    <td><input value="${d.capacity}" class="table-input cap"></td>
                    <td><input type="time" value="${d.start}" class="table-input start"></td>
                    <td><input type="time" value="${d.end}" class="table-input end"></td>
                </tr>`;
            });
            document.getElementById("tblSettings").innerHTML = h;
            
            document.getElementById("settings-loader").classList.add("hidden");
            document.getElementById("settings-content").classList.remove("hidden");
        });
    }

    function saveSettings() {
        let btn = document.querySelector("#settings button");
        btn.innerHTML = "<ion-icon name='sync-outline' style='animation: spin 1s linear infinite;'></ion-icon> در حال ذخیره...";
        btn.disabled = true;

        let rows = document.querySelectorAll("#tblSettings tr");
        let data =[];
        let hasError = false;

        rows.forEach(row => {
            let gDate = row.cells.getAttribute("data-gdate");
            let cap = row.querySelector(".cap").value;
            let start = row.querySelector(".start").value;
            let end = row.querySelector(".end").value;

            if(cap && cap > 0 && start && end) {
                if(end < start) {
                    showModal("خطا", "در تاریخ " + toJalaliStr(gDate) + " ساعت پایان نمی‌تواند کمتر از ساعت شروع باشد.");
                    hasError = true;
                }
            }

            data.push({
                date: gDate,
                capacity: cap,
                start: start,
                end: end
            });
        });

        if(hasError) {
            btn.textContent = "ذخیره تمام تغییرات";
            btn.disabled = false;
            return;
        }

        api({action: "saveSettings", data: data}).then(res => {
            showModal("موفق", res.message);
            btn.textContent = "ذخیره تمام تغییرات";
            btn.disabled = false;
        });
    }

    // --- لیست نوبت ها ---
    function loadList(p) {
        page = p;
        let s = document.getElementById("search").value;
        
        document.getElementById("list-loader").classList.remove("hidden");
        document.getElementById("accordionContainer").innerHTML = "";

        api({action: "getAppointments", page: p, search: s}).then(res => {
            document.getElementById("list-loader").classList.add("hidden");
            let container = document.getElementById("accordionContainer");
            
            if(res.list.length === 0) {
                container.innerHTML = "<div style='text-align:center; padding:40px; color:var(--text-muted); font-weight:600; font-size:1.1rem;'>موردی یافت نشد</div>";
                return;
            }

            let grouped = {};
            res.list.forEach(item => {
                let dateKey = item;
                if(!grouped) grouped = [];
                grouped.push(item);
            });

            for (let date in grouped) {
                let items = grouped;
                
                // --- ویرایش: مرتب سازی بر اساس شماره نوبت (ستون 3 در آرایه، چون از 0 شروع میشه) ---
                items.sort(function(a, b) {
                    return parseInt(a) - parseInt(b);
                });
                // ---------------------------------------------------------------

                let jalaliDate = toJalaliStr(date);
                let dayInfo = getDayName(date);
                let count = items.length;

                let header = document.createElement("div");
                header.className = "accordion-header";
                header.innerHTML = `
                    <div class="acc-date">${jalaliDate} <span style="font-size:0.85em; font-weight:500; opacity:0.8;">(${dayInfo.name})</span></div>
                    <div class="acc-badge">${count} رزرو ثبت شده</div>
                `;

                let content = document.createElement("div");
                content.className = "accordion-content";
                
                let gridHtml = `<div class="appt-grid">`;
                items.forEach(r => {
                    gridHtml += `
                        <div class="appt-card">
                            <div class="appt-row">
                                <span class="appt-label">نام بیمار</span>
                                <span class="appt-value">${r}</span>
                            </div>
                            <div class="appt-row">
                                <span class="appt-label">شماره تماس</span>
                                <span class="appt-value"><a href="tel:${r}" class="tel-link" dir="ltr">${r}</a></span>
                            </div>
                             <div class="appt-row">
                                <span class="appt-label">شماره نوبت</span>
                                <span class="appt-value" style="color:var(--primary); font-size:1.2em; font-weight:900;">${r}</span>
                            </div>
                             <div class="appt-row" style="margin-bottom:0; border-top:1px dashed var(--border-color); padding-top:12px; margin-top:12px;">
                                <span class="appt-label">ساعت حضور</span>
                                <span class="appt-value" style="font-size:1.05rem;">${r}</span>
                            </div>
                        </div>
                    `;
                });
                gridHtml += `</div>`;
                content.innerHTML = gridHtml;

                header.addEventListener("click", function() {
                    this.classList.toggle("active");
                    let pnl = this.nextElementSibling;
                    if (pnl.style.maxHeight) {
                        pnl.style.maxHeight = null;
                    } else {
                        pnl.style.maxHeight = pnl.scrollHeight + "px";
                    } 
                });

                let wrapper = document.createElement("div");
                wrapper.className = "accordion-item";
                wrapper.appendChild(header);
                wrapper.appendChild(content);
                container.appendChild(wrapper);
            }

            document.getElementById("pageNum").innerText = "صفحه " + p;
        });
    }
    
    function deletePastApps() {
        showConfirm("حذف سوابق", "آیا مطمئن هستید؟ تمام نوبت‌های مربوط به تاریخ‌های قبل از امروز حذف خواهند شد.", function() {
            document.getElementById("list-loader").classList.remove("hidden");
            document.getElementById("accordionContainer").innerHTML = "";

            api({action: "deletePast"}).then(res => {
                showModal("انجام شد", res.message);
                loadList(1);
            });
        });
    }

    function nextPage() { loadList(page + 1); }
    function prevPage() { if(page > 1) loadList(page - 1); }

    // --- لیست مراجعین (Users) ---
    function loadUsers(p) {
        userPage = p;
        let s = document.getElementById("searchUser").value;
        
        document.getElementById("users-loader").classList.remove("hidden");
        document.getElementById("tblUsers").innerHTML = "";

        api({action: "getUsers", page: p, search: s}).then(res => {
            document.getElementById("users-loader").classList.add("hidden");
            let h = "";
            if(res.list.length === 0) {
                 h = "<tr><td colspan='3' style='padding:30px; color:var(--text-muted); font-weight:600;'>موردی یافت نشد</td></tr>";
            } else {
                res.list.forEach(u => {
                    // --- ویرایش: نمایش تاریخ شمسی مراجعه کننده ---
                    let jalaliReg = toJalaliStr(u);
                    h += `<tr>
                        <td style="font-weight:700;">${u}</td>
                        <td><a href="tel:${u}" class="tel-link" dir="ltr">${u}</a></td>
                        <td>${jalaliReg}</td>
                    </tr>`;
                });
            }
            document.getElementById("tblUsers").innerHTML = h;
            document.getElementById("userPageNum").innerText = "صفحه " + p;
        });
    }
    function nextUserPage() { loadUsers(userPage + 1); }
    function prevUserPage() { if(userPage > 1) loadUsers(userPage - 1); }

    // --- تغییر رمز ---
    function changePass() {
        let o = document.getElementById("oldP").value;
        let n = document.getElementById("newP").value;
        let btn = document.querySelector("#pass button");
        
        btn.disabled = true;
        btn.innerHTML = "<ion-icon name='sync-outline' style='animation: spin 1s linear infinite;'></ion-icon> در حال انجام...";

        api({action: "changePassword", oldPass: o, newPass: n}).then(res => {
            showModal("پیام سیستم", res.message);
            btn.disabled = false;
            btn.textContent = "تغییر رمز";
            if(res.success) {
                document.getElementById("oldP").value = "";
                document.getElementById("newP").value = "";
            }
        });
    }
</script>

<style>
/* اضافه کردن انیمیشن چرخش برای دکمه ها در زمان لودینگ */
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>

</body>
</html>
