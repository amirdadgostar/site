<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; direction: rtl; text-align: right; }
        .box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; cursor: pointer; font-weight: bold; border: none; }
        button:hover { background: #0056b3; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f9f9f9; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #eee; }
        .tab.active { background: #007bff; color: white; }
        
        /* استایل‌های جدید برای آکاردئون نوبت‌ها */
        .accordion { background-color: #eee; color: #444; cursor: pointer; padding: 15px; width: 100%; border: none; text-align: right; outline: none; font-size: 15px; transition: 0.4s; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .accordion:after { content: '\002B'; color: #777; font-weight: bold; float: left; margin-left: 5px; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 18px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-bottom: 1px solid #eee; }
        .panel table { margin-bottom: 15px; }
        .count-badge { background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.9em; }

        /* استایل لودینگ اسکلتی (Bone Style) */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index: 9999; }
        .skeleton-box { width: 300px; height: 20px; background: #ddd; margin: 10px auto; border-radius: 4px; position: relative; overflow: hidden; }
        .skeleton-box::after { position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.2) 20%, rgba(255, 255, 255, 0.5) 60%, rgba(255, 255, 255, 0)); animation: shimmer 2s infinite; content: ''; }
        .skeleton-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .loader-text { margin-top: 15px; color: #555; font-weight: bold; }
    </style>
</head>
<body>

<script>
    // *** لینک اسکریپت خود را اینجا بگذارید ***
    const API_URL = "https://script.google.com/macros/s/AKfycbwDwkurakHk2G6qFDFof0LJIXysyDSOVU5XvD46RNpO0RjS-x7_nO5hs7vUr2_3B0AH/exec"; 
</script>

<!-- لودینگ با استایل جدید -->
<div id="loader">
    <div class="skeleton-container">
        <div class="skeleton-box" style="width: 200px; height: 30px;"></div>
        <div class="skeleton-box" style="width: 250px;"></div>
        <div class="skeleton-box" style="width: 180px;"></div>
        <div class="loader-text">در حال پردازش اطلاعات...</div>
    </div>
</div>

<!-- صفحه لاگین -->
<div id="loginPage" class="box" style="max-width: 350px; margin-top: 50px;">
    <h3 style="text-align: center;">ورود مدیر</h3>
    <input type="text" id="u" placeholder="نام کاربری">
    <input type="password" id="p" placeholder="رمز عبور">
    <button onclick="login()">ورود</button>
    <p id="msg" style="color:red; text-align:center;"></p>
</div>

<!-- پنل اصلی -->
<div id="mainPage" class="box hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>پنل مدیریت</h3>
        <button onclick="logout()" style="width: auto; background: #dc3545;">خروج</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('settings')">تنظیمات ۳۰ روزه</div>
        <div class="tab" onclick="showTab('list')">لیست نوبت‌ها</div>
        <div class="tab" onclick="showTab('pass')">تغییر رمز</div>
    </div>

    <!-- تنظیمات -->
    <div id="settings" class="content">
        <button onclick="saveSettings()">ذخیره همه تغییرات</button>
        <table>
            <!-- ویرایش: اضافه شدن ستون رزرو شده -->
            <thead><tr><th>تاریخ</th><th>رزرو شده</th><th>ظرفیت</th><th>شروع</th><th>پایان</th></tr></thead>
            <tbody id="tblSettings"></tbody>
        </table>
    </div>

    <!-- لیست نوبت ها (ویرایش: تغییر ساختار برای آکاردئون) -->
    <div id="list" class="content hidden">
        <input type="text" id="search" placeholder="جستجوی نام..." style="width: 70%; display:inline-block;">
        <button onclick="loadList(1)" style="width: 28%; display:inline-block;">جستجو</button>
        
        <!-- محل قرارگیری لیست آکاردئونی -->
        <div id="accordionContainer" style="margin-top: 15px;"></div>
        
        <div style="text-align:center; margin-top:10px;">
            <button onclick="prevPage()" style="width:auto;">قبلی</button>
            <span id="pageNum">1</span>
            <button onclick="nextPage()" style="width:auto;">بعدی</button>
        </div>
    </div>

    <!-- تغییر رمز -->
    <div id="pass" class="content hidden">
        <input type="password" id="oldP" placeholder="رمز فعلی">
        <input type="password" id="newP" placeholder="رمز جدید">
        <button onclick="changePass()">تغییر رمز</button>
    </div>
</div>

<script>
    let token = localStorage.getItem("admToken");
    let page = 1;

    // --- تابع تبدیل تاریخ میلادی به شمسی (جهت نمایش) ---
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m, jy, jm, jd, gy2, days;
        g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        gy2 = (gm > 2) ? (gy + 1) : gy;
        days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
        jy = -1595 + (33 * ~~(days / 12053));
        days %= 12053;
        jy += 4 * ~~(days / 1461);
        days %= 1461;
        if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        if (days < 186) { jm = 1 + ~~(days / 31); jd = 1 + (days % 31); } else { jm = 7 + ~~((days - 186) / 30); jd = 1 + ((days - 186) % 30); }
        return jy + '/' + jm + '/' + jd;
    }

    function toJalaliStr(dateStr) {
        if(!dateStr) return "";
        let parts = dateStr.split('-');
        if(parts.length !== 3) return dateStr;
        return gregorianToJalali(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]));
    }
    
    // تابع کمکی برای گرفتن نام روز هفته
    function getPersianDayName(dateStr) {
        let parts = dateStr.split('-');
        // ایجاد تاریخ دقیق بدون مشکل منطقه زمانی
        let d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        let dayIndex = d.getDay(); // 0=Sunday, ..., 5=Friday, 6=Saturday
        const days = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        return { name: days[dayIndex], isFriday: dayIndex === 5 };
    }
    // ---------------------------------------------------

    if(token) {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("mainPage").classList.remove("hidden");
        loadSettings();
    }

    // تابع اصلی ارسال درخواست که مشکل اتصال را حل می‌کند
    async function api(payload) {
        payload.token = token;
        document.getElementById("loader").style.display = "block"; // نمایش لودینگ
        try {
            let req = await fetch(API_URL, {
                method: "POST",
                // نکته کلیدی: استفاده از text/plain برای جلوگیری از گیر دادن مرورگر
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            });
            let res = await req.json();
            document.getElementById("loader").style.display = "none"; // مخفی کردن لودینگ
            return res;
        } catch(e) {
            document.getElementById("loader").style.display = "none";
            alert("خطا در اتصال به سرور. اینترنت را چک کنید یا لینک اسکریپت اشتباه است.");
            console.log(e);
            return {success: false};
        }
    }

    function login() {
        let u = document.getElementById("u").value;
        let p = document.getElementById("p").value;
        // document.getElementById("msg").innerText = "در حال اتصال..."; // لودینگ اصلی هندل میکند
        
        api({action: "login", username: u, password: p}).then(res => {
            if(res.success) {
                token = res.token;
                localStorage.setItem("admToken", token);
                location.reload();
            } else {
                document.getElementById("msg").innerText = res.message;
            }
        });
    }

    function logout() {
        localStorage.removeItem("admToken");
        location.reload();
    }

    function showTab(id) {
        document.querySelectorAll(".content").forEach(d => d.classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        event.target.classList.add("active");
        if(id === 'list') loadList(1);
    }

    function loadSettings() {
        api({action: "getSettings"}).then(res => {
            let h = "";
            res.data.forEach(d => {
                // نمایش تاریخ شمسی اما ذخیره تاریخ میلادی در attribute برای بازگرداندن صحیح به سرور
                let jalaliDate = toJalaliStr(d.date);
                h += `<tr>
                    <td data-gdate="${d.date}">${jalaliDate}</td>
                    <td>${d.booked}</td>
                    <td><input value="${d.capacity}" class="cap"></td>
                    <td><input type="time" value="${d.start}" class="start"></td>
                    <td><input type="time" value="${d.end}" class="end"></td>
                </tr>`;
            });
            document.getElementById("tblSettings").innerHTML = h;
        });
    }

    function saveSettings() {
        let rows = document.querySelectorAll("#tblSettings tr");
        let data = [];
        rows.forEach(row => {
            // خواندن تاریخ میلادی از attribute برای جلوگیری از بهم ریختن منطق سرور
            let gDate = row.cells[0].getAttribute("data-gdate");
            data.push({
                date: gDate,
                capacity: row.querySelector(".cap").value,
                start: row.querySelector(".start").value,
                end: row.querySelector(".end").value
            });
        });
        api({action: "saveSettings", data: data}).then(res => alert(res.message));
    }

    function loadList(p) {
        page = p;
        let s = document.getElementById("search").value;
        api({action: "getAppointments", page: p, search: s}).then(res => {
            let container = document.getElementById("accordionContainer");
            container.innerHTML = "";
            
            if(res.list.length === 0) {
                container.innerHTML = "<p style='text-align:center'>موردی یافت نشد</p>";
                return;
            }

            // گروه‌بندی نوبت‌ها بر اساس تاریخ
            let grouped = {};
            res.list.forEach(item => {
                let dateKey = item[0]; // تاریخ
                if(!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(item);
            });

            // ساخت آکاردئون
            for (let date in grouped) {
                let items = grouped[date];
                let jalaliDate = toJalaliStr(date);
                let dayInfo = getPersianDayName(date); // دریافت نام روز و وضعیت جمعه
                let count = items.length;

                // استایل قرمز برای جمعه
                let dateStyle = dayInfo.isFriday ? "color: red; font-weight: bold;" : "";
                let displayTitle = `${dayInfo.name} ${jalaliDate}`;

                // دکمه آکاردئون
                let btn = document.createElement("button");
                btn.className = "accordion";
                btn.innerHTML = `<span style="${dateStyle}">${displayTitle}</span> <span class="count-badge">${count} نفر</span>`;
                
                // پنل محتوا
                let panel = document.createElement("div");
                panel.className = "panel";
                
                // جدول داخل پنل
                // دقت کنید: ستون موبایل دقیقا نمایش داده می‌شود
                let tableHtml = `<table><thead><tr><th>نام</th><th>موبایل</th><th>نوبت</th><th>ساعت</th></tr></thead><tbody>`;
                items.forEach(r => {
                    tableHtml += `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                panel.innerHTML = tableHtml;

                // رویداد کلیک
                btn.addEventListener("click", function() {
                    this.classList.toggle("active");
                    let pnl = this.nextElementSibling;
                    if (pnl.style.maxHeight) {
                        pnl.style.maxHeight = null;
                    } else {
                        pnl.style.maxHeight = pnl.scrollHeight + "px";
                    } 
                });

                container.appendChild(btn);
                container.appendChild(panel);
            }

            document.getElementById("pageNum").innerText = p;
        });
    }
    
    function nextPage() { loadList(page + 1); }
    function prevPage() { if(page > 1) loadList(page - 1); }

    function changePass() {
        let o = document.getElementById("oldP").value;
        let n = document.getElementById("newP").value;
        api({action: "changePassword", oldPass: o, newPass: n}).then(res => {
            alert(res.message);
            if(res.success) {
                document.getElementById("oldP").value = "";
                document.getElementById("newP").value = "";
            }
        });
    }
</script>

</body>
</html>
