<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ú†Øª P2P (Ø§ØªØµØ§Ù„ ØªØ¶Ù…ÛŒÙ†ÛŒ)</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root { --p: #0088cc; --bg: #e5ddd5; --me: #dcf8c6; --other: #ffffff; --font: 'Vazirmatn', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); outline: none; }
        body, html { height: 100%; height: 100dvh; background: #f0f2f5; overflow: hidden; position: fixed; width: 100%; }
        .hide { display: none !important; }

        #toast { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; z-index: 9999; font-size: 0.9rem; display: none; }

        /* Auth UI */
        #auth-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; }
        .card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        .inp { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; background: var(--p); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Chat UI */
        #chat-screen { display: flex; flex-direction: column; height: 100%; background: var(--bg); }
        header { background: var(--p); color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 65px; }
        .status { font-size: 0.8rem; font-weight: bold; }
        .status.wait { color: #ffeb3b; }
        .status.ok { color: #81c784; }

        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; position: relative; font-size: 0.95rem; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.me { background: var(--me); align-self: flex-end; border-bottom-right-radius: 0; }
        .msg.other { background: var(--other); align-self: flex-start; border-bottom-left-radius: 0; }
        .meta { display: flex; justify-content: flex-end; font-size: 0.7rem; color: #888; margin-top: 4px; gap: 4px;}
        
        .input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 10px; align-items: center; }
        #msg-input { flex: 1; padding: 12px; border-radius: 20px; border: none; }
        .icon-btn { background: none; border: none; font-size: 1.5rem; color: #555; cursor: pointer; }
    </style>
</head>
<body>

<div id="toast">Ù¾ÛŒØ§Ù…</div>

<div id="auth-screen">
    <div class="card" id="login-box">
        <h2 style="margin-bottom: 20px;">Ú†Øª P2P Ø®Ø§Ù„Øµ</h2>
        <input type="text" id="l-id" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
        <input type="password" id="l-pass" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button class="btn" onclick="app.login()">ÙˆØ±ÙˆØ¯ / Ø³Ø§Ø®Øª ØªÙˆÙ†Ù„</button>
        <p style="margin-top: 15px; cursor: pointer; color: var(--p);" onclick="document.getElementById('login-box').classList.add('hide'); document.getElementById('reg-box').classList.remove('hide');">Ø«Ø¨Øª Ù†Ø§Ù…</p>
        <p style="margin-top: 10px; font-size: 0.75rem; color: red;">Ø¨Ø§ Ø±ÙØ±Ø´ ØµÙØ­Ù‡ØŒ Ú©Ù„ Ú†Øª Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
    </div>
    <div class="card hide" id="reg-box">
        <h2 style="margin-bottom: 20px;">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
        <input type="text" id="r-name" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
        <input type="text" id="r-id" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
        <input type="password" id="r-pass" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button class="btn" onclick="app.register()">Ø«Ø¨Øª Ù†Ø§Ù…</button>
        <p style="margin-top: 15px; cursor: pointer; color: var(--p);" onclick="document.getElementById('reg-box').classList.add('hide'); document.getElementById('login-box').classList.remove('hide');">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</p>
    </div>
</div>

<div id="chat-screen" class="hide">
    <header>
        <div>
            <div id="chat-name" style="font-weight: bold;">...</div>
            <div id="chat-status" class="status wait">Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ†Ù„ (P2P)...</div>
        </div>
        <button class="icon-btn" style="color:white" onclick="app.copyLink()"><i class="ph ph-link"></i></button>
    </header>
    <div id="chat-box"></div>
    <div class="input-area">
        <input type="text" id="msg-input" placeholder="Ù¾ÛŒØ§Ù…..." onkeypress="if(event.key==='Enter') app.sendMsg()">
        <button class="icon-btn" onclick="app.sendMsg()" style="color: var(--p)"><i class="ph-fill ph-paper-plane-right"></i></button>
    </div>
</div>

<script>
    // **********************************************************
    const API_URL = 'https://script.google.com/macros/s/AKfycbzUs7wbZvp4MRoC4twyvXMAZ_vmhX2rTeZCLXhor2f7VoBeWsV4QNyct3bwrW1svmunVQ/exec';
    // **********************************************************

    // Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ WebRTC Ø¨Ø§ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ TURN (Ø¨Ø±Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ù‚Ø·Ø¹ÛŒ Ø§Ø² ÙÛŒÙ„ØªØ± Ùˆ NAT)
    const RTC_CONFIG = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            // Ø³Ø±ÙˆØ± TURN Ø±Ø§ÛŒÚ¯Ø§Ù† (Open Relay) Ø¨Ø±Ø§ÛŒ ØªØ¶Ù…ÛŒÙ† 100 Ø¯Ø±ØµØ¯ÛŒ Ø§ØªØµØ§Ù„
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
        ]
    };

    const app = {
        me: null,
        targetUser: null,
        peer: null,
        channel: null,
        signalingTimer: null,
        isOnline: false,
        iceQueue: [], // ØµÙ Ø¨Ù†Ø¯ÛŒ Ù…Ø³ÛŒØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú¯Ù… Ø´Ø¯Ù† Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§

        init: function() {
            const urlParams = new URLSearchParams(window.location.search);
            const u = urlParams.get('u');
            if(u) this.targetUser = u.toLowerCase();
        },

        toast: function(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        },

        callAPI: async function(act, payload) {
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: act, payload: payload}) });
                return await res.json();
            } catch(e) { return {status: 'error', msg: 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡'}; }
        },

        login: async function() {
            const id = document.getElementById('l-id').value;
            const pass = document.getElementById('l-pass').value;
            if(!id || !pass) return this.toast('ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
            
            this.toast('Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...');
            const res = await this.callAPI('login', {id, pass});
            if(res.status === 'success') {
                this.me = res.user;
                if(this.targetUser === this.me.id) this.targetUser = null;
                this.startEngine();
            } else this.toast(res.msg);
        },

        register: async function() {
            const name = document.getElementById('r-name').value;
            const id = document.getElementById('r-id').value;
            const pass = document.getElementById('r-pass').value;
            if(!name || !id || !pass) return this.toast('ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');

            this.toast('Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ù†Ø§Ù…...');
            const res = await this.callAPI('register', {name, id, pass});
            if(res.status === 'success') {
                this.me = res.user;
                if(this.targetUser === this.me.id) this.targetUser = null;
                this.startEngine();
            } else this.toast(res.msg);
        },

        copyLink: function() {
            const link = location.origin + location.pathname + '?u=' + this.me.id;
            if(navigator.clipboard) navigator.clipboard.writeText(link).then(()=> this.toast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯'));
            else prompt('Ù„ÛŒÙ†Ú©:', link);
        },

        startEngine: function() {
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('chat-screen').classList.remove('hide');
            
            if(!this.targetUser) {
                document.getElementById('chat-name').innerText = 'Ø´Ù…Ø§: ' + this.me.id;
                document.getElementById('chat-status').innerText = 'Ù„ÛŒÙ†Ú© Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ÙØ±Ø¯ÛŒ Ø¨ÙØ±Ø³ØªÛŒØ¯...';
            } else {
                document.getElementById('chat-name').innerText = 'Ù…Ø®Ø§Ø·Ø¨: ' + this.targetUser;
                this.initP2P(true); // Ú†ÙˆÙ† Ù…Ù† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¯Ø§Ø±Ù…ØŒ Ù…Ù† ØªÙˆÙ†Ù„ Ø±Ø§ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù… (Initiator)
            }

            // Ø´Ø±ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§Ø² Ø´ÛŒØª Ú¯ÙˆÚ¯Ù„
            if(!this.signalingTimer) this.signalingTimer = setInterval(() => this.pollSignals(), 3000);
        },

        // ==========================================
        // Ù‡Ø³ØªÙ‡ Ù…Ø±Ú©Ø²ÛŒ P2P (Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø§ØªØµØ§Ù„)
        // ==========================================
        initP2P: function(isInitiator) {
            if (this.peer) this.peer.close();
            
            // Ø³Ø§Ø®Øª Ø´ÛŒØ¡ Ø§ØªØµØ§Ù„ Ø¨Ø§ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ TURN
            this.peer = new RTCPeerConnection(RTC_CONFIG);
            this.iceQueue = [];

            // Ø§Ú¯Ø± Ù…Ù† Ø³Ø§Ø²Ù†Ø¯Ù‡ ØªÙˆÙ†Ù„ Ù‡Ø³ØªÙ…ØŒ Ú©Ø§Ù†Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø±Ø§ Ø¨Ø§Ø² Ù…ÛŒâ€ŒÚ©Ù†Ù…
            if (isInitiator) {
                this.channel = this.peer.createDataChannel('p2p-chat');
                this.setupDataChannel(this.channel);
            }

            // Ø§Ú¯Ø± Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ú©Ø§Ù†Ø§Ù„ Ø³Ø§Ø®ØªØŒ Ù…Ù† Ø¢Ù† Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†Ù…
            this.peer.ondatachannel = (event) => {
                this.channel = event.channel;
                this.setupDataChannel(this.channel);
            };

            // Ø§Ø±Ø³Ø§Ù„ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ Ù…Ù† (ICE) Ø¨Ù‡ Ø´ÛŒØª Ú¯ÙˆÚ¯Ù„ Ø¨Ø±Ø§ÛŒ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„
            this.peer.onicecandidate = (e) => {
                if (e.candidate && this.targetUser) {
                    this.callAPI('sendSignal', {to: this.targetUser, from: this.me.id, type: 'ice', data: e.candidate});
                }
            };

            // Ø³Ø§Ø®Øª Ø¨Ø³ØªÙ‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (Offer)
            if (isInitiator) {
                this.peer.createOffer()
                    .then(offer => this.peer.setLocalDescription(offer))
                    .then(() => {
                        this.callAPI('sendSignal', {to: this.targetUser, from: this.me.id, type: 'offer', data: this.peer.localDescription});
                    });
            }
        },

        setupDataChannel: function(channel) {
            channel.onopen = () => {
                this.isOnline = true;
                const st = document.getElementById('chat-status');
                st.innerText = 'ØªÙˆÙ†Ù„ P2P Ù…ØªØµÙ„ Ø´Ø¯ ğŸŸ¢';
                st.className = 'status ok';
                
                // ØªÙˆÙ†Ù„ Ú©Ù‡ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯ØŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª Ú©Ø§Ù…Ù„Ø§Ù‹ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯!
                clearInterval(this.signalingTimer);
                this.signalingTimer = null;
                this.toast('Ø§ØªØµØ§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯');
            };
            
            channel.onclose = () => {
                this.isOnline = false;
                const st = document.getElementById('chat-status');
                st.innerText = 'Ø§Ø±ØªØ¨Ø§Ø· Ù‚Ø·Ø¹ Ø´Ø¯ ğŸ”´ Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´...';
                st.className = 'status wait';
                
                // ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§ Ø³Ø±ÙˆØ± Ú¯ÙˆÚ¯Ù„
                if(!this.signalingTimer) this.signalingTimer = setInterval(() => this.pollSignals(), 3000);
                if(this.targetUser) this.initP2P(true);
            };

            channel.onmessage = (e) => {
                const data = JSON.parse(e.data);
                
                if (data.sys && data.act === 'read') {
                    const el = document.getElementById('tick-' + data.msgId);
                    if(el) el.innerHTML = '<i class="ph-fill ph-checks" style="color:#34b7f1"></i>';
                    return;
                }

                // Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…
                this.appendMsg(data.text, 'other', data.id, data.time);
                
                // Ø§Ø±Ø³Ø§Ù„ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© ØªÛŒÚ© ØªØ£ÛŒÛŒØ¯
                if(this.channel.readyState === 'open') {
                    this.channel.send(JSON.stringify({sys: true, act: 'read', msgId: data.id}));
                }
            };
        },

        pollSignals: async function() {
            const res = await this.callAPI('getSignals', {me: this.me.id});
            if (!res.signals || res.signals.length === 0) return;

            for (let sig of res.signals) {
                // Ø§Ú¯Ø± Ø´Ø®ØµÛŒ Ù†Ø§Ø´Ù†Ø§Ø³ ØªÙˆÙ†Ù„ Ø³Ø§Ø®Øª
                if (!this.targetUser && sig.type === 'offer') {
                    this.targetUser = sig.from;
                    document.getElementById('chat-name').innerText = 'Ù…Ø®Ø§Ø·Ø¨: ' + this.targetUser;
                    this.initP2P(false); // Ù…Ù† ÙÙ‚Ø· Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù‡Ù…
                }

                if (sig.from !== this.targetUser) continue;

                try {
                    if (sig.type === 'offer') {
                        await this.peer.setRemoteDescription(new RTCSessionDescription(sig.data));
                        const answer = await this.peer.createAnswer();
                        await this.peer.setLocalDescription(answer);
                        this.callAPI('sendSignal', {to: this.targetUser, from: this.me.id, type: 'answer', data: this.peer.localDescription});
                        this.processIceQueue(); // ØªØ²Ø±ÛŒÙ‚ ICE Ù‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
                    } 
                    else if (sig.type === 'answer') {
                        await this.peer.setRemoteDescription(new RTCSessionDescription(sig.data));
                        this.processIceQueue();
                    } 
                    else if (sig.type === 'ice') {
                        // ØµÙ Ø¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©ÙØ±ÙØ´ Ø´Ø¯Ù† Ù…Ø±ÙˆØ±Ú¯Ø±
                        if(this.peer.remoteDescription) {
                            await this.peer.addIceCandidate(new RTCIceCandidate(sig.data));
                        } else {
                            this.iceQueue.push(sig.data);
                        }
                    }
                } catch(err) { console.error("WebRTC Engine Error:", err); }
            }
        },

        processIceQueue: function() {
            while(this.iceQueue.length > 0) {
                const ice = this.iceQueue.shift();
                this.peer.addIceCandidate(new RTCIceCandidate(ice)).catch(e=>{});
            }
        },

        sendMsg: function() {
            if(!this.isOnline || !this.channel || this.channel.readyState !== 'open') {
                return this.toast('ØªÙˆÙ†Ù„ Ù‡Ù†ÙˆØ² Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª!');
            }
            
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            const msgId = Date.now().toString();
            const msgObj = { id: msgId, text: text, time: Date.now() };

            try {
                this.channel.send(JSON.stringify(msgObj));
                this.appendMsg(text, 'me', msgId, msgObj.time);
                input.value = '';
            } catch(e) { this.toast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø®Ù„ ØªÙˆÙ†Ù„'); }
        },

        appendMsg: function(text, type, id, time) {
            const box = document.getElementById('chat-box');
            const timeStr = new Date(time).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
            const ticks = type === 'me' ? `<span id="tick-${id}"><i class="ph ph-check"></i></span>` : '';

            box.innerHTML += `
            <div class="msg ${type}">
                <div>${text}</div>
                <div class="meta"><span>${timeStr}</span> ${ticks}</div>
            </div>`;
            box.scrollTop = box.scrollHeight;
        }
    };

    app.init();
</script>
</body>
</html>
