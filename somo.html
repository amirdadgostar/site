<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ú†Øª Ø§Ù…Ù† (P2P)</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <style>
        :root {
            --p: #25D366; 
            --pd: #128C7E;
            --bg: #ece5dd;
            --me: #dcf8c6;
            --other: #ffffff;
            --text: #303030;
            --gray: #888888;
            --font: 'Vazirmatn', sans-serif;
        }

        /* Ø±ÙØ¹ Ù…Ø´Ú©Ù„ ÙÛŒØª Ù†Ø´Ø¯Ù† Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); -webkit-tap-highlight-color: transparent; }
        body, html { 
            height: 100%; 
            height: 100dvh; /* Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            width: 100%;
            background-color: #f0f2f5; 
            color: var(--text); 
            overflow: hidden; 
            position: fixed; 
            top: 0; left: 0;
        }
        
        .hide { display: none !important; }

        /* Toast Notification */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #323232; color: white; padding: 12px 24px; border-radius: 8px; z-index: 9999; font-size: 0.9rem; opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: max-content; max-width: 90%; }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Auth Screen */
        #auth-screen { flex: 1; display: flex; justify-content: center; align-items: center; background: #f0f2f5; padding: 20px; z-index: 1000; position: absolute; inset: 0; }
        .auth-card { background: white; padding: 30px 25px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); width: 100%; max-width: 360px; text-align: center; }
        .auth-card i { font-size: 4rem; color: var(--p); margin-bottom: 10px; }
        .inp { width: 100%; padding: 14px 16px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 0.95rem; outline: none; transition: 0.2s; background: #fafafa; }
        .inp:focus { border-color: var(--p); background: white; }
        .btn { width: 100%; padding: 14px; background: var(--p); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:active { transform: scale(0.98); background: var(--pd); }
        .link-text { margin-top: 15px; font-size: 0.9rem; color: var(--pd); cursor: pointer; font-weight: 600; display: inline-block; }

        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Chat Screen */
        #chat-screen { display: flex; flex-direction: column; height: 100%; width: 100%; background: var(--bg); position: relative; }
        
        /* Header */
        header { background: var(--pd); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; height: 65px; flex-shrink: 0; }
        .head-info { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
        .avatar { width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; color: white; flex-shrink: 0; }
        .head-texts { display: flex; flex-direction: column; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .head-name { font-weight: bold; font-size: 1.05rem; }
        .head-status { font-size: 0.75rem; color: #e0e0e0; transition: 0.3s; }
        .head-status.online { color: #81c784; font-weight: bold; }
        .head-status.typing { color: #ffeb3b; }
        .head-actions { display: flex; gap: 10px; }
        .head-btn { background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; display: flex; align-items: center; }

        /* Chat Area */
        #chat-box { flex: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg-wrap { display: flex; width: 100%; }
        .msg-wrap.me { justify-content: flex-end; }
        .msg-wrap.other { justify-content: flex-start; }
        
        .msg { max-width: 85%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.me { background: var(--me); border-bottom-right-radius: 4px; }
        .msg.other { background: var(--other); border-bottom-left-radius: 4px; }
        
        .msg-media { max-width: 100%; border-radius: 8px; margin-bottom: 5px; max-height: 250px; object-fit: cover; }
        
        .msg-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 2px; }
        .msg-time { font-size: 0.65rem; color: var(--gray); }
        .msg-ticks { font-size: 0.85rem; color: var(--gray); display: flex; }
        .msg-ticks.read { color: #34b7f1; } 

        /* Input Area */
        .input-area { background: #f0f0f0; padding: 10px 15px; display: flex; gap: 10px; align-items: flex-end; z-index: 10; padding-bottom: max(10px, env(safe-area-inset-bottom)); flex-shrink: 0; border-top: 1px solid #ddd; }
        .attach-btn { background: transparent; border: none; color: var(--gray); font-size: 1.6rem; cursor: pointer; padding: 8px 0; display: flex; }
        .input-wrap { flex: 1; background: white; border-radius: 20px; padding: 0 15px; display: flex; align-items: center; min-height: 45px; }
        #msg-input { width: 100%; border: none; outline: none; font-size: 0.95rem; background: transparent; padding: 12px 0; max-height: 100px; resize: none; font-family: var(--font); }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--pd); color: white; border: none; font-size: 1.4rem; display: flex; justify-content: center; align-items: center; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .send-btn:active { transform: scale(0.9); }

        .empty-state { text-align: center; margin: auto; color: var(--gray); background: rgba(255,255,255,0.6); padding: 15px 20px; border-radius: 12px; font-size: 0.9rem; line-height: 1.8; }
    </style>
</head>
<body>

<div id="toast"><i class="ph ph-info"></i> <span id="toast-msg">Ù¾ÛŒØ§Ù…</span></div>

<div id="auth-screen">
    <div class="auth-card" id="login-box">
        <i class="ph-fill ph-shield-check"></i>
        <h2 style="margin-bottom: 20px; font-size: 1.4rem;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª Ø§Ù…Ù†</h2>
        <input type="text" id="l-id" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
        <input type="password" id="l-pass" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button class="btn" id="btn-login" onclick="app.login(this)"><span>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</span></button>
        <span class="link-text" onclick="app.toggleAuth()">Ø­Ø³Ø§Ø¨ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</span>
    </div>
    
    <div class="auth-card hide" id="reg-box">
        <i class="ph-fill ph-user-plus"></i>
        <h2 style="margin-bottom: 20px; font-size: 1.4rem;">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
        <input type="text" id="r-name" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§ (ÙØ§Ø±Ø³ÛŒ)">
        <input type="text" id="r-id" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
        <input type="password" id="r-pass" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button class="btn" id="btn-reg" onclick="app.register(this)"><span>Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨</span></button>
        <span class="link-text" onclick="app.toggleAuth()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</span>
    </div>
</div>

<div id="chat-screen" class="hide">
    <header>
        <div class="head-info">
            <div class="avatar"><i class="ph-fill ph-user"></i></div>
            <div class="head-texts">
                <span class="head-name" id="chat-with-name">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span>
                <span class="head-status" id="chat-status">Ù…Ù†ØªØ¸Ø± Ø§ØªØµØ§Ù„...</span>
            </div>
        </div>
        <div class="head-actions">
            <button class="head-btn" onclick="app.copyMyLink()" title="Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù…Ù†"><i class="ph ph-link"></i></button>
            <button class="head-btn" onclick="app.logout()" title="Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨"><i class="ph ph-sign-out"></i></button>
        </div>
    </header>

    <div id="chat-box"></div>

    <div class="input-area">
        <label class="attach-btn">
            <i class="ph ph-paperclip"></i>
            <input type="file" id="file-input" class="hide" onchange="app.sendFile(this)">
        </label>
        <div class="input-wrap">
            <input type="text" id="msg-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." oninput="app.sendTyping('text')" onkeypress="if(event.key==='Enter') app.sendMsg()">
        </div>
        <button class="send-btn" onclick="app.sendMsg()"><i class="ph-fill ph-paper-plane-right"></i></button>
    </div>
</div>

<script>
    // **********************************************************
    // Ù„ÛŒÙ†Ú© Web App Ú¯ÙˆÚ¯Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯:
    const API_URL = 'https://script.google.com/macros/s/AKfycbzUs7wbZvp4MRoC4twyvXMAZ_vmhX2rTeZCLXhor2f7VoBeWsV4QNyct3bwrW1svmunVQ/exec';
    // **********************************************************

    const app = {
        me: null,
        targetUser: null,
        peer: null,
        channel: null,
        signalingTimer: null,
        isOnline: false,
        typingTimeout: null,
        messages: [], 
        
        init: async function() {
            // Ø±ÙØ¹ Ø¨Ø§Ú¯ Routing: Ø§ÙˆÙ„ ÛŒÙˆ Ø¢Ø± Ø§Ù„ Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
            const urlParams = new URLSearchParams(window.location.search);
            const u = urlParams.get('u');

            const savedUser = await localforage.getItem('user');
            
            if (savedUser) {
                this.me = savedUser;
                document.getElementById('auth-screen').classList.add('hide');
                
                // Ù…Ù†Ø·Ù‚ Ø¯Ø±Ø³Øª ØªØ¹ÛŒÛŒÙ† Ù‡Ø¯Ù
                if(u) {
                    if(u.toLowerCase() === this.me.id.toLowerCase()) {
                        this.targetUser = null; // Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø®ÙˆØ¯Ù…Ù‡
                    } else {
                        this.targetUser = u.toLowerCase(); // Ù„ÛŒÙ†Ú© ÛŒÚ©ÛŒ Ø¯ÛŒÚ¯Ø³Øª
                    }
                } else {
                    this.targetUser = null; // Ù„ÛŒÙ†Ú©ÛŒ Ø¯Ø± Ú©Ø§Ø± Ù†ÛŒØ³Øª
                }
                
                this.checkTarget();
            } else {
                // Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ù†Ø¨ÙˆØ¯ØŒ Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø±Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ† Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø´Ù‡
                if(u) sessionStorage.setItem('pendingTarget', u);
            }
        },

        logout: async function() {
            if(confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
                clearInterval(this.signalingTimer);
                if(this.peer) this.peer.close();
                await localforage.removeItem('user');
                window.location.href = location.origin + location.pathname; // Ø±ÙØ±Ø´ ØªÙ…ÛŒØ² Ø¨Ø¯ÙˆÙ† Ù¾Ø§Ø±Ø§Ù…ØªØ±
            }
        },

        showToast: function(msg, type = 'info') {
            const t = document.getElementById('toast');
            let icon = '<i class="ph ph-info"></i>';
            if(type === 'error') { icon = '<i class="ph ph-warning-circle"></i>'; t.style.background = '#e53935'; }
            else if(type === 'success') { icon = '<i class="ph ph-check-circle"></i>'; t.style.background = '#43a047'; }
            else { t.style.background = '#323232'; }
            
            t.innerHTML = `${icon} <span>${msg}</span>`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        },

        setLoading: function(btn, isLoading, originalText) {
            if(isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div>';
            } else {
                btn.disabled = false;
                btn.innerHTML = `<span>${originalText}</span>`;
            }
        },

        toggleAuth: () => {
            document.getElementById('login-box').classList.toggle('hide');
            document.getElementById('reg-box').classList.toggle('hide');
        },

        callAPI: async function(act, payload) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', body: JSON.stringify({action: act, payload: payload})
                });
                return await res.json();
            } catch(e) {
                return {status: 'error', msg: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'};
            }
        },

        login: async function(btn) {
            const id = document.getElementById('l-id').value;
            const pass = document.getElementById('l-pass').value;
            if(!id || !pass) return this.showToast('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
            
            this.setLoading(btn, true, 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…');
            const res = await this.callAPI('login', {id, pass});
            this.setLoading(btn, false, 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…');

            if(res.status === 'success') {
                this.me = res.user;
                await localforage.setItem('user', this.me);
                
                // Ú†Ú© Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
                const pending = sessionStorage.getItem('pendingTarget');
                if(pending && pending.toLowerCase() !== this.me.id.toLowerCase()) {
                    this.targetUser = pending.toLowerCase();
                    sessionStorage.removeItem('pendingTarget');
                }

                document.getElementById('auth-screen').classList.add('hide');
                this.checkTarget();
            } else {
                this.showToast(res.msg, 'error');
            }
        },

        register: async function(btn) {
            const name = document.getElementById('r-name').value;
            const id = document.getElementById('r-id').value;
            const pass = document.getElementById('r-pass').value;
            
            if(!name || !id || !pass) return this.showToast('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');

            this.setLoading(btn, true, 'Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨');
            const res = await this.callAPI('register', {name, id, pass});
            this.setLoading(btn, false, 'Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨');

            if(res.status === 'success') {
                this.me = res.user;
                await localforage.setItem('user', this.me);
                
                const pending = sessionStorage.getItem('pendingTarget');
                if(pending && pending.toLowerCase() !== this.me.id.toLowerCase()) {
                    this.targetUser = pending.toLowerCase();
                    sessionStorage.removeItem('pendingTarget');
                }

                document.getElementById('auth-screen').classList.add('hide');
                this.checkTarget();
            } else {
                this.showToast(res.msg, 'error');
            }
        },

        copyMyLink: function() {
            const link = location.origin + location.pathname + '?u=' + this.me.id;
            if(navigator.clipboard) {
                navigator.clipboard.writeText(link).then(()=> this.showToast('Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ú©Ù¾ÛŒ Ø´Ø¯!', 'success'));
            } else {
                prompt('Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨ÙØ±Ø³ØªÛŒØ¯:', link);
            }
        },

        checkTarget: async function() {
            document.getElementById('chat-screen').classList.remove('hide');
            const headName = document.getElementById('chat-with-name');
            const headStatus = document.getElementById('chat-status');

            if(!this.targetUser) {
                headName.innerText = this.me.name + ' (Ø´Ù…Ø§)';
                headStatus.innerText = 'Ù…Ù†ØªØ¸Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø§Ø² Ù…Ø®Ø§Ø·Ø¨...';
                headStatus.className = 'head-status';
                document.getElementById('chat-box').innerHTML = `
                    <div class="empty-state">
                        <i class="ph-fill ph-link" style="font-size:3rem; margin-bottom:10px; color:var(--p)"></i><br>
                        Ø´Ù…Ø§ Ø¯Ø± ØµÙØ­Ù‡ Ø´Ø®ØµÛŒ Ø®ÙˆØ¯ØªØ§Ù† Ù‡Ø³ØªÛŒØ¯.<br>
                        Ø¨Ø±Ø§ÛŒ Ú†Øª Ú©Ø±Ø¯Ù†ØŒ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø®ÙˆØ¯ Ø±Ø§ (Ø§Ø² Ø¢ÛŒÚ©ÙˆÙ† ğŸ”— Ø¨Ø§Ù„Ø§) Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØªØ§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯ØŒ<br>
                        ÛŒØ§ Ù„ÛŒÙ†Ú© Ø¯ÙˆØ³ØªØªØ§Ù† Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.
                    </div>`;
                
                // Ø´Ø±ÙˆØ¹ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø³ÛŒ Ø¨Ù‡ Ù…Ø§ ÙˆØµÙ„ Ø¨Ø´Ù‡
                if(!this.signalingTimer) this.signalingTimer = setInterval(() => this.pollSignals(), 3000);
                return;
            }
            
            headName.innerText = 'Ù…Ø®Ø§Ø·Ø¨: ' + this.targetUser;
            headStatus.innerText = 'Ø¢ÙÙ„Ø§ÛŒÙ† ğŸ”´ (Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„...)';
            
            this.messages = await localforage.getItem('chat_' + this.targetUser) || [];
            this.renderChat();
            
            // Ø§Ú¯Ø± Ù‡Ø¯Ù Ù…Ø´Ø®Øµ Ø¨ÙˆØ¯ØŒ ÙÙˆØ±Ø§Ù‹ ØªÙˆÙ†Ù„ Ø±Ø§ Ù…ÛŒØ³Ø§Ø²ÛŒÙ…
            this.initWebRTC(true);
        },

        // Ø±ÙØ¹ Ø¨Ø§Ú¯ ØªÙˆÙ†Ù„ WebRTC
        initWebRTC: function(isInitiator) {
            // Ø¨Ø³ØªÙ† Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª
            if (this.peer) {
                this.peer.onicecandidate = null;
                this.peer.ondatachannel = null;
                this.peer.close();
            }

            this.peer = new RTCPeerConnection({ iceServers: [{urls: 'stun:stun.l.google.com:19302'}] });

            if (isInitiator) {
                this.channel = this.peer.createDataChannel('chat');
                this.setupChannel(this.channel);
            }

            this.peer.ondatachannel = (event) => {
                this.channel = event.channel;
                this.setupChannel(this.channel);
            };

            this.peer.onicecandidate = (e) => {
                if (e.candidate && this.targetUser) {
                    this.callAPI('sendSignal', {to: this.targetUser, from: this.me.id, type: 'ice', data: e.candidate});
                }
            };

            if (isInitiator) {
                this.peer.createOffer()
                    .then(offer => this.peer.setLocalDescription(offer))
                    .then(() => {
                        this.callAPI('sendSignal', {to: this.targetUser, from: this.me.id, type: 'offer', data: this.peer.localDescription});
                    });
            }

            if(!this.signalingTimer) {
                this.signalingTimer = setInterval(() => this.pollSignals(), 3000);
            }
        },

        setupChannel: function(channel) {
            channel.onopen = () => {
                this.isOnline = true;
                const statusEl = document.getElementById('chat-status');
                statusEl.innerText = 'Ø¢Ù†Ù„Ø§ÛŒÙ†';
                statusEl.className = 'head-status online';
                
                // ÙˆÙ‚ØªÛŒ ÙˆØµÙ„ Ø´Ø¯ÛŒÙ…ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø±Ø§ Ù‚Ø·Ø¹ Ù…ÛŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø³Ø±Ø¹Øª Ú©Ù… Ù†Ø´Ù‡
                clearInterval(this.signalingTimer); 
                this.signalingTimer = null;
                
                this.syncPendingMessages(); 
            };
            
            channel.onclose = () => {
                this.isOnline = false;
                const statusEl = document.getElementById('chat-status');
                statusEl.innerText = 'Ø¢ÙÙ„Ø§ÛŒÙ† ğŸ”´ (Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...)';
                statusEl.className = 'head-status';
                
                // Ø§Ú¯Ù‡ Ù‚Ø·Ø¹ Ø´Ø¯ÛŒÙ…ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ù…ÛŒÚ©Ù†ÛŒÙ… Ø¨Ù‡ Ú¯Ø´ØªÙ† Ø¯Ù†Ø¨Ø§Ù„Ø´
                if(!this.signalingTimer) {
                    this.signalingTimer = setInterval(() => this.pollSignals(), 3000);
                }
                if (this.targetUser) this.initWebRTC(true); 
            };

            channel.onmessage = (e) => {
                const data = JSON.parse(e.data);
                
                if (data.sys) {
                    if (data.act === 'typing') this.showTyping(data.mode);
                    if (data.act === 'read') this.markAsRead(data.msgId);
                    return;
                }

                data.status = 'read'; 
                this.messages.push(data);
                this.saveDb();
                this.renderChat();
                
                // Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ© Ø¢Ø¨ÛŒ Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡
                if(this.channel.readyState === 'open') {
                    this.channel.send(JSON.stringify({sys: true, act: 'read', msgId: data.id}));
                }
            };
        },

        pollSignals: async function() {
            const res = await this.callAPI('getSignals', {me: this.me.id});
            if (!res.signals || res.signals.length === 0) return;

            // Ø±ÙØ¹ Ø¨Ø§Ú¯ ØªØ¯Ø§Ø®Ù„: Ø§ÙˆÙ„ offer Ù‡Ø§ØŒ Ø¨Ø¹Ø¯ answer Ù‡Ø§ØŒ Ø¨Ø¹Ø¯ ice Ù‡Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒØ´Ù†
            const sortOrder = { 'offer': 1, 'answer': 2, 'ice': 3 };
            res.signals.sort((a, b) => sortOrder[a.type] - sortOrder[b.type]);

            for (let sig of res.signals) {
                // Ø§Ú¯Ø± Ø´Ø®ØµÛŒ Ù†Ø§Ø´Ù†Ø§Ø³ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§ØªØµØ§Ù„ Ø¯Ø§Ø¯
                if (!this.targetUser && sig.type === 'offer') {
                    this.targetUser = sig.from;
                    document.getElementById('chat-with-name').innerText = 'Ù…Ø®Ø§Ø·Ø¨: ' + this.targetUser;
                    this.messages = await localforage.getItem('chat_' + this.targetUser) || [];
                    this.renderChat();
                    this.initWebRTC(false); // Ù…Ù† Ø´Ø±ÙˆØ¹ Ú©Ù†Ù†Ø¯Ù‡ Ù†ÛŒØ³ØªÙ…ØŒ ÙÙ‚Ø· Ø¬ÙˆØ§Ø¨ Ù…ÛŒØ¯Ù…
                }

                if (sig.from !== this.targetUser) continue;

                try {
                    if (sig.type === 'offer') {
                        await this.peer.setRemoteDescription(new RTCSessionDescription(sig.data));
                        const answer = await this.peer.createAnswer();
                        await this.peer.setLocalDescription(answer);
                        this.callAPI('sendSignal', {to: this.targetUser, from: this.me.id, type: 'answer', data: this.peer.localDescription});
                    } 
                    else if (sig.type === 'answer') {
                        await this.peer.setRemoteDescription(new RTCSessionDescription(sig.data));
                    } 
                    else if (sig.type === 'ice') {
                        // ÙÙ‚Ø· Ø§Ú¯Ù‡ Remote Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù‡ Ù…ÛŒØ´Ù‡ ICE Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯
                        if(this.peer.remoteDescription) {
                            await this.peer.addIceCandidate(new RTCIceCandidate(sig.data));
                        }
                    }
                } catch(err) {
                    console.error("WebRTC Error:", err);
                }
            }
        },

        sendMsg: function(textParam, mediaObj) {
            if(!this.targetUser) return this.showToast('Ù‡Ù†ÙˆØ² Ø¨Ù‡ Ù…Ø®Ø§Ø·Ø¨ÛŒ Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯', 'error');
            
            const input = document.getElementById('msg-input');
            const text = textParam || input.value.trim();
            if (!text && !mediaObj) return;

            const msg = {
                id: Date.now().toString(),
                sender: this.me.id,
                text: text,
                media: mediaObj || null,
                time: Date.now(),
                status: 'wait' 
            };

            this.messages.push(msg);
            this.saveDb();
            this.renderChat();
            input.value = '';

            this.dispatchMessage(msg);
        },

        dispatchMessage: function(msg) {
            if (this.isOnline && this.channel && this.channel.readyState === 'open') {
                try {
                    this.channel.send(JSON.stringify(msg));
                    msg.status = 'sent'; 
                    this.saveDb();
                    this.renderChat();
                } catch(e) {}
            }
        },

        syncPendingMessages: function() {
            let changed = false;
            this.messages.forEach(m => {
                if (m.sender === this.me.id && m.status === 'wait') {
                    this.dispatchMessage(m);
                    changed = true;
                }
            });
            if(changed) this.renderChat();
        },

        sendFile: function(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) return this.showToast('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² 2 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯', 'error');
            
            this.sendTyping('file'); 
            const reader = new FileReader();
            reader.onload = (e) => {
                let type = 'file';
                if(file.type.startsWith('image')) type = 'image';
                else if(file.type.startsWith('video')) type = 'video';
                else if(file.type.startsWith('audio')) type = 'audio';

                this.sendMsg('', {type: type, data: e.target.result, name: file.name});
            };
            reader.readAsDataURL(file);
        },

        sendTyping: function(mode) {
            if (this.isOnline && this.channel && this.channel.readyState === 'open') {
                this.channel.send(JSON.stringify({sys: true, act: 'typing', mode: mode}));
            }
        },

        showTyping: function(mode) {
            const statusEl = document.getElementById('chat-status');
            let txt = 'Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†... âœï¸';
            if(mode === 'image') txt = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³... ğŸ“·';
            if(mode === 'audio') txt = 'Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø· ØµØ¯Ø§... ğŸ¤';
            if(mode === 'file') txt = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„... ğŸ“';
            
            statusEl.innerText = txt;
            statusEl.className = 'head-status typing';
            
            clearTimeout(this.typingTimeout);
            this.typingTimeout = setTimeout(() => { 
                statusEl.innerText = this.isOnline ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ† ğŸ”´';
                statusEl.className = this.isOnline ? 'head-status online' : 'head-status';
            }, 2000);
        },

        markAsRead: function(msgId) {
            const m = this.messages.find(x => x.id === msgId);
            if(m && m.status !== 'read') { 
                m.status = 'read'; 
                this.saveDb(); 
                this.renderChat(); 
            }
        },

        saveDb: function() {
            if(this.targetUser) localforage.setItem('chat_' + this.targetUser, this.messages);
        },

        renderChat: function() {
            const box = document.getElementById('chat-box');
            let html = '';
            
            if(this.messages.length === 0 && this.targetUser) {
                html = '<div class="empty-state">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.<br>Ø¨Ù‡ Ù…Ø­Ø¶ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯Ù† Ù…Ø®Ø§Ø·Ø¨ØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>';
            }

            this.messages.forEach(m => {
                const isMe = m.sender === this.me.id;
                
                let ticks = '';
                if(isMe) {
                    if(m.status === 'wait') ticks = '<i class="ph ph-clock"></i>';
                    else if(m.status === 'sent') ticks = '<i class="ph ph-check"></i>';
                    else if(m.status === 'read') ticks = '<i class="ph-fill ph-checks"></i>';
                }

                let mediaHtml = '';
                if (m.media) {
                    if(m.media.type === 'image') mediaHtml = `<img src="${m.media.data}" class="msg-media">`;
                    else if(m.media.type === 'video') mediaHtml = `<video src="${m.media.data}" controls class="msg-media"></video>`;
                    else if(m.media.type === 'audio') mediaHtml = `<audio src="${m.media.data}" controls style="width:100%; height:40px; margin-bottom:5px;"></audio>`;
                    else mediaHtml = `<a href="${m.media.data}" download="${m.media.name}" style="display:block; margin-bottom:5px; text-decoration:none; color:var(--pd);"><i class="ph-fill ph-file-text"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ ${m.media.name}</a>`;
                }

                const timeStr = new Date(m.time).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});

                html += `
                <div class="msg-wrap ${isMe ? 'me' : 'other'}">
                    <div class="msg ${isMe ? 'me' : 'other'}">
                        ${mediaHtml}
                        ${m.text ? `<div style="white-space:pre-wrap;">${m.text}</div>` : ''}
                        <div class="msg-meta">
                            <span class="msg-time">${timeStr}</span>
                            <span class="msg-ticks ${m.status}">${ticks}</span>
                        </div>
                    </div>
                </div>`;
            });
            
            if(box.innerHTML !== html) {
                box.innerHTML = html;
                box.scrollTop = box.scrollHeight;
            }
        }
    };

    app.init();
</script>
</body>
</html>
