<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --primary: #4f46e5; --bg-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --white: #ffffff; --text: #1e293b;
        }
        body {
            font-family: 'Vazirmatn', sans-serif; margin: 0; padding: 20px;
            min-height: 100vh; display: flex; justify-content: center; align-items: flex-start;
            /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Mesh Gradient */
            background-color: #e0e7ff;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: cover; background-attachment: fixed;
        }
        
        .container { 
            width: 100%; max-width: 600px; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); padding: 40px; border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            margin-top: 30px; animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader Ø¬Ø¯ÛŒØ¯ Infinity Pulse */
        .loader-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .pulse-loader {
            width: 80px; height: 80px; border-radius: 50%; background: white;
            animation: pulse 1.5s infinite ease-in-out;
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 30px rgba(255, 255, 255, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        .loading-text { color: white; margin-top: 20px; font-weight: 300; letter-spacing: 1px; font-size: 1.1rem; }

        /* Success View */
        .success-view { text-align: center; display: none; padding: 20px; }
        .success-icon {
            width: 80px; height: 80px; background: #d1fae5; color: #10b981;
            border-radius: 50%; font-size: 40px; display: flex; justify-content: center; align-items: center;
            margin: 0 auto 20px; animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* Form Styling */
        h1 { text-align: center; color: var(--text); margin-bottom: 10px; }
        .desc { background: #f1f5f9; padding: 15px; border-radius: 12px; color: #64748b; line-height: 1.6; margin-bottom: 30px; text-align: center; font-size: 0.95rem; }

        label { display: block; font-weight: 700; color: #334155; margin-bottom: 8px; margin-top: 20px; }
        .req { color: #ef4444; margin-right: 4px; }

        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px;
            font-family: inherit; font-size: 1rem; transition: 0.3s; background: #fff; box-sizing: border-box;
        }
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        input.error { border-color: #ef4444; }
        .err-msg { color: #ef4444; font-size: 0.8rem; margin-top: 5px; display: none; }

        .submit-btn {
            width: 100%; padding: 16px; background: linear-gradient(135deg, #4f46e5, #4338ca);
            color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; margin-top: 30px; transition: 0.2s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4); }

        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-reload { flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; }
        .btn-close { flex: 1; padding: 12px; background: #e2e8f0; color: #334155; border: none; border-radius: 10px; cursor: pointer; }
        
        .opt-label { display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .opt-label:hover { border-color: var(--primary); background: #f8fafc; }
        .opt-label input { margin-left: 10px; width: 18px; height: 18px; accent-color: var(--primary); }
    </style>
</head>
<body>

<div class="loader-container" id="loader">
    <div class="pulse-loader"></div>
    <div class="loading-text">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...</div>
</div>

<div class="container" id="main-container" style="display:none;">
    
    <!-- ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
    <div id="form-view">
        <h1 id="f-title"></h1>
        <div id="f-desc" class="desc"></div>
        <form id="dynamic-form" onsubmit="event.preventDefault(); validateAndSend();"></form>
    </div>

    <!-- Ù†Ù…Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØª (Ù…Ø®ÙÛŒ) -->
    <div id="success-view" class="success-view">
        <div class="success-icon">âœ“</div>
        <h2>Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙÙ‚!</h2>
        <p style="color:#64748b;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø³Ø§Ù…Ø§Ù†Ù‡ Ø«Ø¨Øª Ø´Ø¯.</p>
        <div class="action-btns">
            <button onclick="location.reload()" class="btn-reload">Ù¾Ø± Ú©Ø±Ø¯Ù† Ù…Ø¬Ø¯Ø¯</button>
            <button onclick="closeApp()" class="btn-close">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>
    
    <!-- Ø­Ø§Ù„Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ -->
    <div id="closed-view" style="display:none; text-align:center;">
        <div class="success-icon" style="background:#e0e7ff; color:var(--primary)">âœ“</div>
        <h3>ÙØ±Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯</h3>
    </div>

    <!-- Ù„ÛŒØ³Øª ÙØ±Ù…â€ŒÙ‡Ø§ (Ø§Ú¯Ø± Ø¢Ø¯Ø±Ø³ Ø¨Ø¯ÙˆÙ† ID Ø¨Ø§Ø´Ø¯) -->
    <div id="list-view" style="display:none;">
        <h2 style="text-align:center;">ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h2>
        <div id="forms-list"></div>
    </div>
</div>

<script>
    // ğŸ‘‡ğŸ‘‡ Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 

    init();

    function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get('id');
        const container = document.getElementById('main-container');

        if (formId) {
            showLoader(true);
            fetch(`${API_URL}?action=getForm&formId=${formId}`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                if (data.status === 'success') {
                    renderForm(data.structure, formId);
                } else {
                    container.innerHTML = "<h3 style='text-align:center; padding:40px;'>âš ï¸ ÙØ±Ù… ÛŒØ§ÙØª Ù†Ø´Ø¯.</h3>";
                }
            })
            .catch(() => { showLoader(false); container.innerHTML = "<h3 style='text-align:center'>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</h3>"; });
        } else {
            showLoader(true);
            document.getElementById('form-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'block';
            
            fetch(`${API_URL}?action=getFormList`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                const listDiv = document.getElementById('forms-list');
                if(data.status==='success' && data.list.length > 0) {
                    data.list.forEach(f => {
                        listDiv.innerHTML += `<div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;" onclick="location.href='?id=${f.id}'"><strong>${f.title}</strong></div>`;
                    });
                } else listDiv.innerHTML = "<p style='text-align:center'>ÙØ±Ù…ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>";
            });
        }
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

    function renderForm(data, id) {
        document.getElementById('f-title').innerText = data.title;
        document.getElementById('f-desc').innerText = data.description || "Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø¨Ø§ Ø¯Ù‚Øª ØªÚ©Ù…ÛŒÙ„ Ù†Ù…Ø§ÛŒÛŒØ¯.";
        const form = document.getElementById('dynamic-form');
        form.setAttribute('data-id', id);

        data.fields.forEach(f => {
            const div = document.createElement('div');
            const reqMark = f.required ? '<span class="req">*</span>' : '';
            const reqAttr = f.required ? 'required' : '';

            if (f.type === 'static') {
                div.innerHTML = `<div style="background:#e0f2fe; color:#0369a1; padding:15px; border-radius:10px; margin:20px 0;">${f.content}</div>`;
            } else {
                div.innerHTML = `<label>${f.label} ${reqMark}</label>`;
                
                // ÙÛŒÙ„Ø¯ Ù…ØªÙ†ÛŒØŒ Ø¹Ø¯Ø¯ØŒ ØªÙˆØ¶ÛŒØ­Ø§Øª
                if (['short_text', 'long_text', 'number'].includes(f.type)) {
                    let tag = f.type === 'long_text' ? 'textarea' : 'input';
                    let type = f.type === 'short_text' ? 'text' : (f.type==='long_text'?'':'number');
                    let attrs = type ? `type="${type}"` : 'rows="4"';
                    div.innerHTML += `<${tag} ${attrs} name="${f.label}" class="input-field" ${reqAttr}></${tag}>`;
                }
                // Ú©Ø¯ Ù…Ù„ÛŒ
                else if (f.type === 'national_code') {
                    div.innerHTML += `<input type="number" name="${f.label}" class="input-field national-code" placeholder="10 Ø±Ù‚Ù…" ${reqAttr} oninput="checkNational(this)">
                                      <div class="err-msg">Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª</div>`;
                }
                // Ù…ÙˆØ¨Ø§ÛŒÙ„
                else if (f.type === 'phone') {
                    div.innerHTML += `<input type="number" name="${f.label}" class="input-field phone-num" placeholder="09xxxxxxxxx" ${reqAttr} oninput="checkPhone(this)">
                                      <div class="err-msg">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯ Ùˆ Ø¨Ø§ 09 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯</div>`;
                }
                // Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                else if (f.type.includes('choice')) {
                    let type = f.type === 'single_choice' ? 'radio' : 'checkbox';
                    f.options.forEach((opt, i) => {
                        let r = (f.type === 'single_choice' && f.required && i===0) ? 'required' : '';
                        div.innerHTML += `<label class="opt-label"><input type="${type}" name="${f.label}" value="${opt}" ${r}><span>${opt}</span></label>`;
                    });
                }
            }
            form.appendChild(div);
        });

        const btn = document.createElement('button');
        btn.type = 'submit'; btn.className = 'submit-btn'; btn.innerText = 'Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª';
        form.appendChild(btn);
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒâ€ŒÙ‡Ø§
    function checkNational(input) {
        const val = input.value;
        const err = input.nextElementSibling;
        if (!isValidNationalCode(val)) {
            input.classList.add('error');
            err.style.display = 'block';
            return false;
        } else {
            input.classList.remove('error');
            err.style.display = 'none';
            return true;
        }
    }

    function isValidNationalCode(code) {
        if (!/^\d{10}$/.test(code)) return false;
        const check = +code[9];
        const sum = code.split('').slice(0, 9).reduce((acc, x, i) => acc + +x * (10 - i), 0) % 11;
        return sum < 2 ? check === sum : check === 11 - sum;
    }

    function checkPhone(input) {
        const val = input.value;
        const err = input.nextElementSibling;
        if (!/^09\d{9}$/.test(val)) {
            input.classList.add('error');
            err.style.display = 'block';
            return false;
        } else {
            input.classList.remove('error');
            err.style.display = 'none';
            return true;
        }
    }

    function validateAndSend() {
        const form = document.getElementById('dynamic-form');
        let isValid = true;
        
        // Ú†Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø®Ø§Øµ
        const nats = form.querySelectorAll('.national-code');
        nats.forEach(n => { if(!checkNational(n)) isValid = false; });
        
        const phones = form.querySelectorAll('.phone-num');
        phones.forEach(p => { if(!checkPhone(p)) isValid = false; });

        if (!isValid) return alert("Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±Ù… Ø±Ø§ Ø¨Ø±Ø·Ø±Ù Ú©Ù†ÛŒØ¯.");

        const id = form.getAttribute('data-id');
        const formData = new FormData(form);
        let ans = {};
        for (let [key, val] of formData.entries()) {
            if (ans[key]) ans[key] += ", " + val; else ans[key] = val;
        }

        const btn = document.querySelector('.submit-btn');
        const orgText = btn.innerText;
        btn.innerText = "Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´..."; btn.disabled = true;
        showLoader(true);

        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "submitResponse", formId: id, answers: ans }) })
        .then(r => r.json()).then(d => {
            showLoader(false);
            if(d.status === 'success') {
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª
                document.getElementById('form-view').style.display = 'none';
                document.getElementById('success-view').style.display = 'block';
            } else {
                alert("Ø®Ø·Ø§: " + d.message);
                btn.innerText = orgText; btn.disabled = false;
            }
        }).catch(() => {
            showLoader(false); alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·");
            btn.innerText = orgText; btn.disabled = false;
        });
    }

    function closeApp() {
        document.getElementById('success-view').style.display = 'none';
        document.getElementById('closed-view').style.display = 'block';
    }
</script>
</body>
</html>
