
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ±Ù… Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --primary: #4f46e5; --bg: #f3f4f6; --text: #111827; --white: #ffffff;
        }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; padding: 20px; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; }
        
        .container { 
            width: 100%; max-width: 650px; background: var(--white); 
            padding: 40px; border-radius: 20px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease;
            position: relative;
            margin-top: 20px;
        }

        /* --- Modern Cube Loader --- */
        .loader-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .cube-loader {
            width: 70px; height: 70px; position: relative; transform-style: preserve-3d;
            animation: cube-spin 1.5s infinite linear;
        }
        .cube-face {
            position: absolute; width: 70px; height: 70px; background: rgba(79, 70, 229, 0.2);
            border: 2px solid var(--primary);
        }
        .cube-face:nth-child(1) { transform: translateZ(35px); }
        .cube-face:nth-child(2) { transform: rotateY(180deg) translateZ(35px); }
        .cube-face:nth-child(3) { transform: rotateY(90deg) translateZ(35px); }
        .cube-face:nth-child(4) { transform: rotateY(-90deg) translateZ(35px); }
        .cube-face:nth-child(5) { transform: rotateX(90deg) translateZ(35px); }
        .cube-face:nth-child(6) { transform: rotateX(-90deg) translateZ(35px); }
        
        @keyframes cube-spin {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        .loading-text { margin-top: 20px; font-weight: bold; color: var(--primary); letter-spacing: 1px; }

        /* --- Success Modal --- */
        .success-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 10000;
            justify-content: center; align-items: center;
        }
        .success-card {
            background: white; padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .checkmark { width: 80px; height: 80px; background: #d1fae5; color: #10b981; border-radius: 50%; font-size: 40px; display: flex; justify-content: center; align-items: center; margin: 0 auto 20px; }
        
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Form Elements --- */
        #f-title { font-size: 1.8rem; color: var(--text); margin-bottom: 10px; text-align: center; }
        #f-desc { color: #6b7280; text-align: center; margin-bottom: 30px; line-height: 1.6; background: #f9fafb; padding: 15px; border-radius: 12px; }
        
        label { display: block; font-weight: 700; color: #374151; margin-bottom: 8px; margin-top: 20px; }
        
        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px;
            font-family: inherit; font-size: 1rem; transition: all 0.3s;
            box-sizing: border-box; background: #f9fafb;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        
        .submit-btn {
            width: 100%; padding: 16px; background: linear-gradient(135deg, #4f46e5, #4338ca);
            color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; margin-top: 30px; transition: transform 0.2s, box-shadow 0.2s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        .submit-btn:active { transform: translateY(0); }

        /* Option Inputs */
        .option-label { display: flex; align-items: center; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { background: #f3f4f6; border-color: var(--primary); }
        .option-label input { margin-left: 10px; width: 18px; height: 18px; accent-color: var(--primary); }

        /* Fallback List View */
        .list-view-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 1px solid #eee; display: flex; justify-content: space-between; }
        .list-view-item:hover { border-color: var(--primary); background: #f9fafb; }
    </style>
</head>
<body>

<!-- Cube Loader -->
<div class="loader-container" id="loader">
    <div class="cube-loader">
        <div class="cube-face"></div><div class="cube-face"></div><div class="cube-face"></div>
        <div class="cube-face"></div><div class="cube-face"></div><div class="cube-face"></div>
    </div>
    <div class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ±Ù…...</div>
</div>

<!-- Success Modal -->
<div class="success-modal" id="successModal">
    <div class="success-card">
        <div class="checkmark">âœ“</div>
        <h2 style="margin:0 0 10px 0;">Ø«Ø¨Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²</h2>
        <p style="color:#666;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.</p>
        <button onclick="location.reload()" class="submit-btn" style="margin-top:20px; padding:10px;">Ø¨Ø§Ø´Ù‡</button>
    </div>
</div>

<!-- Main Content -->
<div class="container" id="main-container" style="display:none;">
    
    <!-- Single Form View -->
    <div id="single-form-view">
        <h1 id="f-title"></h1>
        <div id="f-desc"></div>
        <form id="dynamic-form"></form>
    </div>

    <!-- Fallback List View (Only if no ID provided) -->
    <div id="list-view" style="display:none;">
        <h2>Ù„ÛŒØ³Øª ÙØ±Ù…â€ŒÙ‡Ø§</h2>
        <div id="forms-list"></div>
    </div>

</div>

<script>
    // ğŸ‘‡ğŸ‘‡ Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 

    // Ø´Ø±ÙˆØ¹
    init();

    function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get('id');
        const container = document.getElementById('main-container');

        if (formId) {
            // Ø­Ø§Ù„Øª 1: Ù†Ù…Ø§ÛŒØ´ ØªÚ©ÛŒ ÙØ±Ù… (ÙˆÙ‚ØªÛŒ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø§Ø³Øª)
            showLoader(true);
            fetch(`${API_URL}?action=getForm&formId=${formId}`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                if (data.status === 'success') {
                    renderForm(data.structure, formId);
                } else {
                    container.innerHTML = "<h3 style='text-align:center'>ÙØ±Ù…ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</h3>";
                }
            })
            .catch(() => { showLoader(false); container.innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„"; });
        } else {
            // Ø­Ø§Ù„Øª 2: Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª (Ø§Ú¯Ø± Ù„ÛŒÙ†Ú©ÛŒ Ø¨Ø¯ÙˆÙ† ID Ø¨Ø§Ø² Ø´Ø¯)
            showLoader(true);
            document.getElementById('single-form-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'block';
            
            fetch(`${API_URL}?action=getFormList`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                const listDiv = document.getElementById('forms-list');
                if(data.status==='success' && data.list.length > 0) {
                    data.list.forEach(f => {
                        listDiv.innerHTML += `<div class="list-view-item" onclick="location.href='?id=${f.id}'">
                            <strong>${f.title}</strong><span>â†</span></div>`;
                    });
                } else listDiv.innerHTML = "ÙØ±Ù…ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª";
            });
        }
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    function renderForm(data, id) {
        document.getElementById('f-title').innerText = data.title;
        document.getElementById('f-desc').innerText = data.description;
        const form = document.getElementById('dynamic-form');
        form.setAttribute('data-id', id);

        data.fields.forEach(f => {
            const div = document.createElement('div');
            if (f.type === 'static') {
                div.innerHTML = `<div style="background:#e0f2fe; color:#0c4a6e; padding:15px; border-radius:10px; margin:20px 0; line-height:1.5">${f.content}</div>`;
            } else {
                div.innerHTML = `<label>${f.label}</label>`;
                
                if (['short_text', 'long_text', 'number', 'national_code', 'phone'].includes(f.type)) {
                    let type = f.type === 'short_text' ? 'text' : (f.type === 'long_text' ? 'textarea' : 'number');
                    let tag = f.type === 'long_text' ? 'textarea' : 'input';
                    let attrs = type === 'textarea' ? 'rows="4"' : `type="${type}"`;
                    div.innerHTML += `<${tag} ${attrs} name="${f.label}" class="input-field"></${tag}>`;
                }
                else if (f.type === 'single_choice' || f.type === 'multi_choice') {
                    let type = f.type === 'single_choice' ? 'radio' : 'checkbox';
                    f.options.forEach(opt => {
                        div.innerHTML += `<label class="option-label">
                            <input type="${type}" name="${f.label}" value="${opt}">
                            <span>${opt}</span>
                        </label>`;
                    });
                }
            }
            form.appendChild(div);
        });

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'submit-btn';
        btn.innerText = 'Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª';
        btn.onclick = sendData;
        form.appendChild(btn);
    }

    function sendData() {
        const form = document.getElementById('dynamic-form');
        const id = form.getAttribute('data-id');
        const formData = new FormData(form);
        let ans = {};
        
        for (let [key, val] of formData.entries()) {
            if (ans[key]) ans[key] += ", " + val; else ans[key] = val;
        }

        const btn = document.querySelector('.submit-btn');
        btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„..."; btn.disabled = true;
        
        // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ø­ÛŒÙ† Ø§Ø±Ø³Ø§Ù„
        showLoader(true);

        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "submitResponse", formId: id, answers: ans }) })
        .then(r => r.json()).then(d => {
            showLoader(false);
            if(d.status === 'success') {
                document.getElementById('successModal').style.display = 'flex';
            } else {
                alert("Ø®Ø·Ø§: " + d.message);
                btn.innerText = "Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª"; btn.disabled = false;
            }
        }).catch(() => {
            showLoader(false); alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·");
            btn.innerText = "Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª"; btn.disabled = false;
        });
    }
</script>
</body>
</html>
