<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تکمیل فرم</title>
    
    <!-- فونت وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- کتابخانه آیکون‌های مدرن FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- اضافه کردن کتابخانه AOS برای انیمیشن‌های اسکرول (دستور شما) -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <style>
        :root {
            /* پالت رنگی رسمی، شاداب، مینیمال و لوکس (Minimal Luxury Aesthetic) */
            --bg-base: #f4f7f9; /* پس‌زمینه بسیار روشن و شاداب اداری/رسمی */
            --card-bg: #ffffff; /* سفیدی مطلق برای فرم لوکس */
            
            --primary: #0f172a; /* سرمه‌ای بسیار تیره برای متون اصلی (خوانایی بالا) */
            --text-muted: #64748b; /* خاکستری ملایم برای متون فرعی */
            
            --accent: #2563eb; /* آبی زنده، رسمی و مدرن */
            --accent-hover: #1d4ed8;
            --accent-soft: rgba(37, 99, 235, 0.08); /* پس‌زمینه نرم فیلدها */
            
            --success: #10b981; /* سبز شاداب */
            --warning: #f59e0b; /* زرد/نارنجی ملایم */
            --danger: #ef4444; /* قرمز ملایم */
            
            --border-color: #e2e8f0;
            --border-focus: #3b82f6; 
            
            /* سایه‌های نرم (Soft Shadows) */
            --shadow-soft: 0 10px 40px -10px rgba(15, 23, 42, 0.08);
            --shadow-hover: 0 20px 40px -10px rgba(37, 99, 235, 0.12);
            
            /* Modern Border Radius */
            --radius-main: 20px;
            --radius-field: 12px;
            
            /* تایپوگرافی مقیاس‌پذیر (Typography Scale) */
            --text-xs: 0.85rem;
            --text-sm: 0.95rem;
            --text-base: 1.05rem;
            --text-lg: 1.25rem;
            --text-xl: 1.6rem;
            --text-2xl: 2.2rem;
        }
        
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background: var(--bg-base);
            /* Parallax خیلی سبک با گرادیانت ملایم اداری */
            background-image: linear-gradient(135deg, #f8fafc 0%, #eef2f6 100%);
            margin: 0; 
            padding: 20px; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background-attachment: fixed;
            color: var(--primary);
            -webkit-font-smoothing: antialiased; /* نمایش نرم‌تر فونت‌ها */
        }
        
        /* کانتینر اصلی - Grid-Based و لوکس */
        .container { 
            width: 100%; 
            max-width: 680px; 
            background: var(--card-bg); 
            padding: 45px; 
            border-radius: var(--radius-main); 
            box-shadow: var(--shadow-soft);
            position: relative; 
            margin-top: 20px; 
            margin-bottom: 20px;
            border-top: 4px solid var(--accent); /* Cinematic Header Line */
            transition: all 0.5s ease;
        }

        /* لودینگ مدرن: ۴ مکعب رنگی جهنده (دستور دقیق شما) */
        .loader-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(8px);
            transition: opacity 0.4s ease;
        }
        .cube-loader-container {
            width: 50px;
            height: 50px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 25px;
        }
        .loader-cube {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            animation: jumpCube 0.6s cubic-bezier(0.4, 0, 0.2, 1) infinite alternate;
        }
        .cube-1 { background: var(--accent); animation-delay: 0s; }
        .cube-2 { background: var(--success); animation-delay: 0.15s; }
        .cube-3 { background: var(--warning); animation-delay: 0.3s; }
        .cube-4 { background: var(--danger); animation-delay: 0.45s; }
        
        @keyframes jumpCube {
            0% { transform: translateY(0) scale(1); opacity: 0.7; border-radius: 6px; }
            100% { transform: translateY(-12px) scale(1.15); opacity: 1; border-radius: 50%; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        }
        
        .loading-text { 
            font-weight: 700; 
            color: var(--primary); 
            font-size: var(--text-lg);
            letter-spacing: 0.5px; 
            animation: pulseText 1.5s infinite;
        }
        @keyframes pulseText { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        /* بخش موفقیت */
        #success-view { display: none; text-align: center; padding: 40px 0; }
        .success-icon { 
            width: 85px; height: 85px; background: #ecfdf5; color: var(--success); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            margin: 0 auto 25px; font-size: 40px;
            box-shadow: 0 15px 30px -10px rgba(16, 185, 129, 0.3);
            animation: ZoomSmall 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes ZoomSmall { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .success-title { font-size: var(--text-xl); color: var(--primary); margin-bottom: 15px; font-weight: 900; }
        .success-msg { color: var(--text-muted); margin-bottom: 40px; line-height: 1.8; font-size: var(--text-base); }
        .action-btns { display: flex; gap: 15px; justify-content: center; }
        
        /* عناصر فرم - Cinematic Hero Section */
        #f-title { font-size: var(--text-2xl); color: var(--primary); margin-bottom: 8px; text-align: center; font-weight: 900; letter-spacing: -0.5px; }
        #f-desc { 
            color: var(--text-muted); text-align: center; margin-bottom: 40px; line-height: 1.8; 
            background: #f8fafc; padding: 20px; border-radius: var(--radius-field); 
            border: 1px dashed var(--border-color); font-size: var(--text-sm); font-weight: 500; 
        }
        /* مکان‌نمای تایپ شده با Typed.js */
        .typed-cursor { color: var(--accent); font-size: 1.2rem; }
        
        /* گروه بندی و متمایز کردن آیتم ها - Micro Interactions */
        .field-group {
            background: #ffffff;
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: var(--radius-field);
            margin-bottom: 22px;
            transition: all 0.3s ease; /* Transition ساده و نرم */
            position: relative;
        }
        .field-group:hover {
            border-color: #cbd5e1;
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px); /* Hover نرم */
        }

        .label-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--primary);
        }
        .label-icon {
            margin-left: 10px;
            color: var(--accent);
            font-size: 1.1rem;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--accent-soft);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .field-group:hover .label-icon {
            background: var(--accent);
            color: #ffffff;
            transform: scale(1.05);
        }

        label { display: block; font-weight: 700; font-size: var(--text-base); margin: 0; color: var(--primary); }
        .req-star { color: var(--danger); margin-right: 6px; font-size: 1.2rem; }
        
        /* استایل فیلدهای ورودی */
        .input-wrapper { position: relative; width: 100%; }
        .input-wrapper i.inside-icon {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; font-size: 1.1rem; pointer-events: none; transition: 0.3s ease;
        }
        
        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 16px 45px 16px 16px; 
            border: 2px solid var(--border-color); border-radius: var(--radius-field);
            font-family: inherit; font-size: var(--text-base); font-weight: 500;
            transition: all 0.3s ease; box-sizing: border-box; 
            background: #ffffff; color: var(--primary);
        }
        textarea { padding: 16px; }
        input::placeholder, textarea::placeholder { color: #cbd5e1; font-weight: 400; }
        input:focus, textarea:focus { 
            border-color: var(--border-focus); 
            background: #ffffff; outline: none; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); 
        }
        input:focus + i.inside-icon { color: var(--accent); }
        
        /* CTA Focused Design - دکمه ارسال با Pulse ملایم */
        .submit-btn {
            width: 100%; padding: 18px; 
            background: var(--accent); color: white; border: none; 
            border-radius: var(--radius-field); font-size: var(--text-lg); font-weight: 800; 
            cursor: pointer; margin-top: 20px; transition: all 0.3s ease;
            box-shadow: 0 8px 20px -6px rgba(37, 99, 235, 0.4);
            display: flex; justify-content: center; align-items: center; gap: 10px;
            animation: softPulse 2.5s infinite; /* دکمه Pulse ملایم */
        }
        @keyframes softPulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        .submit-btn:hover { 
            background: var(--accent-hover);
            transform: translateY(-3px);
            box-shadow: 0 12px 25px -6px rgba(37, 99, 235, 0.5);
        }
        .submit-btn:disabled { background: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; animation: none; }
        
        .btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--primary); }
        .btn-outline:hover { background: #f8fafc; border-color: var(--primary); }
        .btn-fill { background: var(--primary); color: white; border: 2px solid var(--primary); }
        .btn-fill:hover { background: #000000; box-shadow: var(--shadow-hover); }
        .btn-act { padding: 12px 28px; border-radius: 10px; cursor: pointer; font-weight: 700; font-family: inherit; transition: 0.3s ease; font-size: var(--text-base); display: flex; align-items: center; justify-content: center; }

        /* دکمه‌های گزینه‌ها */
        .options-container { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .option-label { 
            display: flex; align-items: center; padding: 14px 18px; border: 1px solid var(--border-color); 
            border-radius: 10px; cursor: pointer; transition: all 0.2s ease; background: #ffffff;
            font-weight: 600; font-size: var(--text-base); margin: 0; color: var(--primary);
        }
        .option-label:hover { border-color: var(--accent); background: var(--accent-soft); }
        .option-label input { margin-left: 14px; width: 20px; height: 20px; accent-color: var(--accent); cursor: pointer; }

        /* لیست فرم‌ها */
        .form-list-item { 
            background: #ffffff; padding: 22px; border-radius: var(--radius-field); margin-bottom: 18px; 
            cursor: pointer; border: 1px solid var(--border-color); display: flex; justify-content: space-between; 
            align-items: center; transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .form-list-item::before { content: ''; position: absolute; right: 0; top: 0; height: 100%; width: 4px; background: transparent; transition: 0.3s ease; }
        .form-list-item strong { font-size: var(--text-lg); color: var(--primary); font-weight: 800; }
        .form-list-item span { background: var(--accent-soft); color: var(--accent); padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: var(--text-sm); transition: 0.3s ease; display: flex; align-items: center; }
        .form-list-item:hover { 
            transform: translateY(-4px); 
            box-shadow: var(--shadow-hover); 
            border-color: #cbd5e1; 
        }
        .form-list-item:hover::before { background: var(--accent); }
        .form-list-item:hover span { background: var(--accent); color: white; }
        .form-list-icon { margin-left: 15px; font-size: 1.6rem; color: var(--accent); background: var(--accent-soft); padding: 10px; border-radius: 10px; }
        .form-list-title-wrapper { display: flex; align-items: center; }

        /* Floating Action Button ملایم (دستور شما) */
        .fab-btn {
            position: fixed; bottom: 20px; left: 20px; width: 45px; height: 45px;
            background: #ffffff; color: var(--primary); border: 1px solid var(--border-color);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s ease;
            z-index: 99; opacity: 0; visibility: hidden;
        }
        .fab-btn.visible { opacity: 1; visibility: visible; }
        .fab-btn:hover { background: var(--accent); color: white; transform: translateY(-3px); }

        /* واکنش‌گرایی */
        @media (max-width: 768px) {
            body { padding: 15px; align-items: flex-start; }
            .container { padding: 30px 20px; border-radius: 16px; margin-top: 10px; }
            #f-title { font-size: var(--text-xl); }
            .field-group { padding: 18px; }
            .submit-btn { padding: 16px; font-size: var(--text-base); }
            .form-list-item { flex-direction: column; align-items: flex-start; padding: 20px; gap: 15px; }
            .form-list-item span { width: 100%; justify-content: center; box-sizing: border-box; }
            .action-btns { flex-direction: column; }
            .btn-act { width: 100%; justify-content: center; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<!-- لودینگ مدرن با مکعب‌های رنگی -->
<div class="loader-overlay" id="loader">
    <div class="cube-loader-container">
        <div class="loader-cube cube-1"></div>
        <div class="loader-cube cube-2"></div>
        <div class="loader-cube cube-3"></div>
        <div class="loader-cube cube-4"></div>
    </div>
    <div class="loading-text">لطفا کمی صبر کنید...</div>
</div>

<div class="container" id="main-container" style="display:none;">
    
    <!-- نمای فرم -->
    <div id="form-view">
        <h1 id="f-title"></h1>
        <!-- محل قرارگیری انیمیشن تایپ شدن متن -->
        <div id="f-desc">
            <i class="fa-solid fa-circle-info" style="color:var(--accent); margin-left:8px; font-size:1.1rem;"></i>
            <span id="typed-desc"></span>
        </div>
        <form id="dynamic-form" onsubmit="event.preventDefault(); sendData();"></form>
    </div>

    <!-- نمای موفقیت -->
    <div id="success-view">
        <div class="success-icon"><i class="fa-solid fa-check"></i></div>
        <h2 class="success-title">ارسال موفق</h2>
        <p class="success-msg" id="custom-success-msg">اطلاعات شما با موفقیت ثبت شد.</p>
        <div class="action-btns">
            <button onclick="reloadForm()" class="btn-act btn-outline"><i class="fa-solid fa-rotate-right" style="margin-left: 8px;"></i>پر کردن مجدد</button>
            <button onclick="closeForm()" class="btn-act btn-fill"><i class="fa-solid fa-xmark" style="margin-left: 8px;"></i>بستن</button>
        </div>
    </div>

    <!-- لیست فرم‌ها (اگر شناسه نباشد) -->
    <div id="list-view" style="display:none;">
        <h2 style="text-align:center; color:var(--primary); font-weight: 900; margin-bottom: 30px;"><i class="fa-solid fa-list-check" style="margin-left: 10px; color: var(--accent);"></i>فرم‌های موجود</h2>
        <div id="forms-list"></div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="fab-btn" id="fabBtn" onclick="window.scrollTo({top: 0, behavior: 'smooth'});" title="بازگشت به بالا">
    <i class="fa-solid fa-chevron-up"></i>
</div>

<!-- اضافه کردن کتابخانه Typed.js برای تایپ شدن متن -->
<script src="https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js"></script>
<!-- اضافه کردن کتابخانه AOS برای انیمیشن‌های اسکرول -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 

    let currentSuccessMsg = "";

    // منطق نمایش FAB
    window.addEventListener('scroll', () => {
        const fab = document.getElementById('fabBtn');
        if (window.scrollY > 150) fab.classList.add('visible');
        else fab.classList.remove('visible');
    });

    init();

    function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get('id');
        const container = document.getElementById('main-container');

        if (formId) {
            showLoader(true);
            fetch(`${API_URL}?action=getForm&formId=${formId}`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                if (data.status === 'success') {
                    renderForm(data.structure, formId);
                } else {
                    container.innerHTML = "<div style='text-align:center; padding: 40px;'><i class='fa-solid fa-triangle-exclamation' style='font-size: 50px; color: #cbd5e1; margin-bottom: 20px;'></i><h3 style='color:#64748b; font-weight: 800;'>این فرم وجود ندارد یا حذف شده است.</h3></div>";
                }
            })
            .catch(() => { showLoader(false); container.innerHTML = "<div style='text-align:center; padding: 40px;'><i class='fa-solid fa-plug-circle-xmark' style='font-size: 50px; color: #ef4444; margin-bottom: 20px;'></i><h3 style='color:#0f172a; font-weight: 800;'>خطا در اتصال به سرور</h3><p style='color:#64748b;'>لطفا اتصال اینترنت خود را بررسی کنید.</p></div>"; });
        } else {
            showLoader(true);
            document.getElementById('form-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'block';
            
            fetch(`${API_URL}?action=getFormList`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                const listDiv = document.getElementById('forms-list');
                if(data.status==='success' && data.list.length > 0) {
                    data.list.forEach((f, index) => {
                        listDiv.innerHTML += `<div class="form-list-item" onclick="location.href='?id=${f.id}'" data-aos="fade-up" data-aos-delay="${index * 100}">
                            <div class="form-list-title-wrapper">
                                <i class="fa-solid fa-file-signature form-list-icon"></i>
                                <strong>${f.title}</strong>
                            </div>
                            <span>ورود <i class="fa-solid fa-arrow-left" style="margin-right: 8px;"></i></span>
                        </div>`;
                    });
                    setTimeout(() => AOS.init({ duration: 600, once: true }), 100);
                } else listDiv.innerHTML = "<div style='text-align:center; padding: 30px;'><i class='fa-regular fa-folder-open' style='font-size: 40px; color:#cbd5e1; margin-bottom:15px;'></i><p style='color:#64748b; font-weight:700;'>هیچ فرمی یافت نشد</p></div>";
            });
        }
    }

    function showLoader(show) {
        const loader = document.getElementById('loader');
        if (show) {
            loader.style.display = 'flex';
            setTimeout(() => loader.style.opacity = '1', 10);
        } else {
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 400); // Fade out نرم
        }
    }

    function getIconForFieldType(type) {
        switch(type) {
            case 'short_text': return 'fa-solid fa-pen';
            case 'long_text': return 'fa-solid fa-align-right';
            case 'number': return 'fa-solid fa-hashtag';
            case 'national_code': return 'fa-regular fa-id-card';
            case 'phone': return 'fa-solid fa-mobile-screen-button';
            case 'single_choice': return 'fa-regular fa-circle-dot';
            case 'multi_choice': return 'fa-solid fa-list-check';
            default: return 'fa-solid fa-asterisk';
        }
    }

    function isValidIranianNationalCode(code) {
        if (!/^\d{10}$/.test(code)) return false;
        if (/^(\d)\1{9}$/.test(code)) return false;
        
        const check = parseInt(code[9]);
        let sum = 0;
        for (let i = 0; i < 9; i++) {
            sum += parseInt(code[i]) * (10 - i);
        }
        sum = sum % 11;
        
        return (sum < 2 && check === sum) || (sum >= 2 && check === 11 - sum);
    }

    function renderForm(data, id) {
        document.getElementById('f-title').innerHTML = `<i class="fa-solid fa-file-lines" style="color:var(--accent); margin-left:12px;"></i>${data.title}`;
        
        // اجرای انیمیشن تایپ متن (Typed.js) برای توضیحات فرم
        const descText = data.description || "لطفا اطلاعات زیر را با دقت تکمیل نمایید.";
        if(window.Typed) {
            new Typed('#typed-desc', {
                strings: [descText],
                typeSpeed: 35,
                showCursor: true,
                cursorChar: '|',
                onComplete: function(self) { self.cursor.style.display = 'none'; }
            });
        } else {
            document.getElementById('typed-desc').innerText = descText;
        }
        
        currentSuccessMsg = data.successMessage || "اطلاعات شما با موفقیت ثبت شد.";
        
        const form = document.getElementById('dynamic-form');
        form.setAttribute('data-id', id);

        data.fields.forEach((f, index) => {
            const div = document.createElement('div');
            div.className = 'field-group';
            // افزودن AOS به هر فیلد برای Slide Up و Fade in
            div.setAttribute('data-aos', 'fade-up');
            div.setAttribute('data-aos-delay', (index * 50).toString());
            
            const reqHtml = f.required ? '<span class="req-star" title="این فیلد الزامی است">*</span>' : '';
            const reqAttr = f.required ? 'required' : '';

            if (f.type === 'static') {
                div.style.background = '#f8fafc';
                div.style.border = '1px solid #e2e8f0';
                div.innerHTML = `<div style="color:var(--primary); line-height:1.9; font-weight:700;"><i class="fa-solid fa-bullhorn" style="color:var(--accent); margin-left:12px; font-size:1.4rem;"></i>${f.content}</div>`;
            } else {
                const labelIcon = getIconForFieldType(f.type);
                
                div.innerHTML = `
                    <div class="label-container">
                        <i class="${labelIcon} label-icon"></i>
                        <label>${f.label} ${reqHtml}</label>
                    </div>`;
                
                if (['short_text', 'long_text', 'number', 'national_code', 'phone'].includes(f.type)) {
                    let type = f.type === 'short_text' ? 'text' : (f.type === 'long_text' ? 'textarea' : 'number');
                    let tag = f.type === 'long_text' ? 'textarea' : 'input';
                    let attrs = type === 'textarea' ? 'rows="4"' : `type="${type}"`;
                    
                    if (f.type === 'national_code') attrs += ' placeholder="مثال: 0123456789" ';
                    if (f.type === 'phone') attrs += ' placeholder="مثال: 09123456789" ';
                    
                    if(tag === 'input') {
                        div.innerHTML += `
                        <div class="input-wrapper">
                            <input ${attrs} name="${f.label}" class="input-field" ${reqAttr} data-type="${f.type}">
                            <i class="${labelIcon} inside-icon"></i>
                        </div>`;
                    } else {
                        div.innerHTML += `<${tag} ${attrs} name="${f.label}" class="input-field" ${reqAttr} data-type="${f.type}"></${tag}>`;
                    }
                }
                else if (f.type === 'single_choice' || f.type === 'multi_choice') {
                    let type = f.type === 'single_choice' ? 'radio' : 'checkbox';
                    let optionsHtml = '<div class="options-container">';
                    
                    f.options.forEach((opt, idx) => {
                        let r = (f.type === 'single_choice' && f.required && idx===0) ? 'required' : '';
                        optionsHtml += `<label class="option-label">
                            <input type="${type}" name="${f.label}" value="${opt}" ${r}>
                            <span>${opt}</span>
                        </label>`;
                    });
                    
                    optionsHtml += '</div>';
                    div.innerHTML += optionsHtml;
                }
            }
            form.appendChild(div);
        });

        const btn = document.createElement('button');
        btn.type = 'submit';
        btn.className = 'submit-btn';
        btn.setAttribute('data-aos', 'zoom-in');
        btn.setAttribute('data-aos-delay', (data.fields.length * 50).toString());
        btn.innerHTML = 'ارسال اطلاعات <i class="fa-solid fa-paper-plane" style="margin-right: 8px;"></i>';
        form.appendChild(btn);

        // راه‌اندازی انیمیشن‌های اسکرول با تاخیر کوتاه برای رندر شدن DOM
        setTimeout(() => {
            AOS.init({ duration: 600, once: true, easing: 'ease-out-cubic' });
        }, 100);
    }

    function sendData() {
        const form = document.getElementById('dynamic-form');
        
        const inputs = form.querySelectorAll('input[data-type]');
        for (let input of inputs) {
            const val = input.value;
            const type = input.getAttribute('data-type');
            
            if (val && type === 'national_code') {
                if (!isValidIranianNationalCode(val)) {
                    alert('کد ملی وارد شده معتبر نیست. لطفا یک کد ملی صحیح و 10 رقمی وارد کنید.');
                    input.focus();
                    input.style.borderColor = 'var(--danger)';
                    setTimeout(() => input.style.borderColor = '', 3000);
                    return;
                }
            }
            if (val && type === 'phone') {
                if (!/^\d{11}$/.test(val)) {
                    alert('شماره تماس باید دقیقا ۱۱ رقم عدد باشد.');
                    input.focus();
                    input.style.borderColor = 'var(--danger)';
                    setTimeout(() => input.style.borderColor = '', 3000);
                    return;
                }
            }
        }

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const id = form.getAttribute('data-id');
        const formData = new FormData(form);
        let ans = {};
        
        for (let [key, val] of formData.entries()) {
            if (ans[key]) ans[key] += ", " + val; else ans[key] = val;
        }

        const btn = document.querySelector('.submit-btn');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> در حال ارسال...'; 
        btn.disabled = true;
        
        showLoader(true);

        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "submitResponse", formId: id, answers: ans }) })
        .then(r => r.json()).then(d => {
            showLoader(false);
            if(d.status === 'success') {
                document.getElementById('form-view').style.display = 'none';
                document.getElementById('custom-success-msg').innerText = currentSuccessMsg;
                document.getElementById('success-view').style.display = 'block';
                // نمایش مجدد انیمیشن تیک سبز
                document.querySelector('.success-icon').style.animation = 'none';
                setTimeout(() => document.querySelector('.success-icon').style.animation = '', 10);
            } else {
                alert("خطا: " + d.message);
                btn.innerHTML = 'ارسال اطلاعات <i class="fa-solid fa-paper-plane" style="margin-right: 8px;"></i>'; 
                btn.disabled = false;
            }
        }).catch(() => {
            showLoader(false); alert("خطا در ارتباط");
            btn.innerHTML = 'ارسال اطلاعات <i class="fa-solid fa-paper-plane" style="margin-right: 8px;"></i>'; 
            btn.disabled = false;
        });
    }

    function reloadForm() {
        location.reload();
    }

    function closeForm() {
        window.close(); 
        document.body.innerHTML = "<div style='display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:var(--bg-base);'><i class='fa-solid fa-door-closed' style='font-size:80px; color:#cbd5e1; margin-bottom:20px;'></i><h3 style='color:var(--primary); font-weight:800; font-size:1.8rem;'>فرم بسته شد.</h3><p style='color:var(--text-muted); font-size:1.2rem;'>می‌توانید این پنجره را ببندید.</p></div>";
    }
</script>
</body>
</html>
