<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تکمیل فرم</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --primary: #1e293b; 
            --accent: #3b82f6; 
            --success: #10b981;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #cbd5e1 100%);
        }
        
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background: var(--bg-gradient); 
            margin: 0; padding: 20px; 
            min-height: 100vh; 
            display: flex; justify-content: center; align-items: flex-start;
        }
        
        /* کانتینر اصلی */
        .container { 
            width: 100%; max-width: 600px; background: #ffffff; 
            padding: 40px; border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative; margin-top: 30px; border: 1px solid #e2e8f0;
        }

        /* لودینگ مدرن حلقه‌ای */
        .loader-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        .ring-loader {
            display: inline-block; position: relative; width: 80px; height: 80px;
        }
        .ring-loader div {
            box-sizing: border-box; display: block; position: absolute;
            width: 64px; height: 64px; margin: 8px;
            border: 4px solid var(--accent); border-radius: 50%;
            animation: ring-spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: var(--accent) transparent transparent transparent;
        }
        .ring-loader div:nth-child(1) { animation-delay: -0.45s; }
        .ring-loader div:nth-child(2) { animation-delay: -0.3s; }
        .ring-loader div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes ring-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text { margin-top: 20px; font-weight: 600; color: var(--primary); letter-spacing: 0.5px; }

        /* بخش موفقیت */
        #success-view { display: none; text-align: center; padding: 20px 0; }
        .success-icon { 
            width: 80px; height: 80px; background: #dcfce7; color: var(--success); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            margin: 0 auto 20px; font-size: 40px;
        }
        .success-title { font-size: 1.5rem; color: var(--primary); margin-bottom: 10px; font-weight: 800; }
        .success-msg { color: #64748b; margin-bottom: 30px; line-height: 1.6; }
        .action-btns { display: flex; gap: 10px; justify-content: center; }
        
        /* عناصر فرم */
        #f-title { font-size: 1.75rem; color: var(--primary); margin-bottom: 15px; text-align: center; font-weight: 900; }
        #f-desc { color: #475569; text-align: center; margin-bottom: 35px; line-height: 1.7; background: #f1f5f9; padding: 15px; border-radius: 12px; }
        
        label { display: block; font-weight: 700; color: #334155; margin-bottom: 8px; margin-top: 25px; }
        .req-star { color: #ef4444; margin-right: 2px; }
        
        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-family: inherit; font-size: 1rem; transition: border-color 0.2s;
            box-sizing: border-box; background: #f8fafc; color: #1e293b;
        }
        input:focus, textarea:focus { border-color: var(--accent); background: white; outline: none; }
        
        .submit-btn {
            width: 100%; padding: 16px; background: var(--primary);
            color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; margin-top: 40px; transition: opacity 0.2s;
        }
        .submit-btn:hover { opacity: 0.9; }
        
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-fill { background: var(--primary); color: white; border: none; }
        .btn-act { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit; }

        /* دکمه‌های گزینه‌ها */
        .option-label { 
            display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; 
            border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; background: #fff;
        }
        .option-label:hover { border-color: var(--accent); background: #eff6ff; }
        .option-label input { margin-left: 10px; width: 18px; height: 18px; accent-color: var(--accent); }

        .form-list-item { 
            background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; 
            cursor: pointer; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; 
            align-items: center; transition: 0.2s;
        }
        .form-list-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--accent); }
    </style>
</head>
<body>

<!-- لودینگ مدرن -->
<div class="loader-overlay" id="loader">
    <div class="ring-loader"><div></div><div></div><div></div><div></div></div>
    <div class="loading-text">لطفا کمی صبر کنید...</div>
</div>

<div class="container" id="main-container" style="display:none;">
    
    <!-- نمای فرم -->
    <div id="form-view">
        <h1 id="f-title"></h1>
        <div id="f-desc"></div>
        <form id="dynamic-form" onsubmit="event.preventDefault(); sendData();"></form>
    </div>

    <!-- نمای موفقیت -->
    <div id="success-view">
        <div class="success-icon">✓</div>
        <h2 class="success-title">ارسال موفق</h2>
        <p class="success-msg" id="custom-success-msg">اطلاعات شما با موفقیت ثبت شد.</p>
        <div class="action-btns">
            <button onclick="reloadForm()" class="btn-act btn-outline">پر کردن مجدد</button>
            <button onclick="closeForm()" class="btn-act btn-fill">بستن</button>
        </div>
    </div>

    <!-- لیست فرم‌ها (اگر شناسه نباشد) -->
    <div id="list-view" style="display:none;">
        <h2 style="text-align:center; color:var(--primary);">فرم‌های موجود</h2>
        <div id="forms-list"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 

    let currentSuccessMsg = "";

    init();

    function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get('id');
        const container = document.getElementById('main-container');

        if (formId) {
            showLoader(true);
            fetch(`${API_URL}?action=getForm&formId=${formId}`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                if (data.status === 'success') {
                    renderForm(data.structure, formId);
                } else {
                    container.innerHTML = "<h3 style='text-align:center; color:#64748b;'>این فرم وجود ندارد یا حذف شده است.</h3>";
                }
            })
            .catch(() => { showLoader(false); container.innerHTML = "<h3 style='text-align:center'>خطا در اتصال به سرور</h3>"; });
        } else {
            showLoader(true);
            document.getElementById('form-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'block';
            
            fetch(`${API_URL}?action=getFormList`)
            .then(r => r.json())
            .then(data => {
                showLoader(false);
                container.style.display = 'block';
                const listDiv = document.getElementById('forms-list');
                if(data.status==='success' && data.list.length > 0) {
                    data.list.forEach(f => {
                        listDiv.innerHTML += `<div class="form-list-item" onclick="location.href='?id=${f.id}'">
                            <strong>${f.title}</strong>
                            <span style="color:#94a3b8;">ورود ←</span>
                        </div>`;
                    });
                } else listDiv.innerHTML = "<p style='text-align:center; color:#64748b;'>هیچ فرمی یافت نشد</p>";
            });
        }
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    function renderForm(data, id) {
        document.getElementById('f-title').innerText = data.title;
        document.getElementById('f-desc').innerText = data.description;
        
        // ذخیره پیام سفارشی برای نمایش بعدی
        currentSuccessMsg = data.successMessage || "اطلاعات شما با موفقیت ثبت شد.";
        
        const form = document.getElementById('dynamic-form');
        form.setAttribute('data-id', id);

        data.fields.forEach(f => {
            const div = document.createElement('div');
            const reqHtml = f.required ? '<span class="req-star">*</span>' : '';
            const reqAttr = f.required ? 'required' : '';

            if (f.type === 'static') {
                div.innerHTML = `<div style="background:#f1f5f9; color:#334155; padding:15px; border-radius:10px; margin:20px 0; border-left:4px solid var(--accent); line-height:1.6;">${f.content}</div>`;
            } else {
                div.innerHTML = `<label>${f.label} ${reqHtml}</label>`;
                
                if (['short_text', 'long_text', 'number', 'national_code', 'phone'].includes(f.type)) {
                    let type = f.type === 'short_text' ? 'text' : (f.type === 'long_text' ? 'textarea' : 'number');
                    let tag = f.type === 'long_text' ? 'textarea' : 'input';
                    let attrs = type === 'textarea' ? 'rows="4"' : `type="${type}"`;
                    
                    // اعتبارسنجی‌های خاص
                    if (f.type === 'national_code') attrs += ' placeholder="10 رقم" ';
                    if (f.type === 'phone') attrs += ' placeholder="11 رقم (مثلا 0912...)" ';
                    
                    div.innerHTML += `<${tag} ${attrs} name="${f.label}" class="input-field" ${reqAttr} data-type="${f.type}"></${tag}>`;
                }
                else if (f.type === 'single_choice' || f.type === 'multi_choice') {
                    let type = f.type === 'single_choice' ? 'radio' : 'checkbox';
                    f.options.forEach((opt, idx) => {
                        let r = (f.type === 'single_choice' && f.required && idx===0) ? 'required' : '';
                        div.innerHTML += `<label class="option-label">
                            <input type="${type}" name="${f.label}" value="${opt}" ${r}>
                            <span>${opt}</span>
                        </label>`;
                    });
                }
            }
            form.appendChild(div);
        });

        const btn = document.createElement('button');
        btn.type = 'submit';
        btn.className = 'submit-btn';
        btn.innerText = 'ارسال اطلاعات';
        form.appendChild(btn);
    }

    function sendData() {
        const form = document.getElementById('dynamic-form');
        
        // اعتبارسنجی جاوااسکریپتی اضافه برای کد ملی و موبایل
        const inputs = form.querySelectorAll('input[data-type]');
        for (let input of inputs) {
            const val = input.value;
            const type = input.getAttribute('data-type');
            
            if (val && type === 'national_code') {
                if (!/^\d{10}$/.test(val)) {
                    alert('کد ملی باید دقیقا ۱۰ رقم عدد باشد.');
                    input.focus();
                    return;
                }
            }
            if (val && type === 'phone') {
                if (!/^\d{11}$/.test(val)) {
                    alert('شماره تماس باید دقیقا ۱۱ رقم عدد باشد.');
                    input.focus();
                    return;
                }
            }
        }

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const id = form.getAttribute('data-id');
        const formData = new FormData(form);
        let ans = {};
        
        for (let [key, val] of formData.entries()) {
            if (ans[key]) ans[key] += ", " + val; else ans[key] = val;
        }

        const btn = document.querySelector('.submit-btn');
        btn.innerText = "لطفا صبر کنید..."; btn.disabled = true;
        
        showLoader(true);

        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "submitResponse", formId: id, answers: ans }) })
        .then(r => r.json()).then(d => {
            showLoader(false);
            if(d.status === 'success') {
                // نمایش صفحه موفقیت
                document.getElementById('form-view').style.display = 'none';
                document.getElementById('custom-success-msg').innerText = currentSuccessMsg;
                document.getElementById('success-view').style.display = 'block';
            } else {
                alert("خطا: " + d.message);
                btn.innerText = "ارسال اطلاعات"; btn.disabled = false;
            }
        }).catch(() => {
            showLoader(false); alert("خطا در ارتباط");
            btn.innerText = "ارسال اطلاعات"; btn.disabled = false;
        });
    }

    function reloadForm() {
        location.reload();
    }

    function closeForm() {
        window.close(); // ممکن است در همه مرورگرها کار نکند (امنیت)
        document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px; color:#64748b;'>فرم بسته شد. می‌توانید این پنجره را ببندید.</h3>";
    }
</script>
</body>
</html>
