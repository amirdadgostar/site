<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت سامانه | پنل رسمی</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            /* رنگ‌بندی سازمانی و رسمی (Slate & Royal Blue) */
            --primary: #1e293b;       /* سرمه‌ای تیره و رسمی */
            --primary-dark: #0f172a;
            --accent: #3b82f6;        /* آبی رویال و مدرن */
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;            /* پس‌زمینه خیلی روشن و تمیز */
            --card-bg: #ffffff;
            --text-main: #334155;     /* خاکستری تیره برای متون */
            --text-light: #64748b;
            --border: #e2e8f0;
            --radius: 0.5rem;         /* شعاع کمتر برای ظاهر رسمی‌تر */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        * { box-sizing: border-box; outline: none; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 60px; line-height: 1.6; }

        /* Login Styling - Official Look */
        #login-panel { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); padding: 20px; }
        .login-card { 
            background: var(--card-bg); padding: 40px; width: 100%; max-width: 380px; 
            border-radius: var(--radius); box-shadow: var(--shadow-lg); 
            text-align: center; display: flex; flex-direction: column; gap: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .login-icon-circle {
            width: 60px; height: 60px; background: #eff6ff; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; margin: 0 auto;
            color: var(--accent);
        }
        .login-card h2 { margin: 0; color: var(--primary); font-size: 1.25rem; font-weight: 800; letter-spacing: -0.5px; }

        /* Layout */
        #admin-panel { display: none; }
        header { 
            position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); padding: 0 30px; height: 70px; 
            box-shadow: var(--shadow-sm); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { 
            font-size: 1.1rem; font-weight: 800; color: var(--primary); 
            display: flex; align-items: center; gap: 12px; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .container { max-width: 1440px; margin: 30px auto; padding: 0 25px; }
        .dashboard-grid { display: grid; grid-template-columns: 380px 1fr; gap: 30px; align-items: start; }
        
        /* اصلاحات برای تبلت */
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .card { 
            background: var(--card-bg); border-radius: var(--radius); padding: 25px; 
            box-shadow: var(--shadow-sm); border: 1px solid var(--border); 
            position: relative; overflow: hidden;
        }
        .card h3 { 
            margin-top: 0; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; 
            color: var(--primary); font-size: 1.1rem; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }

        /* Inputs - Official Style */
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.85rem; color: var(--primary); }
        input[type="text"], input[type="password"], select, textarea { 
            width: 100%; padding: 12px 14px; margin-bottom: 18px; 
            border: 1px solid var(--border); border-radius: 6px; 
            background: #fff; color: var(--text-main);
            font-family: inherit; font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus, select:focus { 
            border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); 
        }

        /* Buttons & Icons */
        .btn { 
            padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; color: white; 
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center; 
            gap: 8px; font-size: 0.85rem; line-height: 1; letter-spacing: 0.3px;
            position: relative; overflow: hidden;
        }
        /* آیکون‌های مدرن (Stroke Based) */
        .btn svg { 
            width: 20px; height: 20px; fill: none; stroke: currentColor; 
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        }
        
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-accent { background: var(--accent); }
        .btn-accent:hover { background: var(--accent-hover); }
        
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #059669; }
        
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        
        .btn-warning { background: var(--warning); color: #fff; }
        .btn-warning:hover { background: #d97706; }
        
        .btn-secondary { background: #fff; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
        
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Loading Spinner */
        .spinner {
            width: 18px; height: 18px; border: 2.5px solid currentColor;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .spinner-large { width: 40px; height: 40px; border-width: 4px; color: var(--accent); }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Form List Grid */
        /* اصلاح گرید برای موبایل‌های کوچک */
        .forms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .form-card { 
            background: #fff; border: 1px solid var(--border); border-radius: var(--radius); 
            padding: 20px; transition: all 0.2s; display: flex; flex-direction: column; gap: 15px;
            position: relative;
        }
        .form-card:hover { border-color: var(--accent); box-shadow: var(--shadow-md); transform: translateY(-2px); }
        
        .form-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .form-icon { 
            width: 40px; height: 40px; background: #eff6ff; color: var(--accent); 
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .form-info { flex-grow: 1; padding-right: 12px; }
        .form-title { font-weight: 700; font-size: 0.95rem; color: var(--primary); margin-bottom: 4px; }
        .form-date { font-size: 0.75rem; color: var(--text-light); display: flex; align-items: center; gap: 4px; }
        
        /* نوار ابزار مدرن */
        .action-bar { 
            display: flex; gap: 8px; margin-top: auto; padding-top: 15px; 
            border-top: 1px solid #f1f5f9; justify-content: flex-end;
        }
        .btn-icon { 
            width: 36px; height: 36px; padding: 0; justify-content: center; border-radius: 6px; 
            transition: all 0.2s;
        }
        .btn-icon svg { width: 18px; height: 18px; }

        /* Builder Fields */
        .field-box { 
            background: #fff; border: 1px solid var(--border); 
            border-right: 4px solid var(--accent); padding: 18px; margin-bottom: 15px; 
            border-radius: 6px; box-shadow: var(--shadow-sm);
        }
        .field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .badge { 
            background: #eff6ff; color: var(--accent); padding: 4px 10px; 
            border-radius: 20px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.5px;
            border: 1px solid #dbeafe;
        }
        
        /* ---------------------------------------------------- */
        /* FIX: Vertical Options Stacking (Mobile & Desktop) */
        /* ---------------------------------------------------- */
        .opt-container { 
            background: #f8fafc; 
            border: 1px dashed var(--border); 
            padding: 12px; 
            border-radius: 6px; 
            margin-top: 12px; 
            /* FORCE VERTICAL STACKING */
            display: flex !important; 
            flex-direction: column !important; 
            gap: 10px !important;
            width: 100% !important;
        }
        
        .opt-row { 
            display: flex !important; 
            gap: 8px !important; 
            align-items: center !important; 
            width: 100% !important;
            margin-bottom: 0 !important;
        }
        
        .opt-input { 
            margin-bottom: 0 !important; 
            flex-grow: 1 !important; 
            width: auto !important;
            min-width: 0; /* جلوگیری از سرریز در فلکس */
        }
        
        .btn-del-opt { 
            background: #fff; color: var(--danger); border: 1px solid #fee2e2;
            padding: 0; width: 42px; height: 42px; 
            border-radius: 6px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: all 0.2s;
        }
        .btn-del-opt:hover { background: #fee2e2; }
        .btn-del-opt svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; }

        .btn-add-opt {
            width: 100% !important; display: flex !important; margin-top: 5px !important;
            border-style: dashed !important; justify-content: center;
        }

        /* Checkbox & Modals */
        .chk-wrap { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; margin-top: 12px; cursor: pointer; user-select: none; }
        .chk-wrap input { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: var(--accent); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        
        .modal-content { 
            background: white; padding: 30px; border-radius: var(--radius); 
            width: 90%; max-width: 500px; 
            display: flex; flex-direction: column; gap: 20px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalFade 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-content-large { max-width: 1100px; max-height: 90vh; }

        @keyframes modalFade { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Table - Professional Data Grid */
        #tableContainer { overflow-x: auto; border: 1px solid var(--border); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; background: #fff; }
        th, td { padding: 12px 16px; text-align: right; border-bottom: 1px solid var(--border); white-space: nowrap; }
        th { background: #f8fafc; position: sticky; top: 0; color: var(--primary); font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f1f5f9; }

        .msg-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .msg-body { font-size: 0.95rem; color: var(--text-main); line-height: 1.7; }
        .msg-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; padding-top: 15px; border-top: 1px solid #f1f5f9; }

        /* Tooltip style override */
        [title] { position: relative; }

        /* ========================================= */
        /* MOBILE & RESPONSIVE FIXES (اضافه شده)      */
        /* ========================================= */
        @media (max-width: 768px) {
            .container { padding: 0 15px; margin: 20px auto; }
            .card { padding: 15px; margin-bottom: 20px; }
            
            /* هدر ریسپانسیو */
            header { 
                height: auto; 
                flex-direction: column; 
                gap: 10px; 
                padding: 15px; 
            }
            .brand { width: 100%; justify-content: center; margin-bottom: 5px; }
            header > div { width: 100%; justify-content: center; }
            
            /* کارت لاگین */
            .login-card { padding: 25px; width: 100%; max-width: 100%; }

            /* گرید فرم‌ها */
            .forms-grid { grid-template-columns: 1fr; }
            
            /* فیلدها */
            .field-box { padding: 12px; }
            
            /* گزینه‌های انتخاب در موبایل */
            .opt-row { gap: 5px !important; }
            .btn-del-opt { width: 38px; height: 38px; }
            input[type="text"], input[type="password"], select, textarea { 
                font-size: 16px; /* جلوگیری از زوم خودکار در iOS */
            }

            /* مودال‌ها */
            .modal-content { width: 95%; padding: 20px; }
            
            /* دکمه‌های اکشن بار */
            .action-bar { flex-wrap: wrap; justify-content: space-between; }
            .action-bar .btn-icon { flex-grow: 1; }
        }
    </style>
</head>
<body>

<div id="login-panel">
    <div class="login-card">
        <div class="login-icon-circle">
            <!-- Modern Lock Icon -->
            <svg style="width:28px;height:28px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        </div>
        <div>
            <h2>ورود به سامانه مدیریت</h2>
            <p style="color:var(--text-light); font-size:0.9rem; margin:5px 0 0 0;">لطفاً نام کاربری و رمز عبور را وارد کنید</p>
        </div>
        <div style="text-align:right;">
            <label>نام کاربری</label>
            <input type="text" id="username" placeholder="user@admin">
            <label>رمز عبور</label>
            <input type="password" id="password" placeholder="••••••••">
        </div>
        <button onclick="login()" class="btn btn-primary" style="width:100%; padding: 12px; justify-content:center; font-size:0.95rem;">
            <!-- Modern Login Icon -->
            <svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            ورود ایمن
        </button>
        <p id="login-msg" style="color:var(--danger); margin:0; font-size:0.85rem; height:20px;"></p>
    </div>
</div>

<div id="admin-panel">
    <header>
        <div class="brand">
            <!-- Modern Brand Icon -->
            <svg style="width:28px;height:28px;color:var(--accent);fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
            پنل مدیریت فرم‌ساز
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="openChangePassModal()" class="btn btn-secondary">
                <!-- Modern Key Icon -->
                <svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                تغییر رمز
            </button>
            <button onclick="logout()" class="btn btn-danger">
                <!-- Modern Logout Icon -->
                <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                خروج
            </button>
        </div>
    </header>

    <div class="container dashboard-grid">
        <!-- ستون راست: فرم ساز -->
        <div class="card">
            <h3>
                <!-- Modern Tools Icon -->
                <svg style="width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;color:var(--accent);" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                طراحی فرم جدید
            </h3>
            <label>عنوان فرم</label>
            <input type="text" id="formTitle" placeholder="مثلاً: ثبت نام همایش سالانه">
            
            <label>توضیحات فرم</label>
            <textarea id="formDesc" rows="2" placeholder="توضیحاتی که زیر عنوان نمایش داده می‌شود..."></textarea>
            
            <label>پیام موفقیت (سفارشی)</label>
            <textarea id="successMsg" rows="2" placeholder="مثلاً: اطلاعات شما با موفقیت ثبت شد."></textarea>

            <div id="fields-container"></div>
            
            <div style="background:#f1f5f9; padding:15px; border-radius:var(--radius); margin-top:20px; border:1px dashed var(--border);">
                <label>افزودن فیلد جدید:</label>
                <div style="display:flex; gap:10px;">
                    <select id="fieldType" style="margin-bottom:0;">
                        <option value="short_text">متن کوتاه</option>
                        <option value="long_text">متن بلند</option>
                        <option value="number">فقط عدد</option>
                        <option value="national_code">کد ملی (10 رقم)</option>
                        <option value="phone">شماره تماس (11 رقم)</option>
                        <option value="single_choice">تک انتخابی (رادیویی)</option>
                        <option value="multi_choice">چند انتخابی (چک‌باکس)</option>
                        <option value="static">متن نمایشی (بدون ورودی)</option>
                    </select>
                    <button onclick="addField()" class="btn btn-accent" title="افزودن">
                        <!-- Modern Plus Icon -->
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    </button>
                </div>
            </div>
            <button onclick="saveForm(this)" class="btn btn-success" style="width:100%; margin-top:20px; padding:12px; font-size:1rem;">
                <!-- Modern Save Icon -->
                <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                ذخیره و انتشار نهایی
            </button>
        </div>

        <!-- ستون چپ: لیست -->
        <div class="card">
            <h3>
                <!-- Modern Folder Icon -->
                <svg style="width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;color:var(--accent);" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                آرشیو فرم‌های فعال
            </h3>
            <div id="loading-list" style="text-align:center; padding:40px; color:var(--text-light); display:flex; flex-direction:column; align-items:center; gap:15px;">
                <span class="spinner spinner-large"></span>
                <span>در حال دریافت اطلاعات از سرور...</span>
            </div>
            <div id="forms-list-items" class="forms-grid"></div>
        </div>
    </div>
</div>

<!-- Modal مشاهده داده -->
<div id="dataModal" class="modal">
    <div class="modal-content modal-content-large">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px;">
            <h3 id="modalTitle" style="margin:0; font-size:1.1rem; color:var(--primary); display:flex; align-items:center; gap:8px;">
                <!-- Modern Table Icon -->
                <svg style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;" viewBox="0 0 24 24"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"></path></svg>
                داده‌های فرم
            </h3>
            <div style="display:flex; gap:10px;">
                <button onclick="printData()" class="btn btn-primary">
                    <!-- Modern Printer Icon -->
                    <svg viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    چاپ
                </button>
                <button onclick="closeModal('dataModal')" class="btn btn-secondary">بستن</button>
            </div>
        </div>
        <div id="tableContainer" style="min-height:200px; display:flex; align-items:center; justify-content:center;">
             <!-- Content fills here -->
        </div>
    </div>
</div>

<!-- Modal پیام مدرن -->
<div id="msgModal" class="modal" style="z-index:3000;">
    <div class="modal-content" style="max-width:400px; text-align:center;">
        <div style="margin:0 auto; width:50px; height:50px; background:#eff6ff; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--accent);">
            <!-- Info Icon -->
            <svg style="width:28px;height:28px;fill:none;stroke:currentColor;stroke-width:2;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        </div>
        <div class="msg-title" id="msgTitle" style="justify-content:center; font-size:1.2rem;">پیام</div>
        <div class="msg-body" id="msgBody">متن پیام</div>
        <div class="msg-footer" style="justify-content:center;">
            <button onclick="closeModal('msgModal')" class="btn btn-primary" style="width:100%">متوجه شدم</button>
        </div>
    </div>
</div>

<!-- Modal تاییدیه مدرن -->
<div id="confirmModal" class="modal" style="z-index:3000;">
    <div class="modal-content" style="max-width:400px;">
        <div class="msg-title" style="color:var(--warning)">
            <!-- Alert Triangle Icon -->
            <svg style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            تایید عملیات
        </div>
        <div class="msg-body" id="confirmBody">آیا مطمئن هستید؟</div>
        <div class="msg-footer">
            <button id="confirmYesBtn" class="btn btn-success">بله، انجام بده</button>
            <button onclick="closeModal('confirmModal')" class="btn btn-secondary">انصراف</button>
        </div>
    </div>
</div>

<!-- Modal تغییر رمز -->
<div id="passModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">تغییر رمز عبور</h3>
            <button onclick="closeModal('passModal')" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>
        <input type="password" id="oldPass" placeholder="رمز فعلی">
        <input type="password" id="newPass" placeholder="رمز جدید">
        <button onclick="changePassword(this)" class="btn btn-primary" style="width:100%">ذخیره رمز جدید</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 
    const BASE_FORM_URL = "https://amirdadgostar.github.io/site/form/N1.html";

    const FIELD_NAMES = {
        'short_text': 'متن کوتاه', 'long_text': 'متن بلند', 'number': 'فقط عدد',
        'national_code': 'کد ملی', 'phone': 'شماره تماس', 'single_choice': 'تک انتخابی',
        'multi_choice': 'چند انتخابی', 'static': 'متن نمایشی'
    };

    let fields = [];
    let currentUser = "";
    let confirmCallback = null;

    // بررسی ماندگاری لاگین
    window.onload = function() {
        const savedUser = localStorage.getItem('adminUser');
        if (savedUser) {
            currentUser = savedUser;
            document.getElementById('login-panel').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadFormsList();
        }
    };

    // سیستم پیام‌های مدرن
    function showMsg(title, text) {
        document.getElementById('msgTitle').innerText = title;
        document.getElementById('msgBody').innerText = text;
        document.getElementById('msgModal').style.display = 'flex';
    }

    function showConfirm(text, callback) {
        document.getElementById('confirmBody').innerText = text;
        confirmCallback = callback;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    document.getElementById('confirmYesBtn').onclick = function() {
        if (confirmCallback) confirmCallback();
        closeModal('confirmModal');
    };

    function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const btn = document.querySelector('#login-panel button');
        const originalText = btn.innerHTML;
        
        // Professional Spinner for Login
        btn.innerHTML = '<span class="spinner"></span> بررسی هویت...'; 
        btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", username: u, password: p }) })
        .then(r => r.json()).then(d => {
            if (d.status === 'success') {
                currentUser = u;
                localStorage.setItem('adminUser', u);
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadFormsList();
            } else {
                document.getElementById('login-msg').innerText = d.message;
                btn.innerHTML = originalText; btn.disabled = false;
            }
        }).catch(() => { btn.innerHTML = originalText; btn.disabled = false; showMsg("خطا", "خطا در اتصال به سرور"); });
    }

    function logout() {
        localStorage.removeItem('adminUser');
        location.reload();
    }

    function addField(data = null) {
        const typeRaw = data ? data.type : document.getElementById('fieldType').value;
        const typeLabel = FIELD_NAMES[typeRaw] || typeRaw;
        const id = Date.now() + Math.floor(Math.random() * 1000);
        
        let html = `
        <div class="field-box" id="f-${id}">
            <div class="field-header">
                <span class="badge">${typeLabel}</span>
                <button onclick="removeField(${id})" class="btn btn-danger" style="padding:4px 8px; width:30px; height:30px; border-radius:4px;" title="حذف فیلد">
                    <!-- Modern Trash Icon Small -->
                    <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
            <input type="text" class="lbl" placeholder="عنوان سوال یا فیلد..." value="${data ? data.label : ''}" style="margin-top:5px; font-weight:700;">`;
        
        if (typeRaw.includes('choice')) {
            // FIX: Uses strict flex column layout classes
            html += `<div class="opt-container" id="opt-wrap-${id}">
                     <small style="display:block; margin-bottom:5px; font-weight:bold; color:var(--text-light);">گزینه‌های انتخاب:</small>`;
            if (data && data.options) data.options.forEach(o => html += createOpt(o));
            else html += createOpt('');
            html += `<button onclick="addOpt(${id})" class="btn btn-secondary btn-add-opt" style="font-size:0.8rem;">+ افزودن گزینه جدید</button></div>`;
        }
        
        if (typeRaw === 'static') {
            html += `<textarea class="cnt" placeholder="متن نمایشی برای کاربر...">${data ? data.content : ''}</textarea>`;
        }

        if (typeRaw !== 'static') {
            const isReq = data && data.required ? 'checked' : '';
            html += `<label class="chk-wrap">
                        <input type="checkbox" class="req-chk" ${isReq}>
                        پاسخ به این فیلد اجباری باشد
                     </label>`;
        }

        html += `</div>`;
        document.getElementById('fields-container').insertAdjacentHTML('beforeend', html);
        fields.push({ id, type: typeRaw });
    }

    function createOpt(val) {
        // FIX: Ensures full width and correct alignment
        return `<div class="opt-row">
                <input type="text" class="opt-input" placeholder="عنوان گزینه" value="${val}">
                <button onclick="this.parentElement.remove()" class="btn-del-opt" title="حذف گزینه">
                    <svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"></path></svg>
                </button>
                </div>`;
    }
    
    // ====================================================
    // ویرایش کلیدی در اینجا اعمال شد
    // ====================================================
    function addOpt(id) { 
        // 1. به جای هر دکمه‌ای، دقیقاً دکمه "افزودن گزینه" با کلاس btn-add-opt را پیدا می‌کنیم.
        const addButton = document.querySelector(`#opt-wrap-${id} .btn-add-opt`);
        
        // 2. اگر دکمه با موفقیت پیدا شد، گزینه جدید را "قبل از آن" اضافه می‌کنیم.
        if (addButton) {
            addButton.insertAdjacentHTML('beforebegin', createOpt(''));
        } else {
            // این بخش برای جلوگیری از خطا در موارد نادر است
            console.error("Could not find the 'Add Option' button for container: " + id);
            // به عنوان یک راه حل جایگزین، به انتهای کانتینر اضافه می‌کنیم
            const container = document.getElementById(`opt-wrap-${id}`);
            if (container) {
                container.insertAdjacentHTML('beforeend', createOpt(''));
            }
        }
    }
    
    function removeField(id) { 
        showConfirm("آیا این فیلد از فرم حذف شود؟", function(){
            document.getElementById(`f-${id}`).remove(); fields = fields.filter(f => f.id !== id); 
        });
    }

    function saveForm(btn) {
        const title = document.getElementById('formTitle').value;
        if (!title || fields.length === 0) return showMsg("خطا", "عنوان فرم و حداقل یک فیلد الزامی است.");
        
        let finalFields = [];
        for (let f of fields) {
            const el = document.getElementById(`f-${f.id}`);
            let obj = { 
                type: f.type, 
                label: el.querySelector('.lbl') ? el.querySelector('.lbl').value : "",
                required: el.querySelector('.req-chk') ? el.querySelector('.req-chk').checked : false
            };
            
            if (f.type.includes('choice')) {
                let opts = [];
                el.querySelectorAll('.opt-input').forEach(i => { if(i.value.trim()) opts.push(i.value.trim()); });
                if(opts.length === 0) return showMsg("خطا", "لطفاً برای فیلدهای انتخابی حداقل یک گزینه وارد کنید.");
                obj.options = opts;
            }
            if (f.type === 'static') obj.content = el.querySelector('.cnt').value;
            finalFields.push(obj);
        }

        const original = btn.innerHTML;
        btn.innerHTML = '<span class="spinner"></span> در حال ذخیره...'; btn.disabled = true;
        
        fetch(API_URL, { 
            method: "POST", 
            body: JSON.stringify({ 
                action: "createForm", 
                data: { 
                    title, 
                    description: document.getElementById('formDesc').value,
                    successMessage: document.getElementById('successMsg').value,
                    fields: finalFields 
                } 
            }) 
        })
        .then(r => r.json()).then(d => {
            if(d.status === 'success') { showMsg("موفق", "✅ فرم با موفقیت ساخته و منتشر شد."); location.reload(); }
            else { showMsg("خطا", d.message); btn.innerHTML = original; btn.disabled = false; }
        }).catch(() => { showMsg("خطا", "خطا در برقراری ارتباط با سرور"); btn.innerHTML = original; btn.disabled = false; });
    }

    function loadFormsList() {
        const listDiv = document.getElementById('forms-list-items');
        listDiv.innerHTML = "";
        document.getElementById('loading-list').style.display = 'flex';
        
        fetch(`${API_URL}?action=getFormList`).then(r => r.json()).then(d => {
            document.getElementById('loading-list').style.display = 'none';
            if (d.status === 'success') {
                d.list.forEach(f => {
                    const dlLink = `${API_URL}?action=downloadCSV&formId=${f.id}`;
                    const formLink = `${BASE_FORM_URL}?id=${f.id}`;
                    
                    listDiv.innerHTML += `
                        <div class="form-card">
                            <div class="form-header">
                                <div class="form-icon">
                                    <svg style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                </div>
                                <div class="form-info">
                                    <div class="form-title">${f.title}</div>
                                    <div class="form-date">
                                        <svg style="width:14px;height:14px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                        ${new Date(f.date).toLocaleDateString('fa-IR')}
                                    </div>
                                </div>
                            </div>
                            <div class="action-bar">
                                <button onclick="copyLink('${formLink}', this)" class="btn btn-secondary btn-icon" title="کپی لینک عمومی">
                                    <!-- Link Icon -->
                                    <svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                                </button>
                                <button onclick="cloneForm('${f.id}', this)" class="btn btn-warning btn-icon" title="الگوگیری و ساخت کپی">
                                    <!-- Clone Icon -->
                                    <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                                <button onclick="viewData('${f.sheetName}', '${f.title}', this)" class="btn btn-accent btn-icon" title="مشاهده داده‌ها">
                                    <!-- Eye/Table Icon -->
                                    <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                                <a href="${dlLink}" class="btn btn-success btn-icon" title="دانلود اکسل" onclick="clickDl(this)" style="display:flex;align-items:center;">
                                    <!-- Download Icon -->
                                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                </a>
                                <button onclick="deleteForm('${f.id}', this)" class="btn btn-danger btn-icon" title="حذف فرم">
                                    <!-- Trash Icon -->
                                    <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>`;
                });
            }
        });
    }

    function clickDl(el) {
        el.style.opacity = "0.5";
        setTimeout(() => el.style.opacity = "1", 2000);
    }

    function copyLink(url, btn) {
        const original = btn.innerHTML;
        // Check mark icon for success
        btn.innerHTML = `<svg style="color:var(--success)" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
        navigator.clipboard.writeText(url);
        setTimeout(() => btn.innerHTML = original, 2000);
    }

    function cloneForm(id, btn) {
        showConfirm("آیا می‌خواهید از این فرم یک کپی ایجاد کنید؟", function() {
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true;
            fetch(`${API_URL}?action=getForm&formId=${id}`).then(r => r.json()).then(d => {
                if(d.status==='success') {
                    document.getElementById('fields-container').innerHTML = ""; fields = [];
                    document.getElementById('formTitle').value = d.structure.title + " (کپی)";
                    document.getElementById('formDesc').value = d.structure.description;
                    document.getElementById('successMsg').value = d.structure.successMessage || "";
                    d.structure.fields.forEach(f => addField(f));
                    window.scrollTo({top:0, behavior:'smooth'});
                    showMsg("انجام شد", "اطلاعات فرم در ویرایشگر کپی شد. اکنون می‌توانید تغییرات را اعمال و ذخیره کنید.");
                }
                btn.innerHTML = original; btn.disabled = false;
            });
        });
    }

    function deleteForm(id, btn) {
        showConfirm("هشدار: آیا از حذف کامل این فرم و داده‌های آن اطمینان دارید؟ این عملیات غیرقابل بازگشت است.", function() {
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true;
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "deleteForm", formId: id }) })
            .then(r => r.json()).then(d => { showMsg("پیام سیستم", d.message); loadFormsList(); });
        });
    }

    function viewData(sh, t, btn) {
        const original = btn.innerHTML;
        btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true;
        document.getElementById('modalTitle').innerHTML = `
            <svg style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;" viewBox="0 0 24 24"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"></path></svg>
            ${t}`;
        const c = document.getElementById('tableContainer'); 
        c.innerHTML = '<div style="text-align:center; padding:30px;"><span class="spinner spinner-large"></span><br><br>در حال دریافت داده‌ها...</div>';
        document.getElementById('dataModal').style.display = 'flex';
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getSheetData", sheetName: sh }) })
        .then(r => r.json()).then(d => {
            btn.innerHTML = original; btn.disabled = false;
            if(d.status==='success' && d.data.length) {
                let h = '<table id="printTable">';
                d.data.forEach((r, i) => {
                    h += i===0 ? '<thead><tr>' : '<tr>';
                    r.forEach(c => h += i===0 ? `<th>${c}</th>` : `<td>${c}</td>`);
                    h += i===0 ? '</tr></thead><tbody>' : '</tr>';
                });
                c.innerHTML = h + '</tbody></table>';
            } else c.innerHTML = "<p style='padding:20px; text-align:center; color:var(--text-light);'>هیچ داده‌ای برای این فرم ثبت نشده است.</p>";
        });
    }

    function printData() {
        const content = document.getElementById('tableContainer').innerHTML;
        const win = window.open('', '', 'height=600,width=800');
        win.document.write('<html dir="rtl"><head><title>چاپ گزارش</title><style>body{font-family:Tahoma} table{width:100%;border-collapse:collapse} th,td{border:1px solid #000;padding:5px;text-align:right} th{background:#eee}</style></head><body>');
        win.document.write('<h2 style="text-align:center">گزارش داده‌های فرم</h2>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }

    function openChangePassModal() { document.getElementById('passModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function changePassword(btn) {
        const o = document.getElementById('oldPass').value; const n = document.getElementById('newPass').value;
        const original = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span> در حال ذخیره...'; btn.disabled = true;
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "changePassword", username: currentUser, oldPassword: o, newPassword: n }) })
        .then(r => r.json()).then(d => { 
            showMsg("پیام سیستم", d.message); btn.innerHTML = original; btn.disabled = false;
            if(d.status==='success') closeModal('passModal'); 
        });
    }
</script>
</body>
</html>
