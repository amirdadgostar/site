
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…â€ŒÙ‡Ø§</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --primary-color: #2563eb; --secondary-color: #1e293b; --accent-color: #3b82f6;
            --success-color: #10b981; --danger-color: #ef4444; --warning-color: #f59e0b;
            --bg-color: #f3f4f6; --card-bg: #ffffff; --text-main: #1f2937;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius-md: 0.5rem;
        }
        * { box-sizing: border-box; outline: none; transition: all 0.2s ease-in-out; }
        body { font-family: 'Vazirmatn', Tahoma, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding-bottom: 80px; }
        
        /* Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ */
        #login-panel { display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, var(--secondary-color), var(--primary-color)); }
        .login-card { 
            background: var(--card-bg); padding: 40px; width: 100%; max-width: 420px; 
            border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); 
            text-align: center; display: flex; flex-direction: column; gap: 15px;
        }
        .login-card h2 { margin-top: 0; color: var(--primary-color); font-size: 1.5rem; }
        .login-card input { margin-bottom: 5px; }

        /* Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª */
        #admin-panel { display: none; }
        header { position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 30px; box-shadow: var(--shadow-md); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.25rem; font-weight: 800; color: var(--primary-color); }
        
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); border-radius: var(--radius-md); padding: 25px; box-shadow: var(--shadow-md); margin-bottom: 20px; }
        
        input[type="text"], input[type="password"], select, textarea { 
            width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e5e7eb; 
            border-radius: var(--radius-md); background: #f9fafb; font-family: inherit;
        }
        input:focus { border-color: var(--primary-color); background: white; }
        
        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn { padding: 10px 20px; border: none; border-radius: var(--radius-md); cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary-color); }
        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-warning { background: var(--warning-color); }
        .btn-secondary { background: #e5e7eb; color: var(--text-main); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        /* Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ³Øª ÙØ±Ù… */
        .form-item { background: #fff; border: 1px solid #f3f4f6; border-radius: var(--radius-md); padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .action-group { display: flex; gap: 5px; flex-wrap: wrap; }
        
        /* Ø¨Ø§Ú©Ø³ ÙÛŒÙ„Ø¯Ù‡Ø§ */
        .field-box { background: #f8fafc; border-right: 4px solid var(--primary-color); padding: 20px; margin-bottom: 15px; border-radius: var(--radius-md); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .field-title-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .field-type-badge { background: #e0e7ff; color: var(--primary-color); padding: 3px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³ Ø§Ø¬Ø¨Ø§Ø±ÛŒ */
        .required-wrapper { margin-top: 10px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #555; }
        .required-wrapper input { width: auto; margin: 0; cursor: pointer; }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ (Ø¹Ù…ÙˆØ¯ÛŒ) */
        .opt-container { margin-top: 10px; border: 1px dashed #cbd5e1; padding: 10px; border-radius: 8px; background: #fff; }
        .opt-row { display: flex; gap: 10px; margin-bottom: 8px; width: 100%; align-items: center; }
        .opt-input { flex-grow: 1; margin-bottom: 0 !important; }
        .btn-del-opt { background: #fee2e2; color: #ef4444; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 1rem; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; display: flex; flex-direction: column; gap: 15px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; position: sticky; top: 0; }
    </style>
</head>
<body>

<div id="login-panel">
    <div class="login-card">
        <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
        <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
        <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button onclick="login()" class="btn btn-primary" style="width:100%; padding: 14px; font-size: 1.1rem;">ÙˆØ±ÙˆØ¯ Ø§Ù…Ù†</button>
        <p id="login-msg" style="color:var(--danger-color); margin:0; font-size:0.9rem;"></p>
    </div>
</div>

<div id="admin-panel">
    <header>
        <div class="brand">Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…â€ŒØ³Ø§Ø²</div>
        <div>
            <button onclick="openChangePassModal()" class="btn btn-secondary">ØªØºÛŒÛŒØ± Ø±Ù…Ø²</button>
            <button onclick="logout()" class="btn btn-danger">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="container dashboard-grid">
        <div class="card">
            <h3>ğŸ“ Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø³Ø§Ø®Øª ÙØ±Ù…</h3>
            <input type="text" id="formTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙØ±Ù… (Ø§Ù„Ø²Ø§Ù…ÛŒ)">
            <textarea id="formDesc" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ±Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>
            <div id="fields-container"></div>
            
            <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-top:20px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold; color:var(--primary-color);">Ø§ÙØ²ÙˆØ¯Ù† ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯:</label>
                <div style="display:flex; gap:10px;">
                    <select id="fieldType" style="margin-bottom:0; flex:1;">
                        <option value="short_text">Ù…ØªÙ† Ú©ÙˆØªØ§Ù‡</option>
                        <option value="long_text">Ù…ØªÙ† Ø¨Ù„Ù†Ø¯</option>
                        <option value="number">ÙÙ‚Ø· Ø¹Ø¯Ø¯</option>
                        <option value="national_code">Ú©Ø¯ Ù…Ù„ÛŒ</option>
                        <option value="phone">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</option>
                        <option value="single_choice">Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (ØªÚ© Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)</option>
                        <option value="multi_choice">Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Ú†Ù†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)</option>
                        <option value="static">Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ</option>
                    </select>
                    <button onclick="addField()" class="btn btn-primary">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
            </div>
            <button onclick="saveForm()" class="btn btn-success" style="width:100%; margin-top:20px; padding:15px; font-size:1.1rem;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ù†ØªØ´Ø§Ø± ÙØ±Ù…</button>
        </div>

        <div class="card">
            <h3>ğŸ“‚ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…â€ŒÙ‡Ø§</h3>
            <div id="loading-list">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª...</div>
            <div id="forms-list-items"></div>
        </div>
    </div>
</div>

<!-- Modal Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø§Ø¯Ù‡ -->
<div id="dataModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="modalTitle" style="margin:0;">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
            <div>
                <button onclick="printData()" class="btn btn-primary">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
                <button onclick="closeModal('dataModal')" class="btn btn-secondary">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
        <div id="tableContainer" style="overflow-x:auto;"></div>
    </div>
</div>

<!-- Modal ØªØºÛŒÛŒØ± Ø±Ù…Ø² -->
<div id="passModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <div style="display:flex; justify-content:space-between;">
            <h3>ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h3>
            <button onclick="closeModal('passModal')" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <input type="password" id="oldPass" placeholder="Ø±Ù…Ø² ÙØ¹Ù„ÛŒ">
        <input type="password" id="newPass" placeholder="Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯">
        <button onclick="changePassword()" class="btn btn-primary" style="width:100%">ØªØºÛŒÛŒØ± Ø±Ù…Ø²</button>
    </div>
</div>

<script>
    // ğŸ‘‡ğŸ‘‡ Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 
    const BASE_FORM_URL = "https://amirdadgostar.github.io/site/form/N1.html";

    let fields = [];
    let currentUser = "";

    // Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§
    const FIELD_NAMES = {
        'short_text': 'Ù…ØªÙ† Ú©ÙˆØªØ§Ù‡',
        'long_text': 'Ù…ØªÙ† Ø¨Ù„Ù†Ø¯',
        'number': 'ÙÙ‚Ø· Ø¹Ø¯Ø¯',
        'national_code': 'Ú©Ø¯ Ù…Ù„ÛŒ',
        'phone': 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†',
        'single_choice': 'Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (ØªÚ©)',
        'multi_choice': 'Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Ú†Ù†Ø¯)',
        'static': 'Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ'
    };

    function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const btn = document.querySelector('#login-panel button');
        btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ..."; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", username: u, password: p }) })
        .then(r => r.json()).then(d => {
            if (d.status === 'success') {
                currentUser = u;
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadFormsList();
            } else {
                document.getElementById('login-msg').innerText = d.message;
                btn.innerText = "ÙˆØ±ÙˆØ¯ Ø§Ù…Ù†"; btn.disabled = false;
            }
        }).catch(() => { btn.innerText = "ÙˆØ±ÙˆØ¯ Ø§Ù…Ù†"; btn.disabled = false; alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„"); });
    }

    function logout() { location.reload(); }

    function addField(data = null) {
        const typeRaw = data ? data.type : document.getElementById('fieldType').value;
        const typeLabel = FIELD_NAMES[typeRaw] || typeRaw;
        const id = Date.now() + Math.floor(Math.random() * 1000);
        
        let html = `
        <div class="field-box" id="f-${id}">
            <div class="field-title-bar">
                <span class="field-type-badge">${typeLabel}</span>
                <button onclick="removeField(${id})" style="background:#fee2e2; color:#ef4444; border:none; padding:4px 10px; border-radius:4px; cursor:pointer;">Ø­Ø°Ù</button>
            </div>
            <input type="text" class="lbl" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙÛŒÙ„Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯" value="${data ? data.label : ''}" style="margin-top:5px; font-weight:bold;">`;
        
        if (typeRaw.includes('choice')) {
            html += `<div class="opt-container" id="opt-wrap-${id}">
                     <small style="color:#666; display:block; margin-bottom:5px;">Ù„ÛŒØ³Øª Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</small>`;
            if (data && data.options) data.options.forEach(o => html += createOpt(o));
            else html += createOpt('');
            html += `<button onclick="addOpt(${id})" class="btn btn-secondary" style="width:100%; margin-top:5px; font-size:0.9rem;">â• Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø²ÛŒÙ†Ù‡ Ø¯ÛŒÚ¯Ø±</button></div>`;
        }
        
        if (typeRaw === 'static') {
            html += `<textarea class="cnt" placeholder="Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±...">${data ? data.content : ''}</textarea>`;
        }

        // Ú†Ú©â€ŒØ¨Ø§Ú©Ø³ Ø§Ø¬Ø¨Ø§Ø±ÛŒ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØºÛŒØ± Ø§Ø³ØªØ§ØªÛŒÚ©)
        if (typeRaw !== 'static') {
            const isReq = data && data.required ? 'checked' : '';
            html += `<div class="required-wrapper">
                        <input type="checkbox" class="req-chk" ${isReq} id="req-${id}">
                        <label for="req-${id}">Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ <b>Ø§Ø¬Ø¨Ø§Ø±ÛŒ</b> Ø§Ø³Øª</label>
                     </div>`;
        }

        html += `</div>`;
        document.getElementById('fields-container').insertAdjacentHTML('beforeend', html);
        fields.push({ id, type: typeRaw });
    }

    function createOpt(val) {
        return `<div class="opt-row">
                <input type="text" class="opt-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú¯Ø²ÛŒÙ†Ù‡" value="${val}">
                <button onclick="this.parentElement.remove()" class="btn-del-opt">Ø­Ø°Ù</button>
                </div>`;
    }
    
    function addOpt(id) {
        document.querySelector(`#opt-wrap-${id} button`).insertAdjacentHTML('beforebegin', createOpt(''));
    }
    
    function removeField(id) { document.getElementById(`f-${id}`).remove(); fields = fields.filter(f => f.id !== id); }

    function saveForm() {
        const title = document.getElementById('formTitle').value;
        if (!title || fields.length === 0) return alert("Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙÛŒÙ„Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
        
        let finalFields = [];
        for (let f of fields) {
            const el = document.getElementById(`f-${f.id}`);
            let obj = { 
                type: f.type, 
                label: el.querySelector('.lbl') ? el.querySelector('.lbl').value : "",
                required: el.querySelector('.req-chk') ? el.querySelector('.req-chk').checked : false
            };
            
            if (f.type.includes('choice')) {
                let opts = [];
                el.querySelectorAll('.opt-input').forEach(i => { if(i.value.trim()) opts.push(i.value.trim()); });
                if(opts.length === 0) return alert("Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
                obj.options = opts;
            }
            if (f.type === 'static') obj.content = el.querySelector('.cnt').value;
            finalFields.push(obj);
        }

        const btn = document.querySelector('.btn-success'); 
        const oldText = btn.innerHTML;
        btn.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø³Ø§Ø®Øª Ø´ÛŒØª..."; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "createForm", data: { title, description: document.getElementById('formDesc').value, fields: finalFields } }) })
        .then(r => r.json()).then(d => {
            if(d.status === 'success') { alert("âœ… ÙØ±Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯."); location.reload(); }
            else { alert(d.message); btn.innerHTML = oldText; btn.disabled = false; }
        }).catch(() => { alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·"); btn.innerHTML = oldText; btn.disabled = false; });
    }

    function loadFormsList() {
        const listDiv = document.getElementById('forms-list-items');
        listDiv.innerHTML = "";
        fetch(`${API_URL}?action=getFormList`).then(r => r.json()).then(d => {
            document.getElementById('loading-list').style.display = 'none';
            if (d.status === 'success') {
                d.list.forEach(f => {
                    // Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ÛŒÙ†
                    const dlLink = `${API_URL}?action=downloadCSV&formId=${f.id}`;
                    const formLink = `${BASE_FORM_URL}?id=${f.id}`;
                    
                    listDiv.innerHTML += `
                        <div class="form-item">
                            <div>
                                <strong style="font-size:1.1rem; color:var(--primary-color);">${f.title}</strong><br>
                                <small style="color:#666;">${new Date(f.date).toLocaleDateString('fa-IR')}</small>
                            </div>
                            <div class="action-group">
                                <button onclick="copyLink('${formLink}', this)" class="btn btn-secondary btn-sm">ğŸ”— Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©</button>
                                <button onclick="cloneForm('${f.id}', this)" class="btn btn-warning btn-sm">Ø§Ù„Ú¯Ùˆ</button>
                                <button onclick="viewData('${f.sheetName}', '${f.title}', this)" class="btn btn-secondary btn-sm">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
                                <a href="${dlLink}" class="btn btn-primary btn-sm" style="text-decoration:none;" onclick="clickDl(this)">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</a>
                                <button onclick="deleteForm('${f.id}', this)" class="btn btn-danger btn-sm">Ø­Ø°Ù</button>
                            </div>
                        </div>`;
                });
            }
        });
    }
    
    function clickDl(el) {
        const original = el.innerText;
        el.innerText = "â³ Ø¯Ø§Ù†Ù„ÙˆØ¯...";
        setTimeout(() => el.innerText = original, 3000);
    }

    function copyLink(url, btn) {
        const original = btn.innerText;
        btn.innerText = "Ú©Ù¾ÛŒ Ø´Ø¯!";
        navigator.clipboard.writeText(url);
        setTimeout(() => btn.innerText = original, 2000);
    }

    function cloneForm(id, btn) {
        if(!confirm("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ† ÙØ±Ù… ÛŒÚ© Ú©Ù¾ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø³Ø§Ø²ÛŒØ¯ØŸ")) return;
        const original = btn.innerText;
        btn.innerText = "â³..."; btn.disabled = true;
        
        fetch(`${API_URL}?action=getForm&formId=${id}`).then(r => r.json()).then(d => {
            if(d.status==='success') {
                document.getElementById('fields-container').innerHTML = ""; fields = [];
                document.getElementById('formTitle').value = d.structure.title + " (Ø¬Ø¯ÛŒØ¯)";
                document.getElementById('formDesc').value = d.structure.description;
                d.structure.fields.forEach(f => addField(f));
                window.scrollTo({top:0, behavior:'smooth'});
            }
            btn.innerText = original; btn.disabled = false;
        });
    }
    
    function deleteForm(id, btn) {
        if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† ÙØ±Ù… Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!")) return;
        const original = btn.innerText;
        btn.innerText = "â³..."; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "deleteForm", formId: id }) })
        .then(r => r.json()).then(d => { alert(d.message); loadFormsList(); });
    }

    function viewData(sh, t, btn) {
        const original = btn.innerText;
        btn.innerText = "â³..."; btn.disabled = true;
        
        document.getElementById('modalTitle').innerText = t;
        const c = document.getElementById('tableContainer'); c.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...";
        document.getElementById('dataModal').style.display = 'flex';
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getSheetData", sheetName: sh }) })
        .then(r => r.json()).then(d => {
            btn.innerText = original; btn.disabled = false;
            if(d.status==='success' && d.data.length) {
                let h = '<table id="printTable">';
                d.data.forEach((r, i) => {
                    h += i===0 ? '<thead><tr>' : '<tr>';
                    r.forEach(c => h += i===0 ? `<th>${c}</th>` : `<td>${c}</td>`);
                    h += i===0 ? '</tr></thead><tbody>' : '</tr>';
                });
                c.innerHTML = h + '</tbody></table>';
            } else c.innerHTML = "<p style='text-align:center'>Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
        }).catch(() => { btn.innerText = original; btn.disabled = false; });
    }

    function printData() {
        const content = document.getElementById('tableContainer').innerHTML;
        const win = window.open('', '', 'height=600,width=800');
        win.document.write('<html dir="rtl"><head><title>Ú†Ø§Ù¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</title>');
        win.document.write('<style>body{font-family:Tahoma,sans-serif;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #000;padding:8px;text-align:right;} th{background:#eee;}</style>');
        win.document.write('</head><body>');
        win.document.write(document.getElementById('modalTitle').innerText + '<br><br>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }

    function openChangePassModal() { document.getElementById('passModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function changePassword() {
        const o = document.getElementById('oldPass').value; const n = document.getElementById('newPass').value;
        const btn = document.querySelector('#passModal button');
        const oldText = btn.innerText;
        btn.innerText = "â³..."; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "changePassword", username: currentUser, oldPassword: o, newPassword: n }) })
        .then(r => r.json()).then(d => { 
            alert(d.message); 
            btn.innerText = oldText; btn.disabled = false;
            if(d.status==='success') closeModal('passModal'); 
        });
    }
</script>
</body>
</html>
