    <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ ÙØ±Ù…â€ŒÙ‡Ø§</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --primary: #4338ca; --primary-hover: #3730a3;
            --bg: #f3f4f6; --surface: #ffffff;
            --text-main: #111827; --text-sec: #6b7280;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --border: #e5e7eb; --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; transition: all 0.2s ease; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 50px; }

        /* Login Page */
        #login-panel {
            display: flex; align-items: center; justify-content: center; height: 100vh;
            background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%);
        }
        .login-card {
            background: var(--surface); padding: 40px; width: 100%; max-width: 400px;
            border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
            text-align: center;
        }
        .login-icon { width: 60px; height: 60px; background: #e0e7ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: var(--primary); }

        /* Admin Layout */
        #admin-panel { display: none; }
        header {
            position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px); border-bottom: 1px solid var(--border);
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .grid-layout { display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 25px; }
        @media (max-width: 850px) { .grid-layout { grid-template-columns: 1fr; } }

        .card { background: var(--surface); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        h3 { margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }

        /* Form Elements */
        input, textarea, select {
            width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border);
            border-radius: 8px; font-family: inherit; font-size: 0.95rem; background: #f9fafb;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.1); }

        /* Buttons & Icons */
        .btn {
            padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.9rem; position: relative; overflow: hidden;
        }
        .btn svg { width: 18px; height: 18px; }
        .btn:disabled { opacity: 0.7; cursor: wait; }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-secondary { background: #e5e7eb; color: var(--text-main); }
        .btn-ghost { background: transparent; color: var(--text-sec); border: 1px solid var(--border); }

        /* Form List */
        .form-item {
            background: #fff; border: 1px solid var(--border); border-radius: 10px;
            padding: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 12px;
            transition: transform 0.2s;
        }
        .form-item:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--primary); }
        .form-meta { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .form-title { font-weight: bold; font-size: 1.1rem; color: var(--text-main); }
        .form-date { font-size: 0.8rem; color: var(--text-sec); }
        
        .action-bar { display: flex; gap: 8px; flex-wrap: wrap; }
        .action-bar .btn { flex: 1; min-width: 100px; font-size: 0.8rem; padding: 8px; }

        /* Field Builder */
        .field-box {
            background: #f8fafc; border: 1px solid var(--border); border-right: 4px solid var(--primary);
            padding: 15px; margin-bottom: 10px; border-radius: 8px;
        }
        .field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .badge { background: #e0e7ff; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }

        /* Options */
        .opt-container { background: white; padding: 10px; border: 1px dashed #cbd5e1; border-radius: 8px; margin-top: 10px; }
        .opt-row { display: flex; gap: 8px; margin-bottom: 5px; align-items: center; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content {
            background: white; width: 90%; max-width: 900px; height: 80vh; border-radius: 16px;
            display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fafafa; border-radius: 16px 16px 0 0; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid var(--border); text-align: left; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; position: sticky; top: 0; }

        /* Checkbox & Radio Custom */
        .custom-chk { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; user-select: none; }
        .custom-chk input { width: 18px; height: 18px; margin: 0; accent-color: var(--primary); }
    </style>
</head>
<body>

<!-- SVG Definitions -->
<svg style="display: none;">
    <symbol id="icon-login" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
    <symbol id="icon-save" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></symbol>
    <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
    <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
    <symbol id="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></symbol>
    <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
    <symbol id="icon-key" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></symbol>
    <symbol id="icon-logout" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></symbol>
    <symbol id="icon-print" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></symbol>
    <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
</svg>

<div id="login-panel">
    <div class="login-card">
        <div class="login-icon"><svg width="32" height="32"><use href="#icon-key"/></svg></div>
        <h2>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
        <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
        <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button onclick="login()" class="btn btn-primary" style="width:100%; padding: 14px;">
            <svg><use href="#icon-login"/></svg> ÙˆØ±ÙˆØ¯ Ø§Ù…Ù†
        </button>
        <p id="login-msg" style="color:var(--danger); margin-top:10px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="admin-panel">
    <header>
        <div class="brand"><svg width="24" height="24" style="color:var(--primary)"><use href="#icon-edit"/></svg> Ø³Ø§Ù…Ø§Ù†Ù‡ ÙØ±Ù…â€ŒØ³Ø§Ø²</div>
        <div style="display:flex; gap:10px;">
            <button onclick="openChangePassModal()" class="btn btn-ghost"><svg><use href="#icon-key"/></svg> Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</button>
            <button onclick="logout()" class="btn btn-danger"><svg><use href="#icon-logout"/></svg> Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="container grid-layout">
        <div class="card">
            <h3><svg><use href="#icon-plus"/></svg> Ø·Ø±Ø§Ø­ÛŒ ÙØ±Ù… Ø¬Ø¯ÛŒØ¯</h3>
            <input type="text" id="formTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙØ±Ù… (Ù…Ø«Ù„Ø§Ù‹: ÙØ±Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù…)">
            <textarea id="formDesc" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ±Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>
            
            <div id="fields-container"></div>
            
            <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-top:20px; border:1px solid #dbeafe;">
                <label style="font-weight:bold; color:var(--primary); display:block; margin-bottom:8px;">Ø§ÙØ²ÙˆØ¯Ù† ÙÛŒÙ„Ø¯:</label>
                <div style="display:flex; gap:10px;">
                    <select id="fieldType" style="margin-bottom:0; flex:1;">
                        <option value="short_text">Ù…ØªÙ† Ú©ÙˆØªØ§Ù‡</option>
                        <option value="long_text">Ù…ØªÙ† Ø¨Ù„Ù†Ø¯</option>
                        <option value="number">ÙÙ‚Ø· Ø¹Ø¯Ø¯</option>
                        <option value="national_code">Ú©Ø¯ Ù…Ù„ÛŒ (Ù‡ÙˆØ´Ù…Ù†Ø¯)</option>
                        <option value="phone">Ù…ÙˆØ¨Ø§ÛŒÙ„ (Û±Û± Ø±Ù‚Ù…)</option>
                        <option value="single_choice">Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (ØªÚ©)</option>
                        <option value="multi_choice">Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Ú†Ù†Ø¯)</option>
                        <option value="static">Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ</option>
                    </select>
                    <button onclick="addField()" class="btn btn-primary"><svg><use href="#icon-plus"/></svg> Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
            </div>
            <button onclick="saveForm()" class="btn btn-success" style="width:100%; margin-top:20px; padding:15px; font-size:1.1rem;">
                <svg><use href="#icon-save"/></svg> Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ù†ØªØ´Ø§Ø± ÙØ±Ù…
            </button>
        </div>

        <div class="card">
            <h3><svg><use href="#icon-edit"/></svg> ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
            <div id="loading-list" style="text-align:center; color:var(--text-sec);">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª...</div>
            <div id="forms-list-items"></div>
        </div>
    </div>
</div>

<!-- Modal Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø§Ø¯Ù‡ -->
<div id="dataModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle" style="margin:0; border:none;">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="printData()" class="btn btn-primary"><svg><use href="#icon-print"/></svg> Ú†Ø§Ù¾</button>
                <button onclick="closeModal('dataModal')" class="btn btn-secondary"><svg><use href="#icon-x"/></svg> Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
        <div class="modal-body">
            <div id="tableContainer" style="overflow-x:auto;"></div>
        </div>
    </div>
</div>

<!-- Modal ØªØºÛŒÛŒØ± Ø±Ù…Ø² -->
<div id="passModal" class="modal">
    <div class="modal-content" style="max-width:400px; height:auto;">
        <div class="modal-header">
            <h3 style="margin:0; border:none;">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h3>
            <button onclick="closeModal('passModal')" class="btn btn-ghost" style="padding:5px;"><svg><use href="#icon-x"/></svg></button>
        </div>
        <div class="modal-body">
            <input type="password" id="oldPass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙØ¹Ù„ÛŒ">
            <input type="password" id="newPass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯">
            <button onclick="changePassword()" class="btn btn-primary" style="width:100%"><svg><use href="#icon-save"/></svg> Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
        </div>
    </div>
</div>

<script>
    // ğŸ‘‡ğŸ‘‡ Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 
    const BASE_FORM_URL = "https://amirdadgostar.github.io/site/form/N1.html";

    let fields = [];
    let currentUser = "";
    const FIELD_NAMES = {
        'short_text': 'Ù…ØªÙ† Ú©ÙˆØªØ§Ù‡', 'long_text': 'Ù…ØªÙ† Ø¨Ù„Ù†Ø¯', 'number': 'Ø¹Ø¯Ø¯',
        'national_code': 'Ú©Ø¯ Ù…Ù„ÛŒ', 'phone': 'Ù…ÙˆØ¨Ø§ÛŒÙ„',
        'single_choice': 'ØªÚ© Ø§Ù†ØªØ®Ø§Ø¨ÛŒ', 'multi_choice': 'Ú†Ù†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ', 'static': 'Ù…ØªÙ† Ø«Ø§Ø¨Øª'
    };

    // --- Check Login Persistence ---
    window.onload = function() {
        if(localStorage.getItem('isLoggedIn') === 'true' && localStorage.getItem('username')) {
            currentUser = localStorage.getItem('username');
            showAdmin();
        }
    };

    function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const btn = document.querySelector('#login-panel button');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = `<span class="spinner"></span> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...`; 
        btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", username: u, password: p }) })
        .then(r => r.json()).then(d => {
            if (d.status === 'success') {
                currentUser = u;
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('username', u);
                showAdmin();
            } else {
                document.getElementById('login-msg').innerText = d.message;
                btn.innerHTML = originalText; btn.disabled = false;
            }
        }).catch(() => { btn.innerHTML = originalText; btn.disabled = false; alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„"); });
    }

    function showAdmin() {
        document.getElementById('login-panel').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        loadFormsList();
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    function addField(data = null) {
        const typeRaw = data ? data.type : document.getElementById('fieldType').value;
        const typeLabel = FIELD_NAMES[typeRaw] || typeRaw;
        const id = Date.now() + Math.floor(Math.random() * 1000);
        
        let html = `
        <div class="field-box" id="f-${id}">
            <div class="field-header">
                <span class="badge">${typeLabel}</span>
                <button onclick="removeField(${id})" class="btn btn-ghost" style="color:var(--danger); padding:4px;"><svg><use href="#icon-trash"/></svg></button>
            </div>
            <input type="text" class="lbl" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙÛŒÙ„Ø¯" value="${data ? data.label : ''}" style="font-weight:bold;">`;
        
        if (typeRaw.includes('choice')) {
            html += `<div class="opt-container" id="opt-wrap-${id}">
                     <small style="color:#666; display:block; margin-bottom:5px;">Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</small>`;
            if (data && data.options) data.options.forEach(o => html += createOpt(o));
            else html += createOpt('');
            html += `<button onclick="addOpt(${id})" class="btn btn-secondary" style="width:100%; margin-top:8px; font-size:0.8rem;"><svg><use href="#icon-plus"/></svg> Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯</button></div>`;
        }
        
        if (typeRaw === 'static') {
            html += `<textarea class="cnt" placeholder="Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ...">${data ? data.content : ''}</textarea>`;
        }

        if (typeRaw !== 'static') {
            const isReq = data && data.required ? 'checked' : '';
            html += `<label class="custom-chk" style="margin-top:10px;">
                        <input type="checkbox" class="req-chk" ${isReq}> Ù¾Ø§Ø³Ø® Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª
                     </label>`;
        }

        html += `</div>`;
        document.getElementById('fields-container').insertAdjacentHTML('beforeend', html);
        fields.push({ id, type: typeRaw });
    }

    function createOpt(val) {
        return `<div class="opt-row">
                <input type="text" class="opt-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú¯Ø²ÛŒÙ†Ù‡" value="${val}" style="margin-bottom:0;">
                <button onclick="this.parentElement.remove()" class="btn btn-ghost" style="color:var(--danger); padding:5px;"><svg><use href="#icon-trash"/></svg></button>
                </div>`;
    }
    
    function addOpt(id) { document.querySelector(`#opt-wrap-${id} button`).insertAdjacentHTML('beforebegin', createOpt('')); }
    function removeField(id) { document.getElementById(`f-${id}`).remove(); fields = fields.filter(f => f.id !== id); }

    function saveForm() {
        const title = document.getElementById('formTitle').value;
        if (!title || fields.length === 0) return alert("Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙÛŒÙ„Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
        
        let finalFields = [];
        for (let f of fields) {
            const el = document.getElementById(`f-${f.id}`);
            let obj = { 
                type: f.type, 
                label: el.querySelector('.lbl') ? el.querySelector('.lbl').value : "",
                required: el.querySelector('.req-chk') ? el.querySelector('.req-chk').checked : false
            };
            
            if (f.type.includes('choice')) {
                let opts = [];
                el.querySelectorAll('.opt-input').forEach(i => { if(i.value.trim()) opts.push(i.value.trim()); });
                if(opts.length === 0) return alert("Ù„Ø·ÙØ§Ù‹ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
                obj.options = opts;
            }
            if (f.type === 'static') obj.content = el.querySelector('.cnt').value;
            finalFields.push(obj);
        }

        const btn = document.querySelector('.btn-success'); 
        const oldHtml = btn.innerHTML;
        btn.innerHTML = `Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...`; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "createForm", data: { title, description: document.getElementById('formDesc').value, fields: finalFields } }) })
        .then(r => r.json()).then(d => {
            if(d.status === 'success') { alert("âœ… ÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯"); location.reload(); }
            else { alert(d.message); btn.innerHTML = oldHtml; btn.disabled = false; }
        });
    }

    function loadFormsList() {
        const listDiv = document.getElementById('forms-list-items');
        listDiv.innerHTML = "";
        fetch(`${API_URL}?action=getFormList`).then(r => r.json()).then(d => {
            document.getElementById('loading-list').style.display = 'none';
            if (d.status === 'success') {
                d.list.forEach(f => {
                    const dlLink = `${API_URL}?action=downloadCSV&formId=${f.id}`;
                    const formLink = `${BASE_FORM_URL}?id=${f.id}`;
                    
                    listDiv.innerHTML += `
                        <div class="form-item">
                            <div class="form-meta">
                                <span class="form-title">${f.title}</span>
                                <span class="form-date">${new Date(f.date).toLocaleDateString('fa-IR')}</span>
                            </div>
                            <div class="action-bar">
                                <button onclick="copyLink('${formLink}', this)" class="btn btn-secondary"><svg><use href="#icon-copy"/></svg> Ù„ÛŒÙ†Ú©</button>
                                <button onclick="cloneForm('${f.id}', this)" class="btn btn-warning"><svg><use href="#icon-plus"/></svg> Ø§Ù„Ú¯Ùˆ</button>
                                <button onclick="viewData('${f.sheetName}', '${f.title}', this)" class="btn btn-secondary"><svg><use href="#icon-eye"/></svg> Ø¯ÛŒØªØ§</button>
                                <a href="${dlLink}" class="btn btn-primary" style="text-decoration:none; display:inline-flex;" onclick="clickDl(this)"><svg><use href="#icon-download"/></svg> Ø§Ú©Ø³Ù„</a>
                                <button onclick="deleteForm('${f.id}', this)" class="btn btn-danger"><svg><use href="#icon-trash"/></svg> Ø­Ø°Ù</button>
                            </div>
                        </div>`;
                });
            }
        });
    }
    
    function clickDl(el) { const org = el.innerHTML; el.innerHTML = "Ø¯Ø§Ù†Ù„ÙˆØ¯..."; setTimeout(() => el.innerHTML = org, 3000); }

    function copyLink(url, btn) {
        const org = btn.innerHTML; btn.innerHTML = "Ú©Ù¾ÛŒ Ø´Ø¯!";
        navigator.clipboard.writeText(url);
        setTimeout(() => btn.innerHTML = org, 2000);
    }

    function cloneForm(id, btn) {
        if(!confirm("Ú©Ù¾ÛŒ Ø´ÙˆØ¯ØŸ")) return;
        const org = btn.innerHTML; btn.innerHTML = "Ú©Ù¾ÛŒ..."; btn.disabled = true;
        fetch(`${API_URL}?action=getForm&formId=${id}`).then(r => r.json()).then(d => {
            if(d.status==='success') {
                document.getElementById('fields-container').innerHTML = ""; fields = [];
                document.getElementById('formTitle').value = d.structure.title + " (Ø¬Ø¯ÛŒØ¯)";
                document.getElementById('formDesc').value = d.structure.description;
                d.structure.fields.forEach(f => addField(f));
                window.scrollTo({top:0, behavior:'smooth'});
            }
            btn.innerHTML = org; btn.disabled = false;
        });
    }
    
    function deleteForm(id, btn) {
        if(!confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!")) return;
        const org = btn.innerHTML; btn.innerHTML = "Ø­Ø°Ù..."; btn.disabled = true;
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "deleteForm", formId: id }) })
        .then(r => r.json()).then(d => { alert(d.message); loadFormsList(); });
    }

    function viewData(sh, t, btn) {
        const org = btn.innerHTML; btn.innerHTML = "Ø¯Ø±ÛŒØ§ÙØª..."; btn.disabled = true;
        document.getElementById('modalTitle').innerText = t;
        const c = document.getElementById('tableContainer'); c.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...";
        document.getElementById('dataModal').style.display = 'flex';
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getSheetData", sheetName: sh }) })
        .then(r => r.json()).then(d => {
            btn.innerHTML = org; btn.disabled = false;
            if(d.status==='success' && d.data.length) {
                let h = '<table id="printTable">';
                d.data.forEach((r, i) => {
                    h += i===0 ? '<thead><tr>' : '<tr>';
                    r.forEach(c => h += i===0 ? `<th>${c}</th>` : `<td>${c}</td>`);
                    h += i===0 ? '</tr></thead><tbody>' : '</tr>';
                });
                c.innerHTML = h + '</tbody></table>';
            } else c.innerHTML = "<p style='text-align:center; padding:20px;'>Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>";
        }).catch(() => { btn.innerHTML = org; btn.disabled = false; });
    }

    function printData() {
        const content = document.getElementById('tableContainer').innerHTML;
        const win = window.open('', '', 'height=600,width=800');
        win.document.write('<html dir="rtl"><head><title>Ú†Ø§Ù¾</title>');
        win.document.write('<style>body{font-family:Tahoma;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #000;padding:8px;text-align:right;} th{background:#eee;}</style>');
        win.document.write('</head><body>' + content + '</body></html>');
        win.document.close();
        win.print();
    }

    function openChangePassModal() { document.getElementById('passModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function changePassword() {
        const o = document.getElementById('oldPass').value; const n = document.getElementById('newPass').value;
        const btn = document.querySelector('#passModal button');
        const org = btn.innerHTML; btn.innerHTML = "Ø°Ø®ÛŒØ±Ù‡..."; btn.disabled = true;
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "changePassword", username: currentUser, oldPassword: o, newPassword: n }) })
        .then(r => r.json()).then(d => { 
            alert(d.message); btn.innerHTML = org; btn.disabled = false;
            if(d.status==='success') closeModal('passModal'); 
        });
    }
</script>
</body>
</html>
