<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…â€ŒÙ‡Ø§</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --primary: #0f172a; /* Ø³Ø±Ù…Ù‡ Ø§ÛŒ Ø±Ø³Ù…ÛŒ */
            --accent: #2563eb; /* Ø¢Ø¨ÛŒ Ù…Ø¯Ø±Ù† */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #334155;
            --border: #e2e8f0;
            --radius: 0.75rem;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        * { box-sizing: border-box; outline: none; transition: all 0.2s ease; }
        body { font-family: 'Vazirmatn', Tahoma, sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 50px; }

        /* Login */
        #login-panel { display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .login-card { 
            background: var(--card-bg); padding: 40px; width: 100%; max-width: 400px; 
            border-radius: var(--radius); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); 
            text-align: center; display: flex; flex-direction: column; gap: 15px;
        }
        .login-card h2 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.5rem; }

        /* Layout */
        #admin-panel { display: none; }
        header { 
            position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); padding: 15px 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);
        }
        .brand { font-size: 1.25rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; align-items: start; }
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .card h3 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 15px; color: var(--primary); font-size: 1.1rem; }

        /* Inputs */
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: var(--primary); }
        input[type="text"], input[type="password"], select, textarea { 
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); 
            border-radius: 0.5rem; background: #f8fafc; font-family: inherit; font-size: 0.95rem;
        }
        input:focus, textarea:focus { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* Buttons & SVG Icons */
        .btn { 
            padding: 10px 16px; border: none; border-radius: 0.5rem; cursor: pointer; color: white; 
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;
            position: relative; overflow: hidden;
        }
        .btn svg { width: 18px; height: 18px; fill: currentColor; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); color: #fff; }
        .btn-secondary { background: #e2e8f0; color: var(--text-main); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.7; cursor: wait; transform: none; }

        /* Form List */
        .forms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .form-card { 
            background: #fff; border: 1px solid var(--border); border-radius: var(--radius); 
            padding: 15px; transition: transform 0.2s; display: flex; flex-direction: column; justify-content: space-between; gap: 15px;
        }
        .form-card:hover { border-color: var(--accent); box-shadow: var(--shadow); }
        .form-header { display: flex; justify-content: space-between; align-items: start; }
        .form-title { font-weight: 700; font-size: 1rem; color: var(--primary); }
        .form-date { font-size: 0.8rem; color: #64748b; }
        
        .action-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); gap: 5px; margin-top: auto; }
        .btn-icon { padding: 8px; justify-content: center; }

        /* Builder Fields */
        .field-box { background: #f8fafc; border: 1px solid var(--border); border-right: 4px solid var(--accent); padding: 15px; margin-bottom: 10px; border-radius: 0.5rem; }
        .field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .badge { background: #e0e7ff; color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        
        /* Options */
        .opt-container { background: #fff; border: 1px dashed var(--border); padding: 10px; border-radius: 6px; margin-top: 10px; }
        .opt-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .btn-del-opt { background: #fee2e2; color: var(--danger); border: none; padding: 0 10px; border-radius: 4px; cursor: pointer; }

        /* Checkbox */
        .chk-wrap { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; margin-top: 10px; cursor: pointer; }
        .chk-wrap input { width: auto; margin: 0; cursor: pointer; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 25px; border-radius: var(--radius); width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; position: sticky; top: 0; color: var(--primary); }
    </style>
</head>
<body>

<div id="login-panel">
    <div class="login-card">
        <h2 style="color:var(--primary)">Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ù…Ø§Ù†Ù‡</h2>
        <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
        <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button onclick="login()" class="btn btn-primary" style="width:100%; padding: 14px;">
            <svg viewBox="0 0 24 24"><path d="M12 21v-2h7V5h-7V3h7q.825 0 1.413.587Q21 4.175 21 5v14q0 .825-.587 1.413Q19.825 21 19 21Zm-2-4l-1.375-1.45 2.55-2.55H3v-2h8.175l-2.55-2.55L10 7l5 5Z"/></svg>
            ÙˆØ±ÙˆØ¯ Ø§ÛŒÙ…Ù†
        </button>
        <p id="login-msg" style="color:var(--danger); margin:0; font-size:0.9rem;"></p>
    </div>
</div>

<div id="admin-panel">
    <header>
        <div class="brand">
            <svg style="width:24px;height:24px;fill:var(--accent)" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="openChangePassModal()" class="btn btn-secondary">
                <svg viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                ØªØºÛŒÛŒØ± Ø±Ù…Ø²
            </button>
            <button onclick="logout()" class="btn btn-danger">
                <svg viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </header>

    <div class="container dashboard-grid">
        <!-- Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª: ÙØ±Ù… Ø³Ø§Ø² -->
        <div class="card">
            <h3>ğŸ›  Ø³Ø§Ø®Øª ÙØ±Ù… Ø¬Ø¯ÛŒØ¯</h3>
            <label>Ø¹Ù†ÙˆØ§Ù† ÙØ±Ù…</label>
            <input type="text" id="formTitle" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø«Ø¨Øª Ù†Ø§Ù… Ù‡Ù…Ø§ÛŒØ´">
            
            <label>ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ±Ù…</label>
            <textarea id="formDesc" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©ÙˆØªØ§Ù‡..."></textarea>
            
            <label>Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª (Ø³ÙØ§Ø±Ø´ÛŒ)</label>
            <textarea id="successMsg" rows="2" placeholder="Ù…ØªÙ†ÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ø¯ (Ù…Ø«Ù„Ø§Ù‹: Ø«Ø¨Øª Ø´Ø¯ØŒ Ù…Ù†ØªØ¸Ø± ØªÙ…Ø§Ø³ Ø¨Ø§Ø´ÛŒØ¯)"></textarea>

            <div id="fields-container"></div>
            
            <div style="background:#f1f5f9; padding:15px; border-radius:var(--radius); margin-top:20px; border:1px dashed var(--border);">
                <label>Ù†ÙˆØ¹ ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯:</label>
                <div style="display:flex; gap:10px;">
                    <select id="fieldType" style="margin-bottom:0;">
                        <option value="short_text">Ù…ØªÙ† Ú©ÙˆØªØ§Ù‡</option>
                        <option value="long_text">Ù…ØªÙ† Ø¨Ù„Ù†Ø¯</option>
                        <option value="number">ÙÙ‚Ø· Ø¹Ø¯Ø¯</option>
                        <option value="national_code">Ú©Ø¯ Ù…Ù„ÛŒ (10 Ø±Ù‚Ù…)</option>
                        <option value="phone">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (11 Ø±Ù‚Ù…)</option>
                        <option value="single_choice">ØªÚ© Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</option>
                        <option value="multi_choice">Ú†Ù†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</option>
                        <option value="static">Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ</option>
                    </select>
                    <button onclick="addField()" class="btn btn-accent">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </button>
                </div>
            </div>
            <button onclick="saveForm(this)" class="btn btn-success" style="width:100%; margin-top:20px; padding:14px; font-size:1rem;">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ù†ØªØ´Ø§Ø± ÙØ±Ù…
            </button>
        </div>

        <!-- Ø³ØªÙˆÙ† Ú†Ù¾: Ù„ÛŒØ³Øª -->
        <div class="card">
            <h3>ğŸ“‚ Ù„ÛŒØ³Øª ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h3>
            <div id="loading-list" style="text-align:center; padding:20px; color:#64748b;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª...</div>
            <div id="forms-list-items" class="forms-grid"></div>
        </div>
    </div>
</div>

<!-- Modal Ù…Ø´Ø§Ù‡Ø¯Ù‡ -->
<div id="dataModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="modalTitle" style="margin:0;">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="printData()" class="btn btn-primary">
                    <svg viewBox="0 0 24 24"><path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-4h8v2zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/><circle cx="18" cy="11.5" r="1"/></svg>
                    Ú†Ø§Ù¾
                </button>
                <button onclick="closeModal('dataModal')" class="btn btn-secondary">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
        <div id="tableContainer" style="overflow-x:auto;"></div>
    </div>
</div>

<!-- Modal ØªØºÛŒÛŒØ± Ø±Ù…Ø² -->
<div id="passModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <div style="display:flex; justify-content:space-between;">
            <h3>ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h3>
            <button onclick="closeModal('passModal')" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <input type="password" id="oldPass" placeholder="Ø±Ù…Ø² ÙØ¹Ù„ÛŒ">
        <input type="password" id="newPass" placeholder="Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯">
        <button onclick="changePassword(this)" class="btn btn-primary" style="width:100%">Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwwr2DQUQ_aNt_DG4gg0NPiVDB_5ac1VH1i86jnlE1n1owvpProuFqYDuM6bhHUOeU/exec"; 
    const BASE_FORM_URL = "https://amirdadgostar.github.io/site/form/N1.html";

    const FIELD_NAMES = {
        'short_text': 'Ù…ØªÙ† Ú©ÙˆØªØ§Ù‡', 'long_text': 'Ù…ØªÙ† Ø¨Ù„Ù†Ø¯', 'number': 'ÙÙ‚Ø· Ø¹Ø¯Ø¯',
        'national_code': 'Ú©Ø¯ Ù…Ù„ÛŒ', 'phone': 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³', 'single_choice': 'ØªÚ© Ø§Ù†ØªØ®Ø§Ø¨ÛŒ',
        'multi_choice': 'Ú†Ù†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ', 'static': 'Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ'
    };

    let fields = [];
    let currentUser = "";

    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ Ù„Ø§Ú¯ÛŒÙ†
    window.onload = function() {
        const savedUser = localStorage.getItem('adminUser');
        if (savedUser) {
            currentUser = savedUser;
            document.getElementById('login-panel').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadFormsList();
        }
    };

    function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const btn = document.querySelector('#login-panel button');
        const originalText = btn.innerHTML;
        btn.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ..."; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", username: u, password: p }) })
        .then(r => r.json()).then(d => {
            if (d.status === 'success') {
                currentUser = u;
                localStorage.setItem('adminUser', u); // Ø°Ø®ÛŒØ±Ù‡ Ù„Ø§Ú¯ÛŒÙ†
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadFormsList();
            } else {
                document.getElementById('login-msg').innerText = d.message;
                btn.innerHTML = originalText; btn.disabled = false;
            }
        }).catch(() => { btn.innerHTML = originalText; btn.disabled = false; alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„"); });
    }

    function logout() {
        localStorage.removeItem('adminUser');
        location.reload();
    }

    function addField(data = null) {
        const typeRaw = data ? data.type : document.getElementById('fieldType').value;
        const typeLabel = FIELD_NAMES[typeRaw] || typeRaw;
        const id = Date.now() + Math.floor(Math.random() * 1000);
        
        let html = `
        <div class="field-box" id="f-${id}">
            <div class="field-header">
                <span class="badge">${typeLabel}</span>
                <button onclick="removeField(${id})" class="btn btn-danger" style="padding:4px 8px; font-size:0.8rem;">
                    <svg style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </div>
            <input type="text" class="lbl" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙÛŒÙ„Ø¯..." value="${data ? data.label : ''}" style="margin-top:5px; font-weight:700;">`;
        
        if (typeRaw.includes('choice')) {
            html += `<div class="opt-container" id="opt-wrap-${id}">
                     <small style="display:block; margin-bottom:5px;">Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</small>`;
            if (data && data.options) data.options.forEach(o => html += createOpt(o));
            else html += createOpt('');
            html += `<button onclick="addOpt(${id})" class="btn btn-secondary" style="width:100%; margin-top:5px; font-size:0.8rem;">+ Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø²ÛŒÙ†Ù‡</button></div>`;
        }
        
        if (typeRaw === 'static') {
            html += `<textarea class="cnt" placeholder="Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ÛŒ...">${data ? data.content : ''}</textarea>`;
        }

        if (typeRaw !== 'static') {
            const isReq = data && data.required ? 'checked' : '';
            html += `<label class="chk-wrap">
                        <input type="checkbox" class="req-chk" ${isReq}>
                        Ù¾Ø§Ø³Ø® Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø§Ø´Ø¯
                     </label>`;
        }

        html += `</div>`;
        document.getElementById('fields-container').insertAdjacentHTML('beforeend', html);
        fields.push({ id, type: typeRaw });
    }

    function createOpt(val) {
        return `<div class="opt-row">
                <input type="text" class="opt-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú¯Ø²ÛŒÙ†Ù‡" value="${val}" style="margin-bottom:0;">
                <button onclick="this.parentElement.remove()" class="btn-del-opt">Ã—</button>
                </div>`;
    }
    
    function addOpt(id) { document.querySelector(`#opt-wrap-${id} button`).insertAdjacentHTML('beforebegin', createOpt('')); }
    function removeField(id) { document.getElementById(`f-${id}`).remove(); fields = fields.filter(f => f.id !== id); }

    function saveForm(btn) {
        const title = document.getElementById('formTitle').value;
        if (!title || fields.length === 0) return alert("Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙÛŒÙ„Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
        
        let finalFields = [];
        for (let f of fields) {
            const el = document.getElementById(`f-${f.id}`);
            let obj = { 
                type: f.type, 
                label: el.querySelector('.lbl') ? el.querySelector('.lbl').value : "",
                required: el.querySelector('.req-chk') ? el.querySelector('.req-chk').checked : false
            };
            
            if (f.type.includes('choice')) {
                let opts = [];
                el.querySelectorAll('.opt-input').forEach(i => { if(i.value.trim()) opts.push(i.value.trim()); });
                if(opts.length === 0) return alert("Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
                obj.options = opts;
            }
            if (f.type === 'static') obj.content = el.querySelector('.cnt').value;
            finalFields.push(obj);
        }

        const original = btn.innerHTML;
        btn.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡..."; btn.disabled = true;
        
        fetch(API_URL, { 
            method: "POST", 
            body: JSON.stringify({ 
                action: "createForm", 
                data: { 
                    title, 
                    description: document.getElementById('formDesc').value,
                    successMessage: document.getElementById('successMsg').value, // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø³ÙØ§Ø±Ø´ÛŒ
                    fields: finalFields 
                } 
            }) 
        })
        .then(r => r.json()).then(d => {
            if(d.status === 'success') { alert("âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯"); location.reload(); }
            else { alert(d.message); btn.innerHTML = original; btn.disabled = false; }
        }).catch(() => { alert("Ø®Ø·Ø§"); btn.innerHTML = original; btn.disabled = false; });
    }

    function loadFormsList() {
        const listDiv = document.getElementById('forms-list-items');
        listDiv.innerHTML = "";
        fetch(`${API_URL}?action=getFormList`).then(r => r.json()).then(d => {
            document.getElementById('loading-list').style.display = 'none';
            if (d.status === 'success') {
                d.list.forEach(f => {
                    const dlLink = `${API_URL}?action=downloadCSV&formId=${f.id}`;
                    const formLink = `${BASE_FORM_URL}?id=${f.id}`;
                    
                    listDiv.innerHTML += `
                        <div class="form-card">
                            <div class="form-header">
                                <div>
                                    <div class="form-title">${f.title}</div>
                                    <div class="form-date">${new Date(f.date).toLocaleDateString('fa-IR')}</div>
                                </div>
                            </div>
                            <div class="action-bar">
                                <button onclick="copyLink('${formLink}', this)" class="btn btn-secondary btn-icon" title="Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                                <button onclick="cloneForm('${f.id}', this)" class="btn btn-warning btn-icon" title="Ø§Ù„Ú¯ÙˆÚ¯ÛŒØ±ÛŒ"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></button>
                                <button onclick="viewData('${f.sheetName}', '${f.title}', this)" class="btn btn-accent btn-icon" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                                <a href="${dlLink}" class="btn btn-success btn-icon" title="Ø¯Ø§Ù†Ù„ÙˆØ¯" onclick="clickDl(this)"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></a>
                                <button onclick="deleteForm('${f.id}', this)" class="btn btn-danger btn-icon" title="Ø­Ø°Ù"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                            </div>
                        </div>`;
                });
            }
        });
    }

    function clickDl(el) {
        el.style.opacity = "0.5";
        setTimeout(() => el.style.opacity = "1", 2000);
    }

    function copyLink(url, btn) {
        const original = btn.innerHTML;
        btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
        navigator.clipboard.writeText(url);
        setTimeout(() => btn.innerHTML = original, 2000);
    }

    function cloneForm(id, btn) {
        if(!confirm("Ú©Ù¾ÛŒ Ø´ÙˆØ¯ØŸ")) return;
        const original = btn.innerHTML;
        btn.innerHTML = "..."; btn.disabled = true;
        fetch(`${API_URL}?action=getForm&formId=${id}`).then(r => r.json()).then(d => {
            if(d.status==='success') {
                document.getElementById('fields-container').innerHTML = ""; fields = [];
                document.getElementById('formTitle').value = d.structure.title + " (Ú©Ù¾ÛŒ)";
                document.getElementById('formDesc').value = d.structure.description;
                document.getElementById('successMsg').value = d.structure.successMessage || "";
                d.structure.fields.forEach(f => addField(f));
                window.scrollTo({top:0, behavior:'smooth'});
            }
            btn.innerHTML = original; btn.disabled = false;
        });
    }

    function deleteForm(id, btn) {
        if(!confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
        const original = btn.innerHTML;
        btn.innerHTML = "..."; btn.disabled = true;
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "deleteForm", formId: id }) })
        .then(r => r.json()).then(d => { alert(d.message); loadFormsList(); });
    }

    function viewData(sh, t, btn) {
        const original = btn.innerHTML;
        btn.innerHTML = "..."; btn.disabled = true;
        document.getElementById('modalTitle').innerText = t;
        const c = document.getElementById('tableContainer'); c.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...";
        document.getElementById('dataModal').style.display = 'flex';
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getSheetData", sheetName: sh }) })
        .then(r => r.json()).then(d => {
            btn.innerHTML = original; btn.disabled = false;
            if(d.status==='success' && d.data.length) {
                let h = '<table id="printTable">';
                d.data.forEach((r, i) => {
                    h += i===0 ? '<thead><tr>' : '<tr>';
                    r.forEach(c => h += i===0 ? `<th>${c}</th>` : `<td>${c}</td>`);
                    h += i===0 ? '</tr></thead><tbody>' : '</tr>';
                });
                c.innerHTML = h + '</tbody></table>';
            } else c.innerHTML = "<p>Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª</p>";
        });
    }

    function printData() {
        const content = document.getElementById('tableContainer').innerHTML;
        const win = window.open('', '', 'height=600,width=800');
        win.document.write('<html dir="rtl"><head><title>Ú†Ø§Ù¾</title><style>body{font-family:Tahoma} table{width:100%;border-collapse:collapse} th,td{border:1px solid #000;padding:5px}</style></head><body>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }

    function openChangePassModal() { document.getElementById('passModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function changePassword(btn) {
        const o = document.getElementById('oldPass').value; const n = document.getElementById('newPass').value;
        const original = btn.innerHTML; btn.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡..."; btn.disabled = true;
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "changePassword", username: currentUser, oldPassword: o, newPassword: n }) })
        .then(r => r.json()).then(d => { 
            alert(d.message); btn.innerHTML = original; btn.disabled = false;
            if(d.status==='success') closeModal('passModal'); 
        });
    }
</script>
</body>
</html>
